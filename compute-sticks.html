<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>    ArchLinux on intel compute stick
</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
            <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/normalize.css">
        <link href='https://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/font-awesome.min.css">
        <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/main.css">
	<link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/tipuesearch/tipuesearch.css">

    <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/blog.css">
    <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/github.css">
        <link href="https://visibilityspots.github.io/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="visibilityspots Atom Feed" />
        <link href="https://visibilityspots.github.io/blog/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="visibilityspots RSS Feed" />
        <script src="https://visibilityspots.github.io/blog/theme/js/vendor/modernizr-2.6.2.min.js"></script>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

        <div id="wrapper">
<header id="sidebar" class="side-shadow">
    <hgroup id="site-header">
    <a id="site-title" href="https://visibilityspots.github.io/blog"><h1>visibilityspots <i class="icon-dashboard"></i></h1></a>
        <p id="site-desc"> Linux & Open-Source enthusiast | Scouting | Longboarding </p>
    </hgroup>
    <form id="searchform" action="https://visibilityspots.github.io/blog/search.html" onsubmit="return (this.elements['q'].value.length > 0)">
	        <input id="searchbox" type="text" name="q" size="12" placeholder="search">
    </form>
    <nav>
        <ul id="nav-links">
                <li><a href="https://visibilityspots.github.io/blog/">Blog</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/profile.html">Profile</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/links.html">Links</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/projects.html">Projects</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/tools.html">Tools</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/contact.html">Contact</a></li>
        </ul>
    </nav>
    Categories:
      <ul>
	<li><a href="https://visibilityspots.github.io/blog/category/android.html">android</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/apple.html">apple</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/automation.html">automation</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/cloud.html">cloud</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/conferences.html">conferences</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/containers.html">containers</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/home-automation.html">home-automation</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/linux.html">linux</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/networking.html">networking</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/other.html">other</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/php.html">php</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/puppet.html">puppet</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/security.html">security</a></li>
      </ul>
<footer id="site-info">
  <a href="http://creativecommons.org/licenses/by-nc/2.0/be/deed.nl">License</a> | 2009 - 2021 <a href="https://visibilityspots.github.io/blog">visibilityspots.github.io/blog</a> | Generated by <a href="http://getpelican.com/" target="pelican">Pelican</a> | Hosted at <a href="https://pages.github.com/" target="github pages">github pages</a> | <a href="https://visibilityspots.github.io/blog/feeds/all.atom.xml" rel="alternate">Atom</a> feed
</footer></header>
    <div id="post-container">
        <ol id="post-list">
            <li>
                <article class="post-entry">
                    <header class="entry-header">
                        <a href="https://visibilityspots.github.io/blog/compute-sticks.html" rel="bookmark"><h1>ArchLinux on intel compute stick</h1></a>
<div><p>takes 1 minute to read</p></div>                        <time class="post-time" datetime="2019-06-24T19:00:00+02:00" pubdate>
                            last modified at Wed 28 August 2019
                        </time>
                    </header>
                    <section class="post-content">
                        <p>A few months ago we moved into a brand new office which was furnished with a dozen of samsung displays. Unfortunately the basic player included in those displays isn't capable to add a webpage/url as content. Since we've setted up a <a href="https://smashing.github.io/">smashing</a> instance to create dashboards for each team this was a huge bummer.</p>
<p>While looking for a stable solution many teams brought their own raspberry pi's, chromecasts, airtame devices to at least be able to show something on the displays in the meanwhile.</p>
<p>Since we already had good experiences with an intel compute stick and an intel NUC we decided to get and configure about 8 compute sticks model STK1A32SC with archlinux running to be able to display our dashboards.</p>
<p>For our stand up corners we went for 3 intel NUC's with some peripherals like a web-cam/keyboard and a jabra device to provide proper communication during the stand-ups.</p>
<p>But back to the compute sticks.</p>
<h1>Initial setup</h1>
<p>since we had to install and configure about 8 sticks we decided to configure a base archlinux setup on one stick and using <a href="https://wiki.archlinux.org/index.php/Dd">dd</a> afterwards to get the others up and running with a basic archlinux stack.</p>
<h2>BIOS</h2>
<p>before we could boot a live usb archlinux distro we had to change the operating system setting in the bios to Android</p>
<div class="highlight"><pre><span></span><code><span class="err">boot device</span>
<span class="err">press F2</span>
<span class="err">-&gt; Select Operating System</span>
<span class="err">-&gt; Android</span>
</code></pre></div>

<p>once that's done and you've rebooted press F10 to boot from the live USB distro</p>
<h2>basic setup following guide</h2>
<p>use wifi-menu command to connect to your wireless network to get some network connectivity first</p>
<p>following the basic <a href="https://wiki.archlinux.org/index.php/Installation_Guide">installation guide</a> we went for an UEFI setup with a <a href="https://wiki.archlinux.org/index.php/EFI_system_partition#GPT_partitioned_disks">GPT partitioned</a> disk.</p>
<p>and opted for this layout where 20G is reserved for the root partition, 7.6G as var and 1G for swap.</p>
<h4>partition layout</h4>
<div class="highlight"><pre><span></span><code><span class="err">Device            Start      End  Sectors  Size Type</span>
<span class="err">/dev/mmcblk0p1     2048  1050623  1048576  512M EFI System</span>
<span class="err">/dev/mmcblk0p2  1050624  3147775  2097152    1G Linux swap</span>
<span class="err">/dev/mmcblk0p3  3147776 45090815 41943040   20G Linux filesystem</span>
<span class="err">/dev/mmcblk0p4 45090816 61071326 15980511  7.6G Linux filesystem</span>
</code></pre></div>

<p>We configured <a href="https://wiki.archlinux.org/index.php/GRUB#Generate_the_main_configuration_file">grub</a> assuming the EFI partition being mounted as boot and chrooted using arch-chroot as being explained in the installation guide.</p>
<div class="highlight"><pre><span></span><code><span class="err"># grub-install --target=x86_64-efi --efi-directory=boot --bootloader-id=GRUB</span>
</code></pre></div>

<h4>tools</h4>
<p>some tools we preinstalled where the SSH daemon along with an authorized key for a specific user and python to be able to run ansible afterwards.</p>
<p>also we configured the wireless network already using <a href="https://wiki.archlinux.org/index.php/Systemd-networkd">systemd-network</a></p>
<p>This besides the preferred stuff which is described in the installation guide.</p>
<p>when everything is installed through the installation guide using arch-chroot you can go ahead and reboot</p>
<h2>reboot</h2>
<p>when you have rebooted you should now enter the Grub to the installed archlinux distribution based on the disk of the compute stick. Once that's working fine you can go ahead.</p>
<h1>create an image with dd on separate stick</h1>
<p>as soon as you got a working compute stick you can reboot and now use the live usb distro again</p>
<div class="highlight"><pre><span></span><code><span class="err"># wifi-menu</span>
<span class="err"># systemctl start sshd.service</span>
<span class="err"># passwd</span>
</code></pre></div>

<p>now try to ssh into the live distro from another machine so you could unplug the keyboard and use that second USB port to connect an empty USB drive to store the image on.</p>
<p><img alt="copy" src="../../images/compute-sticks/copy.jpeg"></p>
<div class="highlight"><pre><span></span><code><span class="err"># lsblk</span>
<span class="err">NAME         MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT</span>
<span class="err">loop0          7:0    0 500.8M  1 loop /run/archiso/sfs/airootfs</span>
<span class="err">sda            8:0    1  14.5G  0 disk</span>
<span class="err">├─sda1         8:1    1   614M  0 part /run/archiso/bootmnt</span>
<span class="err">└─sda2         8:2    1    64M  0 part</span>
<span class="err">sdb            8:16   1  28.9G  0 disk</span>
<span class="err">└─sdb1         8:17   1  28.9G  0 part</span>
<span class="err">mmcblk0      179:0    0  29.1G  0 disk</span>
<span class="err">mmcblk0boot0 179:8    0     4M  1 disk</span>
<span class="err">mmcblk0boot1 179:16   0     4M  1 disk</span>
</code></pre></div>

<p>mount the additional USB drive and start creating an image through a screen session</p>
<div class="highlight"><pre><span></span><code><span class="err"># mount /dev/sdb1 /mnt</span>
<span class="err"># screen -S image-creation</span>
<span class="err"># dd if=/dev/mmcblk0 conv=sync,noerror bs=64K status=progress | gzip -c &gt; /mnt/base-image-dashboards.img.gz</span>
</code></pre></div>

<h1>restore image</h1>
<p>to restore the image on a new compute stick you have to boot again in live distro mode and enable wifi + ssh to be able to unplug the keyboard USB port once again</p>
<div class="highlight"><pre><span></span><code><span class="err"># wifi-menu</span>
<span class="err"># systemctl start sshd.service</span>
<span class="err"># passwd</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="err"># lsblk</span>
<span class="err">NAME         MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT</span>
<span class="err">loop0          7:0    0 500.8M  1 loop /run/archiso/sfs/airootfs</span>
<span class="err">sda            8:0    1  14.5G  0 disk</span>
<span class="err">├─sda1         8:1    1   614M  0 part /run/archiso/bootmnt</span>
<span class="err">└─sda2         8:2    1    64M  0 part</span>
<span class="err">sdb            8:16   1  28.9G  0 disk</span>
<span class="err">└─sdb1         8:17   1  28.9G  0 part</span>
<span class="err">mmcblk0      179:0    0  29.1G  0 disk</span>
<span class="err">mmcblk0boot0 179:8    0     4M  1 disk</span>
<span class="err">mmcblk0boot1 179:16   0     4M  1 disk</span>
</code></pre></div>

<p>next mount the USB drive with the base image on</p>
<div class="highlight"><pre><span></span><code><span class="err"># mount /dev/sdb1 /mnt</span>
<span class="err"># ls /mnt</span>
<span class="err">base-image-dashboards.img.gz  lost+found</span>
</code></pre></div>

<p>then start a screen session to unpack the image to the disk of the compute stick</p>
<div class="highlight"><pre><span></span><code><span class="err"># screen -S restore</span>
<span class="err"># gunzip -c /mnt/base-image-dashboards.img.gz | dd of=/dev/mmcblk0 status=progress</span>
<span class="err"># umount -R /mnt</span>
</code></pre></div>

<p>and last but not least initiate grub to install the UEFI partition</p>
<div class="highlight"><pre><span></span><code><span class="o">#</span> <span class="n">mount</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mmcblk0p3</span> <span class="o">/</span><span class="n">mnt</span>                                                                                                                                                                                                                                 <span class="p">:(</span>
<span class="o">#</span> <span class="n">mount</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mmcblk0p1</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">boot</span>
<span class="o">#</span> <span class="n">mount</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mmcblk0p4</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">var</span>

<span class="o">#</span> <span class="n">arch</span><span class="o">-</span><span class="n">chroot</span> <span class="o">/</span><span class="n">mnt</span>

<span class="o">#</span> <span class="n">grub</span><span class="o">-</span><span class="n">install</span> <span class="c1">--target=x86_64-efi --efi-directory=boot --bootloader-id=GRUB</span>
<span class="n">Installing</span> <span class="k">for</span> <span class="n">x86_64</span><span class="o">-</span><span class="n">efi</span> <span class="n">platform</span><span class="p">.</span>
<span class="n">Installation</span> <span class="n">finished</span><span class="p">.</span> <span class="k">No</span> <span class="n">error</span> <span class="n">reported</span><span class="p">.</span>

<span class="o">#</span> <span class="n">exit</span>

<span class="o">#</span> <span class="n">umount</span> <span class="o">-</span><span class="n">R</span> <span class="o">/</span><span class="n">mnt</span>
<span class="o">#</span> <span class="n">reboot</span>
</code></pre></div>

<p>the compute stick should now boot into the new ArchLinux distribution installed on it's disk and can be configured using ansible.</p>
<h1>kiosk mode</h1>
<p>the main goal of our use case was to show an url. First idea was to use <a href="https://luakit.github.io/">luakit</a> as a browser. But luakit isn't available in the official repositories and isn't able to rotate different tabs.</p>
<p>So we went for chromium which is started <a href="https://wiki.archlinux.org/index.php/Xinit#Starting_applications_without_a_window_manager">without a window-manager</a> and <a href="https://wiki.archlinux.org/index.php/Nodm">nodm</a> to automatically start an x session at boot.</p>
<p>Some quirks we had to resolve where the disabling of the auto restore of chromium by altering the Default/Preference file and setting the values of exit_type to none and exited_cleanly to true after which we made the file read only by making it immutable with the chattr command.</p>
<p><img alt="stack" src="../../images/compute-sticks/stack.jpeg"></p>
                    </section>
                    <hr/>
                    <aside class="post-meta">
                        <p>Category: <a href="https://visibilityspots.github.io/blog/category/linux.html">linux</a></p>
                        <p>Tags: <a href="https://visibilityspots.github.io/blog/tag/archlinux.html">ArchLinux</a>, <a href="https://visibilityspots.github.io/blog/tag/archlinux.html">archlinux</a>, <a href="https://visibilityspots.github.io/blog/tag/arch.html">arch</a>, <a href="https://visibilityspots.github.io/blog/tag/linux.html">linux</a>, <a href="https://visibilityspots.github.io/blog/tag/intel.html">intel</a>, <a href="https://visibilityspots.github.io/blog/tag/compute.html">compute</a>, <a href="https://visibilityspots.github.io/blog/tag/stick.html">stick</a>, <a href="https://visibilityspots.github.io/blog/tag/sticks.html">sticks</a>, <a href="https://visibilityspots.github.io/blog/tag/stk1a32sc.html">STK1A32SC</a>, </p>
                    </aside>
                    <hr/>
<div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'visibilityspots';
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
                </article>
            </li>
        </ol>
    </div>
        </div>

        <script src="https://visibilityspots.github.io/blog/theme/js/main.js"></script>
    </body>
</html>