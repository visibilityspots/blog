<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>    dockerized DNS over HTTPS using pi-hole through cloudflared proxy-dns
</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
            <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/normalize.css">
        <link href='https://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/font-awesome.min.css">
        <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/main.css">
        <link rel="stylesheet" media="screen and (prefers-color-scheme: dark)" href="https://files.stork-search.net/dark.css">

    <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/blog.css">
    <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/github.css">
        <link href="https://visibilityspots.github.io/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="visibilityspots Atom Feed" />
        <link href="https://visibilityspots.github.io/blog/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="visibilityspots RSS Feed" />
        <script src="https://visibilityspots.github.io/blog/theme/js/vendor/modernizr-2.6.2.min.js"></script>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

        <div id="wrapper">
<header id="sidebar" class="side-shadow">
    <hgroup id="site-header">
    <a id="site-title" href="https://visibilityspots.github.io/blog"><h1>visibilityspots <i class="icon-dashboard"></i></h1></a>
        <p id="site-desc"> Linux & Open-Source enthusiast | Scouting | Longboarding </p>
    </hgroup>
    <input data-stork="sitesearch" id="searchbox" type="text" size="12" placeholder="search">
    <div data-stork="sitesearch-output"></div>

    <nav>
        <ul id="nav-links">
                <li><a href="https://visibilityspots.github.io/blog/">Blog</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/profile.html">Profile</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/projects.html">Projects</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/tools.html">Tools</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/contact.html">Contact</a></li>
        </ul>
    </nav>
    Categories:
      <ul>
        <li><a href="https://visibilityspots.github.io/blog/category/android.html">android</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/apple.html">apple</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/automation.html">automation</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/cloud.html">cloud</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/conferences.html">conferences</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/containers.html">containers</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/home-automation.html">home-automation</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/linux.html">linux</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/networking.html">networking</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/other.html">other</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/php.html">php</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/puppet.html">puppet</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/security.html">security</a></li>
      </ul>
<footer id="site-info">
  <a href="http://creativecommons.org/licenses/by-nc/2.0/be/deed.nl">License</a> | 2009 - 2025 <a href="https://visibilityspots.github.io/blog">visibilityspots.github.io/blog</a> | Generated by <a href="http://getpelican.com/" target="pelican">Pelican</a> | Hosted at <a href="https://pages.github.com/" target="github pages">github pages</a> | <a href="https://visibilityspots.github.io/blog/feeds/all.atom.xml" rel="alternate">Atom</a> feed
</footer></header>
    <div id="post-container">
        <ol id="post-list">
            <li>
                <article class="post-entry">
                    <header class="entry-header">
                        <a href="https://visibilityspots.github.io/blog/dockerized-cloudflared-pi-hole.html" rel="bookmark"><h1>dockerized DNS over HTTPS using pi-hole through cloudflared proxy-dns</h1></a>
<div><p>takes 3 minutes to read</p></div>                        <time class="post-time" datetime="2018-04-21T21:00:00+02:00" pubdate>
                            last modified at Mon 18 February 2019
                        </time>
                    </header>
                    <section class="post-content">
                        <p>a few months ago I configured a thin client as my home server to replace the previous <a href="../raspberry-pi.html">raspberry pi</a> setup.</p>
<p>During that migration I moved over all native services within docker containers. One of those services being a <a href="https://pi-hole.net">pi-hole</a> setup to block ad serving domains on dns level and to have a dns cache within our LAN to gain a bit of speed.</p>
<p>It has been running ever since without any issue and worked pretty well.</p>
<p>When cloudflare <a href="https://blog.cloudflare.com/announcing-1111/">announced</a> their fast and privacy based DNS resolver I got a bit intrigued by their DNS over HTTPS feature. Especially since our ISP telenet is using our <a href="http://www.forceflow.be/2016/09/14/aanpassingen-privacybeleid-telenet/">web history</a> for their advertisements too.</p>
<p>So I stumbled on some articles from <a href="https://oliverhough.cloud/blog/configure-pihole-with-dns-over-https/">Oliver Hough</a> and <a href="https://scotthelme.co.uk/securing-dns-across-all-of-my-devices-with-pihole-dns-over-https-1-1-1-1/">Scott Helme</a> that describe how you can combine a <a href="https://developers.cloudflare.com/1.1.1.1/dns-over-https/cloudflared-proxy/">cloudflared proxy-dns</a> with pi-hole to get your dns requests encrypted through HTTPS and still be able to filter out the advertisements.</p>
<p>Since I got everything in docker I configured a <a href="https://hub.docker.com/r/visibilityspots/cloudflared/">cloudflared</a> container automated through <a href="https://travis-ci.org/visibilityspots/dockerfile-cloudflared">travis</a> with <a href="https://github.com/aelsabbahy/goss/tree/master/extras/dgoss">dgoss</a> tests.</p>
<p>I got some inspiration from <a href="https://twitter.com/MaartjeME">maartje</a> who used a <a href="https://github.com/meyskens/docker-cloudflared/blob/master/.travis.yml">matrix</a> to build multiple docker images for different architectures using travis. The main reason behind this was that after I got this setup up and running using this docker-compose file on my x86_64 machine I wanted to run it on a raspberry pi zero w.</p>
<p>For the pihole container I figured out you can easily pass by the custom DNS servers through docker environment variables so no need anymore for a custom pihole docker container to maintain!</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>cat<span class="w"> </span>docker-compose.yml
version:<span class="w"> </span><span class="s2">&quot;3&quot;</span>

services:
<span class="w">  </span>cloudflared:
<span class="w">    </span>container_name:<span class="w"> </span>cloudflared
<span class="w">    </span>image:<span class="w"> </span>visibilityspots/cloudflared:amd64
<span class="w">    </span>restart:<span class="w"> </span>unless-stopped
<span class="w">    </span>networks:
<span class="w">      </span>pihole_net:
<span class="w">        </span>ipv4_address:<span class="w"> </span><span class="m">10</span>.0.0.2

<span class="w">  </span>pi-hole:
<span class="w">    </span>container_name:<span class="w"> </span>pi-hole
<span class="w">    </span>image:<span class="w"> </span>pihole/pihole:v4.2.1_amd64
<span class="w">    </span>restart:<span class="w"> </span>unless-stopped
<span class="w">    </span>ports:
<span class="w">      </span>-<span class="w"> </span><span class="s2">&quot;80:80/tcp&quot;</span>
<span class="w">      </span>-<span class="w"> </span><span class="s2">&quot;53:53/tcp&quot;</span>
<span class="w">      </span>-<span class="w"> </span><span class="s2">&quot;53:53/udp&quot;</span>
<span class="w">    </span>environment:
<span class="w">      </span>-<span class="w"> </span><span class="nv">ServerIP</span><span class="o">=</span><span class="m">10</span>.0.0.3
<span class="w">      </span>-<span class="w"> </span><span class="nv">DNS1</span><span class="o">=</span><span class="s1">&#39;10.0.0.2#5054&#39;</span>
<span class="w">      </span>-<span class="w"> </span><span class="nv">DNS2</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
<span class="w">      </span>-<span class="w"> </span><span class="nv">IPv6</span><span class="o">=</span><span class="nb">false</span>
<span class="w">      </span>-<span class="w"> </span><span class="nv">TZ</span><span class="o">=</span>CEST-2
<span class="w">      </span>-<span class="w"> </span><span class="nv">DNSMASQ_LISTENING</span><span class="o">=</span>all
<span class="w">      </span>-<span class="w"> </span><span class="nv">WEBPASSWORD</span><span class="o">=</span>admin
<span class="w">    </span>networks:
<span class="w">      </span>pihole_net:
<span class="w">        </span>ipv4_address:<span class="w"> </span><span class="m">10</span>.0.0.3
<span class="w">    </span>dns:
<span class="w">      </span>-<span class="w"> </span><span class="m">127</span>.0.0.1
<span class="w">      </span>-<span class="w"> </span><span class="m">1</span>.1.1.1
<span class="w">    </span>cap_add<span class="s2">&quot;</span>
<span class="s2">      - NET_ADMIN</span>

<span class="s2">networks:</span>
<span class="s2">  pihole_net:</span>
<span class="s2">    driver: bridge</span>
<span class="s2">    ipam:</span>
<span class="s2">     config:</span>
<span class="s2">       - subnet: 10.0.0.0/29</span>
</code></pre></div>

<p>I remembered this <a href="https://learn.adafruit.com/pi-hole-ad-blocker-with-pi-zero-w">project</a> where a raspberry pi zero W was used together with a tiny display. In the meanwhile I have the DoH cloudflared/pi-hole combination running on such a tiny device using <a href="https://archlinuxarm.org">ArchLinux ARM</a> and ordered the display :D</p>
<p>You can use the same dockerfile on a raspberry pi zero but with other tags for the container images:</p>
<div class="highlight"><pre><span></span><code><span class="n">image</span><span class="o">:</span><span class="w"> </span><span class="n">visibilityspots</span><span class="o">/</span><span class="n">cloudflared</span><span class="o">:</span><span class="n">arm</span>
<span class="n">image</span><span class="o">:</span><span class="w"> </span><span class="n">pihole</span><span class="o">/</span><span class="n">pihole</span><span class="o">:</span><span class="n">v4</span><span class="o">.</span><span class="mi">0</span><span class="n">_armhf</span>
</code></pre></div>

<p>As you can see unfortunately I had to configure static ip's since the dnsmasq config needs the ip address of the cloudflared service. If someone has a better solution to implement it let me know!</p>
<p>I also opted to not store the data. Meaning that when the docker containers are restarted the data is gone.</p>
<p>So when you now bring up those 2 containers:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>docker-compose<span class="w"> </span>up<span class="w"> </span>-d
Creating<span class="w"> </span>network<span class="w"> </span><span class="s2">&quot;###_pihole_net&quot;</span><span class="w"> </span>with<span class="w"> </span>driver<span class="w"> </span><span class="s2">&quot;bridge&quot;</span>
Creating<span class="w"> </span>pi-hole<span class="w"> </span>...
Creating<span class="w"> </span>cloudflared<span class="w"> </span>...
Creating<span class="w"> </span>pi-hole
Creating<span class="w"> </span>cloudflared<span class="w"> </span>...<span class="w"> </span><span class="k">done</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>$<span class="w"> </span>docker-compose<span class="w"> </span>logs<span class="w"> </span>cloudflared
Attaching<span class="w"> </span>to<span class="w"> </span>cloudflared
cloudflared<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="s2">&quot;2018-04-16T20:01:14Z&quot;</span><span class="w"> </span><span class="nv">level</span><span class="o">=</span>info<span class="w"> </span><span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Adding DNS upstream&quot;</span><span class="w"> </span><span class="nv">url</span><span class="o">=</span><span class="s2">&quot;https://1.1.1.1/.well-known/dns-query&quot;</span>
cloudflared<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="s2">&quot;2018-04-16T20:01:14Z&quot;</span><span class="w"> </span><span class="nv">level</span><span class="o">=</span>info<span class="w"> </span><span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Adding DNS upstream&quot;</span><span class="w"> </span><span class="nv">url</span><span class="o">=</span><span class="s2">&quot;https://1.0.0.1/.well-known/dns-query&quot;</span>
cloudflared<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="s2">&quot;2018-04-16T20:01:14Z&quot;</span><span class="w"> </span><span class="nv">level</span><span class="o">=</span>info<span class="w"> </span><span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Starting DNS over HTTPS proxy server&quot;</span><span class="w"> </span><span class="nv">addr</span><span class="o">=</span><span class="s2">&quot;dns://0.0.0.0:5054&quot;</span>
cloudflared<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="s2">&quot;2018-04-16T20:01:14Z&quot;</span><span class="w"> </span><span class="nv">level</span><span class="o">=</span>info<span class="w"> </span><span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Starting metrics server&quot;</span><span class="w"> </span><span class="nv">addr</span><span class="o">=</span><span class="s2">&quot;127.0.0.1:35973&quot;</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="err">$</span><span class="w"> </span><span class="n">docker</span><span class="o">-</span><span class="n">compose</span><span class="w"> </span><span class="n">logs</span><span class="w"> </span><span class="nf">pi</span><span class="o">-</span><span class="n">hole</span>
<span class="n">Attaching</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="nf">pi</span><span class="o">-</span><span class="n">hole</span>
<span class="p">...</span>
<span class="nf">pi</span><span class="o">-</span><span class="n">hole</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="o">[</span><span class="n">services.d</span><span class="o">]</span><span class="w"> </span><span class="n">starting</span><span class="w"> </span><span class="n">services</span>
<span class="nf">pi</span><span class="o">-</span><span class="n">hole</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Starting</span><span class="w"> </span><span class="n">lighttpd</span>
<span class="nf">pi</span><span class="o">-</span><span class="n">hole</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Starting</span><span class="w"> </span><span class="n">dnsmasq</span>
<span class="nf">pi</span><span class="o">-</span><span class="n">hole</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Starting</span><span class="w"> </span><span class="n">crond</span>
<span class="nf">pi</span><span class="o">-</span><span class="n">hole</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Starting</span><span class="w"> </span><span class="n">pihole</span><span class="o">-</span><span class="n">FTL</span><span class="w"> </span><span class="p">(</span><span class="k">no</span><span class="o">-</span><span class="n">daemon</span><span class="p">)</span>
<span class="nf">pi</span><span class="o">-</span><span class="n">hole</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="o">[</span><span class="n">services.d</span><span class="o">]</span><span class="w"> </span><span class="n">done</span><span class="p">.</span>
<span class="nf">pi</span><span class="o">-</span><span class="n">hole</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nl">dnsmasq</span><span class="p">:</span><span class="w"> </span><span class="n">started</span><span class="p">,</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="mf">2.76</span><span class="w"> </span><span class="n">cachesize</span><span class="w"> </span><span class="mi">10000</span>
<span class="nf">pi</span><span class="o">-</span><span class="n">hole</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nl">dnsmasq</span><span class="p">:</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="nc">time</span><span class="w"> </span><span class="nl">options</span><span class="p">:</span><span class="w"> </span><span class="n">IPv6</span><span class="w"> </span><span class="n">GNU</span><span class="o">-</span><span class="n">getopt</span><span class="w"> </span><span class="n">DBus</span><span class="w"> </span><span class="n">i18n</span><span class="w"> </span><span class="n">IDN</span><span class="w"> </span><span class="n">DHCP</span><span class="w"> </span><span class="n">DHCPv6</span><span class="w"> </span><span class="k">no</span><span class="o">-</span><span class="n">Lua</span><span class="w"> </span><span class="n">TFTP</span><span class="w"> </span><span class="n">conntrack</span><span class="w"> </span><span class="n">ipset</span><span class="w"> </span><span class="n">auth</span><span class="w"> </span><span class="n">DNSSEC</span><span class="w"> </span><span class="n">loop</span><span class="o">-</span><span class="n">detect</span><span class="w"> </span><span class="n">inotify</span>
<span class="nf">pi</span><span class="o">-</span><span class="n">hole</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nl">dnsmasq</span><span class="p">:</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">nameserver</span><span class="w"> </span><span class="mf">10.0.0.2</span><span class="n">#5054</span>
<span class="nf">pi</span><span class="o">-</span><span class="n">hole</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nl">dnsmasq</span><span class="p">:</span><span class="w"> </span><span class="k">read</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hosts</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="n">addresses</span>
<span class="nf">pi</span><span class="o">-</span><span class="n">hole</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nl">dnsmasq</span><span class="p">:</span><span class="w"> </span><span class="k">read</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">pihole</span><span class="o">/</span><span class="k">local</span><span class="p">.</span><span class="n">list</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">addresses</span>
<span class="nf">pi</span><span class="o">-</span><span class="n">hole</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nl">dnsmasq</span><span class="p">:</span><span class="w"> </span><span class="n">failed</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="k">names</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">pihole</span><span class="o">/</span><span class="n">black</span><span class="p">.</span><span class="nl">list</span><span class="p">:</span><span class="w"> </span><span class="k">No</span><span class="w"> </span><span class="n">such</span><span class="w"> </span><span class="k">file</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">directory</span>
<span class="nf">pi</span><span class="o">-</span><span class="n">hole</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nl">dnsmasq</span><span class="p">:</span><span class="w"> </span><span class="k">read</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">pihole</span><span class="o">/</span><span class="n">gravity</span><span class="p">.</span><span class="n">list</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">121065</span><span class="w"> </span><span class="n">addresses</span>
<span class="nf">pi</span><span class="o">-</span><span class="n">hole</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nl">dnsmasq</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mf">127.0.0.1</span><span class="o">/</span><span class="mi">48521</span><span class="w"> </span><span class="n">query</span><span class="o">[</span><span class="n">A</span><span class="o">]</span><span class="w"> </span><span class="nf">pi</span><span class="p">.</span><span class="n">hole</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="mf">127.0.0.1</span>
<span class="nf">pi</span><span class="o">-</span><span class="n">hole</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nl">dnsmasq</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mf">127.0.0.1</span><span class="o">/</span><span class="mi">48521</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">pihole</span><span class="o">/</span><span class="k">local</span><span class="p">.</span><span class="n">list</span><span class="w"> </span><span class="nf">pi</span><span class="p">.</span><span class="n">hole</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="mf">10.0.0.3</span>
</code></pre></div>

<p>you should be able to query the containerized pi-hole DNS service from it's host or from within your netwerk using dig:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>dig<span class="w"> </span>@localhost<span class="w"> </span>-p<span class="w"> </span><span class="m">53</span><span class="w"> </span>visibilityspots.org
<span class="o">(</span>$<span class="w"> </span>dig<span class="w"> </span>@IP-ADDRESS-OF-DOCKER-NODE<span class="w"> </span>-p<span class="w"> </span><span class="m">53</span><span class="w"> </span>visibilityspots.org<span class="o">)</span>

<span class="p">;</span><span class="w"> </span>&lt;&lt;&gt;&gt;<span class="w"> </span>DiG<span class="w"> </span><span class="m">9</span>.12.1<span class="w"> </span>&lt;&lt;&gt;&gt;<span class="w"> </span>@localhost<span class="w"> </span>-p<span class="w"> </span><span class="m">53</span><span class="w"> </span>visibilityspots.org
<span class="p">;</span><span class="w"> </span><span class="o">(</span><span class="m">2</span><span class="w"> </span>servers<span class="w"> </span>found<span class="o">)</span>
<span class="p">;;</span><span class="w"> </span>global<span class="w"> </span>options:<span class="w"> </span>+cmd
<span class="p">;;</span><span class="w"> </span>Got<span class="w"> </span>answer:
<span class="p">;;</span><span class="w"> </span>-&gt;&gt;HEADER<span class="s">&lt;&lt;- opco</span>de:<span class="w"> </span>QUERY,<span class="w"> </span>status:<span class="w"> </span>NOERROR,<span class="w"> </span>id:<span class="w"> </span><span class="m">51155</span>
<span class="p">;;</span><span class="w"> </span>flags:<span class="w"> </span>qr<span class="w"> </span>rd<span class="w"> </span>ra<span class="p">;</span><span class="w"> </span>QUERY:<span class="w"> </span><span class="m">1</span>,<span class="w"> </span>ANSWER:<span class="w"> </span><span class="m">8</span>,<span class="w"> </span>AUTHORITY:<span class="w"> </span><span class="m">0</span>,<span class="w"> </span>ADDITIONAL:<span class="w"> </span><span class="m">1</span>

<span class="p">;;</span><span class="w"> </span>OPT<span class="w"> </span>PSEUDOSECTION:
<span class="p">;</span><span class="w"> </span>EDNS:<span class="w"> </span>version:<span class="w"> </span><span class="m">0</span>,<span class="w"> </span>flags:<span class="p">;</span><span class="w"> </span>udp:<span class="w"> </span><span class="m">1536</span>
<span class="p">;;</span><span class="w"> </span>QUESTION<span class="w"> </span>SECTION:
<span class="p">;</span>visibilityspots.org.<span class="w">       </span>IN<span class="w">  </span>A

<span class="p">;;</span><span class="w"> </span>ANSWER<span class="w"> </span>SECTION:
visibilityspots.org.<span class="w">    </span><span class="m">37</span><span class="w">  </span>IN<span class="w">  </span>A<span class="w">   </span><span class="m">54</span>.230.9.72
visibilityspots.org.<span class="w">    </span><span class="m">37</span><span class="w">  </span>IN<span class="w">  </span>A<span class="w">   </span><span class="m">54</span>.230.9.109
visibilityspots.org.<span class="w">    </span><span class="m">37</span><span class="w">  </span>IN<span class="w">  </span>A<span class="w">   </span><span class="m">54</span>.230.9.119
visibilityspots.org.<span class="w">    </span><span class="m">37</span><span class="w">  </span>IN<span class="w">  </span>A<span class="w">   </span><span class="m">54</span>.230.9.143
visibilityspots.org.<span class="w">    </span><span class="m">37</span><span class="w">  </span>IN<span class="w">  </span>A<span class="w">   </span><span class="m">54</span>.230.9.148
visibilityspots.org.<span class="w">    </span><span class="m">37</span><span class="w">  </span>IN<span class="w">  </span>A<span class="w">   </span><span class="m">54</span>.230.9.182
visibilityspots.org.<span class="w">    </span><span class="m">37</span><span class="w">  </span>IN<span class="w">  </span>A<span class="w">   </span><span class="m">54</span>.230.9.188
visibilityspots.org.<span class="w">    </span><span class="m">37</span><span class="w">  </span>IN<span class="w">  </span>A<span class="w">   </span><span class="m">54</span>.230.9.203

<span class="p">;;</span><span class="w"> </span>Query<span class="w"> </span>time:<span class="w"> </span><span class="m">223</span><span class="w"> </span>msec
<span class="p">;;</span><span class="w"> </span>SERVER:<span class="w"> </span>::1#53<span class="o">(</span>::1<span class="o">)</span>
<span class="p">;;</span><span class="w"> </span>WHEN:<span class="w"> </span>Mon<span class="w"> </span>Apr<span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="m">22</span>:05:37<span class="w"> </span>CEST<span class="w"> </span><span class="m">2018</span>
<span class="p">;;</span><span class="w"> </span>MSG<span class="w"> </span>SIZE<span class="w">  </span>rcvd:<span class="w"> </span><span class="m">328</span>
</code></pre></div>

<p>Obviously I wanted to see myself that when sniffing the network the DNS requests aren't readable so I used tcp dump to prove myself the data was sent through HTTPS</p>
<div class="highlight"><pre><span></span><code>pi-hole# tcpdump -i eth0 udp port 53
22:39:30.837594 IP 192.168.0.3.35765 &gt; piholeContainerID.domain: 36972+ [1au] A? visibilityspots.com. (60)
22:39:31.009345 IP piholeContainerID.domain &gt; 192.168.0.3.35765: 36972 8/0/1 A 54.230.228.38, A 54.230.228.42, A 54.230.228.54, A 54.230.228.68, A 54.230.228.69, A 54.230.228.84, A 54.230.228.92, A 54.230.228.104 (328)
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="nx">cloudflared</span><span class="err">#</span><span class="w"> </span><span class="nx">tcpdump</span><span class="w"> </span><span class="o">-</span><span class="nx">i</span><span class="w"> </span><span class="nx">eth0</span><span class="w"> </span><span class="nx">udp</span><span class="w"> </span><span class="nx">port</span><span class="w"> </span><span class="mi">5054</span>
<span class="nx">tcpdump</span><span class="p">:</span><span class="w"> </span><span class="nx">verbose</span><span class="w"> </span><span class="nx">output</span><span class="w"> </span><span class="nx">suppressed</span><span class="p">,</span><span class="w"> </span><span class="nx">use</span><span class="w"> </span><span class="o">-</span><span class="nx">v</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="o">-</span><span class="nx">vv</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">full</span><span class="w"> </span><span class="nx">protocol</span><span class="w"> </span><span class="nx">decode</span>
<span class="nx">listening</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">eth0</span><span class="p">,</span><span class="w"> </span><span class="nx">link</span><span class="o">-</span><span class="k">type</span><span class="w"> </span><span class="nx">EN10MB</span><span class="w"> </span><span class="p">(</span><span class="nx">Ethernet</span><span class="p">),</span><span class="w"> </span><span class="nx">capture</span><span class="w"> </span><span class="nx">size</span><span class="w"> </span><span class="mi">262144</span><span class="w"> </span><span class="nx">bytes</span>
<span class="mi">20</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="m m-Double">29.029132</span><span class="w"> </span><span class="nx">IP</span><span class="w"> </span><span class="nx">piholeContainerID</span><span class="m m-Double">.59189</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="nx">cloudflaredContainerID</span><span class="m m-Double">.5054</span><span class="p">:</span><span class="w"> </span><span class="nx">UDP</span><span class="p">,</span><span class="w"> </span><span class="nx">length</span><span class="w"> </span><span class="mi">40</span>
<span class="mi">20</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="m m-Double">29.069864</span><span class="w"> </span><span class="nx">IP</span><span class="w"> </span><span class="nx">cloudflaredContainerID</span><span class="m m-Double">.5054</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="nx">piholeContainerID</span><span class="m m-Double">.59189</span><span class="p">:</span><span class="w"> </span><span class="nx">UDP</span><span class="p">,</span><span class="w"> </span><span class="nx">length</span><span class="w"> </span><span class="mi">116</span>
<span class="mi">20</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="m m-Double">30.838803</span><span class="w"> </span><span class="nx">IP</span><span class="w"> </span><span class="nx">piholeContainerID</span><span class="m m-Double">.28892</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="nx">cloudflaredContainerID</span><span class="m m-Double">.5054</span><span class="p">:</span><span class="w"> </span><span class="nx">UDP</span><span class="p">,</span><span class="w"> </span><span class="nx">length</span><span class="w"> </span><span class="mi">60</span>
<span class="mi">20</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="m m-Double">31.003756</span><span class="w"> </span><span class="nx">IP</span><span class="w"> </span><span class="nx">cloudflaredContainerID</span><span class="m m-Double">.5054</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="nx">piholeContainerID</span><span class="m m-Double">.28892</span><span class="p">:</span><span class="w"> </span><span class="nx">UDP</span><span class="p">,</span><span class="w"> </span><span class="nx">length</span><span class="w"> </span><span class="mi">328</span>
<span class="mi">20</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="m m-Double">31.352487</span><span class="w"> </span><span class="nx">IP</span><span class="w"> </span><span class="nx">piholeContainerID</span><span class="m m-Double">.50291</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="nx">cloudflaredContainerID</span><span class="m m-Double">.5054</span><span class="p">:</span><span class="w"> </span><span class="nx">UDP</span><span class="p">,</span><span class="w"> </span><span class="nx">length</span><span class="w"> </span><span class="mi">31</span>
<span class="mi">20</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="m m-Double">31.364073</span><span class="w"> </span><span class="nx">IP</span><span class="w"> </span><span class="nx">piholeContainerID</span><span class="m m-Double">.16365</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="nx">cloudflaredContainerID</span><span class="m m-Double">.5054</span><span class="p">:</span><span class="w"> </span><span class="nx">UDP</span><span class="p">,</span><span class="w"> </span><span class="nx">length</span><span class="w"> </span><span class="mi">31</span>
<span class="mi">20</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="m m-Double">31.411227</span><span class="w"> </span><span class="nx">IP</span><span class="w"> </span><span class="nx">cloudflaredContainerID</span><span class="m m-Double">.5054</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="nx">piholeContainerID</span><span class="m m-Double">.50291</span><span class="p">:</span><span class="w"> </span><span class="nx">UDP</span><span class="p">,</span><span class="w"> </span><span class="nx">length</span><span class="w"> </span><span class="mi">156</span>
<span class="mi">20</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="m m-Double">31.432364</span><span class="w"> </span><span class="nx">IP</span><span class="w"> </span><span class="nx">cloudflaredContainerID</span><span class="m m-Double">.5054</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="nx">piholeContainerID</span><span class="m m-Double">.16365</span><span class="p">:</span><span class="w"> </span><span class="nx">UDP</span><span class="p">,</span><span class="w"> </span><span class="nx">length</span><span class="w"> </span><span class="mi">218</span>
</code></pre></div>

<p>So by now you can configure this new DNS service on your router or dhcp daemon within your local network.</p>
<p>Since the pi isn't running for a very long time I have no clue if it can cope with the load on our network but I'll keep you posted ;)</p>
                    </section>
                    <hr/>
                    <aside class="post-meta">
                        <p>Category: <a href="https://visibilityspots.github.io/blog/category/containers.html">containers</a></p>
                        <p>Tags: <a href="https://visibilityspots.github.io/blog/tag/docker.html">docker</a>, <a href="https://visibilityspots.github.io/blog/tag/compose.html">compose</a>, <a href="https://visibilityspots.github.io/blog/tag/docker-compose.html">docker-compose</a>, <a href="https://visibilityspots.github.io/blog/tag/pi-hole.html">pi-hole</a>, <a href="https://visibilityspots.github.io/blog/tag/pihole.html">pihole</a>, <a href="https://visibilityspots.github.io/blog/tag/cloudflared.html">cloudflared</a>, <a href="https://visibilityspots.github.io/blog/tag/proxy-dns.html">proxy-dns</a>, <a href="https://visibilityspots.github.io/blog/tag/doh.html">DoH</a>, <a href="https://visibilityspots.github.io/blog/tag/dns.html">dns</a>, <a href="https://visibilityspots.github.io/blog/tag/https.html">https</a>, <a href="https://visibilityspots.github.io/blog/tag/over.html">over</a>, </p>
                    </aside>
                    <hr/>
<div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'visibilityspots';
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
                </article>
            </li>
        </ol>
    </div>
        </div>

        <script src="https://visibilityspots.github.io/blog/theme/js/main.js"></script>
        <script src="https://files.stork-search.net/releases/v1.2.1/stork.js"></script>
        <script>
            stork.register("sitesearch", "https://visibilityspots.github.io/blog/search-index.st")
        </script>
    </body>
</html>