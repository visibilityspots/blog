<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>    dockerized DNS over HTTPS using pi-hole through cloudflared proxy-dns
</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
            <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/normalize.css">
        <link href='https://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/font-awesome.min.css">
        <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/main.css">
	<link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/tipuesearch/tipuesearch.css">

    <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/blog.css">
    <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/github.css">
        <link href="https://visibilityspots.github.io/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="visibilityspots Atom Feed" />
        <link href="https://visibilityspots.github.io/blog/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="visibilityspots RSS Feed" />
        <script src="https://visibilityspots.github.io/blog/theme/js/vendor/modernizr-2.6.2.min.js"></script>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

        <div id="wrapper">
<header id="sidebar" class="side-shadow">
    <hgroup id="site-header">
    <a id="site-title" href="https://visibilityspots.github.io/blog"><h1>visibilityspots <i class="icon-dashboard"></i></h1></a>
        <p id="site-desc"> Linux & Open-Source enthusiast | Scouting | Longboarding </p>
    </hgroup>
    <form id="searchform" action="https://visibilityspots.github.io/blog/search.html" onsubmit="return (this.elements['q'].value.length > 0)">
	        <input id="searchbox" type="text" name="q" size="12" placeholder="search">
    </form>
    <nav>
        <ul id="nav-links">
                <li><a href="https://visibilityspots.github.io/blog/">Blog</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/profile.html">Profile</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/projects.html">Projects</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/tools.html">Tools</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/contact.html">Contact</a></li>
        </ul>
    </nav>
    Categories:
      <ul>
	<li><a href="https://visibilityspots.github.io/blog/category/android.html">android</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/apple.html">apple</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/automation.html">automation</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/cloud.html">cloud</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/conferences.html">conferences</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/containers.html">containers</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/home-automation.html">home-automation</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/linux.html">linux</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/networking.html">networking</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/other.html">other</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/php.html">php</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/puppet.html">puppet</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/security.html">security</a></li>
      </ul>
<footer id="site-info">
  <a href="http://creativecommons.org/licenses/by-nc/2.0/be/deed.nl">License</a> | 2009 - 2021 <a href="https://visibilityspots.github.io/blog">visibilityspots.github.io/blog</a> | Generated by <a href="http://getpelican.com/" target="pelican">Pelican</a> | Hosted at <a href="https://pages.github.com/" target="github pages">github pages</a> | <a href="https://visibilityspots.github.io/blog/feeds/all.atom.xml" rel="alternate">Atom</a> feed
</footer></header>
    <div id="post-container">
        <ol id="post-list">
            <li>
                <article class="post-entry">
                    <header class="entry-header">
                        <a href="https://visibilityspots.github.io/blog/dockerized-cloudflared-pi-hole.html" rel="bookmark"><h1>dockerized DNS over HTTPS using pi-hole through cloudflared proxy-dns</h1></a>
<div><p>takes 2 minutes to read</p></div>                        <time class="post-time" datetime="2018-04-21T21:00:00+02:00" pubdate>
                            last modified at Mon 18 February 2019
                        </time>
                    </header>
                    <section class="post-content">
                        <p>a few months ago I configured a thin client as my home server to replace the previous <a href="../raspberry-pi.html">raspberry pi</a> setup.</p>
<p>During that migration I moved over all native services within docker containers. One of those services being a <a href="https://pi-hole.net">pi-hole</a> setup to block ad serving domains on dns level and to have a dns cache within our LAN to gain a bit of speed.</p>
<p>It has been running ever since without any issue and worked pretty well.</p>
<p>When cloudflare <a href="https://blog.cloudflare.com/announcing-1111/">announced</a> their fast and privacy based DNS resolver I got a bit intrigued by their DNS over HTTPS feature. Especially since our ISP telenet is using our <a href="http://www.forceflow.be/2016/09/14/aanpassingen-privacybeleid-telenet/">web history</a> for their advertisements too.</p>
<p>So I stumbled on some articles from <a href="https://oliverhough.cloud/blog/configure-pihole-with-dns-over-https/">Oliver Hough</a> and <a href="https://scotthelme.co.uk/securing-dns-across-all-of-my-devices-with-pihole-dns-over-https-1-1-1-1/">Scott Helme</a> that describe how you can combine a <a href="https://developers.cloudflare.com/1.1.1.1/dns-over-https/cloudflared-proxy/">cloudflared proxy-dns</a> with pi-hole to get your dns requests encrypted through HTTPS and still be able to filter out the advertisements.</p>
<p>Since I got everything in docker I configured a <a href="https://hub.docker.com/r/visibilityspots/cloudflared/">cloudflared</a> container automated through <a href="https://travis-ci.org/visibilityspots/dockerfile-cloudflared">travis</a> with <a href="https://github.com/aelsabbahy/goss/tree/master/extras/dgoss">dgoss</a> tests.</p>
<p>I got some inspiration from <a href="https://twitter.com/MaartjeME">maartje</a> who used a <a href="https://github.com/meyskens/docker-cloudflared/blob/master/.travis.yml">matrix</a> to build multiple docker images for different architectures using travis. The main reason behind this was that after I got this setup up and running using this docker-compose file on my x86_64 machine I wanted to run it on a raspberry pi zero w.</p>
<p>For the pihole container I figured out you can easily pass by the custom DNS servers through docker environment variables so no need anymore for a custom pihole docker container to maintain!</p>
<div class="highlight"><pre><span></span><code>$ cat docker-compose.yml
version: <span class="s2">&quot;3&quot;</span>

services:
  cloudflared:
    container_name: cloudflared
    image: visibilityspots/cloudflared:amd64
    restart: unless-stopped
    networks:
      pihole_net:
        ipv4_address: <span class="m">10</span>.0.0.2

  pi-hole:
    container_name: pi-hole
    image: pihole/pihole:v4.2.1_amd64
    restart: unless-stopped
    ports:
      - <span class="s2">&quot;80:80/tcp&quot;</span>
      - <span class="s2">&quot;53:53/tcp&quot;</span>
      - <span class="s2">&quot;53:53/udp&quot;</span>
    environment:
      - <span class="nv">ServerIP</span><span class="o">=</span><span class="m">10</span>.0.0.3
      - <span class="nv">DNS1</span><span class="o">=</span><span class="s1">&#39;10.0.0.2#5054&#39;</span>
      - <span class="nv">DNS2</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
      - <span class="nv">IPv6</span><span class="o">=</span><span class="nb">false</span>
      - <span class="nv">TZ</span><span class="o">=</span>CEST-2
      - <span class="nv">DNSMASQ_LISTENING</span><span class="o">=</span>all
      - <span class="nv">WEBPASSWORD</span><span class="o">=</span>admin
    networks:
      pihole_net:
        ipv4_address: <span class="m">10</span>.0.0.3
    dns:
      - <span class="m">127</span>.0.0.1
      - <span class="m">1</span>.1.1.1
    cap_add<span class="s2">&quot;</span>
<span class="s2">      - NET_ADMIN</span>

<span class="s2">networks:</span>
<span class="s2">  pihole_net:</span>
<span class="s2">    driver: bridge</span>
<span class="s2">    ipam:</span>
<span class="s2">     config:</span>
<span class="s2">       - subnet: 10.0.0.0/29</span>
</code></pre></div>

<p>I remembered this <a href="https://learn.adafruit.com/pi-hole-ad-blocker-with-pi-zero-w">project</a> where a raspberry pi zero W was used together with a tiny display. In the meanwhile I have the DoH cloudflared/pi-hole combination running on such a tiny device using <a href="https://archlinuxarm.org">ArchLinux ARM</a> and ordered the display :D</p>
<p>You can use the same dockerfile on a raspberry pi zero but with other tags for the container images:</p>
<div class="highlight"><pre><span></span><code><span class="n">image</span><span class="o">:</span><span class="w"> </span><span class="n">visibilityspots</span><span class="o">/</span><span class="n">cloudflared</span><span class="o">:</span><span class="n">arm</span><span class="w"></span>
<span class="n">image</span><span class="o">:</span><span class="w"> </span><span class="n">pihole</span><span class="o">/</span><span class="n">pihole</span><span class="o">:</span><span class="n">v4</span><span class="o">.</span><span class="mi">0</span><span class="n">_armhf</span><span class="w"></span>
</code></pre></div>

<p>As you can see unfortunately I had to configure static ip's since the dnsmasq config needs the ip address of the cloudflared service. If someone has a better solution to implement it let me know!</p>
<p>I also opted to not store the data. Meaning that when the docker containers are restarted the data is gone.</p>
<p>So when you now bring up those 2 containers:</p>
<div class="highlight"><pre><span></span><code>$ docker-compose up -d
Creating network <span class="s2">&quot;###_pihole_net&quot;</span> with driver <span class="s2">&quot;bridge&quot;</span>
Creating pi-hole ...
Creating cloudflared ...
Creating pi-hole
Creating cloudflared ... <span class="k">done</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>$ docker-compose logs cloudflared
Attaching to cloudflared
cloudflared    <span class="p">|</span> <span class="nv">time</span><span class="o">=</span><span class="s2">&quot;2018-04-16T20:01:14Z&quot;</span> <span class="nv">level</span><span class="o">=</span>info <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Adding DNS upstream&quot;</span> <span class="nv">url</span><span class="o">=</span><span class="s2">&quot;https://1.1.1.1/.well-known/dns-query&quot;</span>
cloudflared    <span class="p">|</span> <span class="nv">time</span><span class="o">=</span><span class="s2">&quot;2018-04-16T20:01:14Z&quot;</span> <span class="nv">level</span><span class="o">=</span>info <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Adding DNS upstream&quot;</span> <span class="nv">url</span><span class="o">=</span><span class="s2">&quot;https://1.0.0.1/.well-known/dns-query&quot;</span>
cloudflared    <span class="p">|</span> <span class="nv">time</span><span class="o">=</span><span class="s2">&quot;2018-04-16T20:01:14Z&quot;</span> <span class="nv">level</span><span class="o">=</span>info <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Starting DNS over HTTPS proxy server&quot;</span> <span class="nv">addr</span><span class="o">=</span><span class="s2">&quot;dns://0.0.0.0:5054&quot;</span>
cloudflared    <span class="p">|</span> <span class="nv">time</span><span class="o">=</span><span class="s2">&quot;2018-04-16T20:01:14Z&quot;</span> <span class="nv">level</span><span class="o">=</span>info <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Starting metrics server&quot;</span> <span class="nv">addr</span><span class="o">=</span><span class="s2">&quot;127.0.0.1:35973&quot;</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="err">$</span><span class="w"> </span><span class="n">docker</span><span class="o">-</span><span class="n">compose</span><span class="w"> </span><span class="n">logs</span><span class="w"> </span><span class="nf">pi</span><span class="o">-</span><span class="n">hole</span><span class="w"></span>
<span class="n">Attaching</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="nf">pi</span><span class="o">-</span><span class="n">hole</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="nf">pi</span><span class="o">-</span><span class="n">hole</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="o">[</span><span class="n">services.d</span><span class="o">]</span><span class="w"> </span><span class="n">starting</span><span class="w"> </span><span class="n">services</span><span class="w"></span>
<span class="nf">pi</span><span class="o">-</span><span class="n">hole</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Starting</span><span class="w"> </span><span class="n">lighttpd</span><span class="w"></span>
<span class="nf">pi</span><span class="o">-</span><span class="n">hole</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Starting</span><span class="w"> </span><span class="n">dnsmasq</span><span class="w"></span>
<span class="nf">pi</span><span class="o">-</span><span class="n">hole</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Starting</span><span class="w"> </span><span class="n">crond</span><span class="w"></span>
<span class="nf">pi</span><span class="o">-</span><span class="n">hole</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Starting</span><span class="w"> </span><span class="n">pihole</span><span class="o">-</span><span class="n">FTL</span><span class="w"> </span><span class="p">(</span><span class="k">no</span><span class="o">-</span><span class="n">daemon</span><span class="p">)</span><span class="w"></span>
<span class="nf">pi</span><span class="o">-</span><span class="n">hole</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="o">[</span><span class="n">services.d</span><span class="o">]</span><span class="w"> </span><span class="n">done</span><span class="p">.</span><span class="w"></span>
<span class="nf">pi</span><span class="o">-</span><span class="n">hole</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nl">dnsmasq</span><span class="p">:</span><span class="w"> </span><span class="n">started</span><span class="p">,</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="mf">2.76</span><span class="w"> </span><span class="n">cachesize</span><span class="w"> </span><span class="mi">10000</span><span class="w"></span>
<span class="nf">pi</span><span class="o">-</span><span class="n">hole</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nl">dnsmasq</span><span class="p">:</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="nc">time</span><span class="w"> </span><span class="nl">options</span><span class="p">:</span><span class="w"> </span><span class="n">IPv6</span><span class="w"> </span><span class="n">GNU</span><span class="o">-</span><span class="n">getopt</span><span class="w"> </span><span class="n">DBus</span><span class="w"> </span><span class="n">i18n</span><span class="w"> </span><span class="n">IDN</span><span class="w"> </span><span class="n">DHCP</span><span class="w"> </span><span class="n">DHCPv6</span><span class="w"> </span><span class="k">no</span><span class="o">-</span><span class="n">Lua</span><span class="w"> </span><span class="n">TFTP</span><span class="w"> </span><span class="n">conntrack</span><span class="w"> </span><span class="n">ipset</span><span class="w"> </span><span class="n">auth</span><span class="w"> </span><span class="n">DNSSEC</span><span class="w"> </span><span class="n">loop</span><span class="o">-</span><span class="n">detect</span><span class="w"> </span><span class="n">inotify</span><span class="w"></span>
<span class="nf">pi</span><span class="o">-</span><span class="n">hole</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nl">dnsmasq</span><span class="p">:</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">nameserver</span><span class="w"> </span><span class="mf">10.0.0.2</span><span class="n">#5054</span><span class="w"></span>
<span class="nf">pi</span><span class="o">-</span><span class="n">hole</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nl">dnsmasq</span><span class="p">:</span><span class="w"> </span><span class="k">read</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hosts</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="n">addresses</span><span class="w"></span>
<span class="nf">pi</span><span class="o">-</span><span class="n">hole</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nl">dnsmasq</span><span class="p">:</span><span class="w"> </span><span class="k">read</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">pihole</span><span class="o">/</span><span class="k">local</span><span class="p">.</span><span class="n">list</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">addresses</span><span class="w"></span>
<span class="nf">pi</span><span class="o">-</span><span class="n">hole</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nl">dnsmasq</span><span class="p">:</span><span class="w"> </span><span class="n">failed</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="k">names</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">pihole</span><span class="o">/</span><span class="n">black</span><span class="p">.</span><span class="nl">list</span><span class="p">:</span><span class="w"> </span><span class="k">No</span><span class="w"> </span><span class="n">such</span><span class="w"> </span><span class="k">file</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">directory</span><span class="w"></span>
<span class="nf">pi</span><span class="o">-</span><span class="n">hole</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nl">dnsmasq</span><span class="p">:</span><span class="w"> </span><span class="k">read</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">pihole</span><span class="o">/</span><span class="n">gravity</span><span class="p">.</span><span class="n">list</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">121065</span><span class="w"> </span><span class="n">addresses</span><span class="w"></span>
<span class="nf">pi</span><span class="o">-</span><span class="n">hole</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nl">dnsmasq</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mf">127.0.0.1</span><span class="o">/</span><span class="mi">48521</span><span class="w"> </span><span class="n">query</span><span class="o">[</span><span class="n">A</span><span class="o">]</span><span class="w"> </span><span class="nf">pi</span><span class="p">.</span><span class="n">hole</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="mf">127.0.0.1</span><span class="w"></span>
<span class="nf">pi</span><span class="o">-</span><span class="n">hole</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nl">dnsmasq</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mf">127.0.0.1</span><span class="o">/</span><span class="mi">48521</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">pihole</span><span class="o">/</span><span class="k">local</span><span class="p">.</span><span class="n">list</span><span class="w"> </span><span class="nf">pi</span><span class="p">.</span><span class="n">hole</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="mf">10.0.0.3</span><span class="w"></span>
</code></pre></div>

<p>you should be able to query the containerized pi-hole DNS service from it's host or from within your netwerk using dig:</p>
<div class="highlight"><pre><span></span><code>$ dig @localhost -p <span class="m">53</span> visibilityspots.org
<span class="o">(</span>$ dig @IP-ADDRESS-OF-DOCKER-NODE -p <span class="m">53</span> visibilityspots.org<span class="o">)</span>

<span class="p">;</span> &lt;&lt;&gt;&gt; DiG <span class="m">9</span>.12.1 &lt;&lt;&gt;&gt; @localhost -p <span class="m">53</span> visibilityspots.org
<span class="p">;</span> <span class="o">(</span><span class="m">2</span> servers found<span class="o">)</span>
<span class="p">;;</span> global options: +cmd
<span class="p">;;</span> Got answer:
<span class="p">;;</span> -&gt;&gt;HEADER<span class="s">&lt;&lt;- opco</span>de: QUERY, status: NOERROR, id: <span class="m">51155</span>
<span class="p">;;</span> flags: qr rd ra<span class="p">;</span> QUERY: <span class="m">1</span>, ANSWER: <span class="m">8</span>, AUTHORITY: <span class="m">0</span>, ADDITIONAL: <span class="m">1</span>

<span class="p">;;</span> OPT PSEUDOSECTION:
<span class="p">;</span> EDNS: version: <span class="m">0</span>, flags:<span class="p">;</span> udp: <span class="m">1536</span>
<span class="p">;;</span> QUESTION SECTION:
<span class="p">;</span>visibilityspots.org.       IN  A

<span class="p">;;</span> ANSWER SECTION:
visibilityspots.org.    <span class="m">37</span>  IN  A   <span class="m">54</span>.230.9.72
visibilityspots.org.    <span class="m">37</span>  IN  A   <span class="m">54</span>.230.9.109
visibilityspots.org.    <span class="m">37</span>  IN  A   <span class="m">54</span>.230.9.119
visibilityspots.org.    <span class="m">37</span>  IN  A   <span class="m">54</span>.230.9.143
visibilityspots.org.    <span class="m">37</span>  IN  A   <span class="m">54</span>.230.9.148
visibilityspots.org.    <span class="m">37</span>  IN  A   <span class="m">54</span>.230.9.182
visibilityspots.org.    <span class="m">37</span>  IN  A   <span class="m">54</span>.230.9.188
visibilityspots.org.    <span class="m">37</span>  IN  A   <span class="m">54</span>.230.9.203

<span class="p">;;</span> Query time: <span class="m">223</span> msec
<span class="p">;;</span> SERVER: ::1#53<span class="o">(</span>::1<span class="o">)</span>
<span class="p">;;</span> WHEN: Mon Apr <span class="m">16</span> <span class="m">22</span>:05:37 CEST <span class="m">2018</span>
<span class="p">;;</span> MSG SIZE  rcvd: <span class="m">328</span>
</code></pre></div>

<p>Obviously I wanted to see myself that when sniffing the network the DNS requests aren't readable so I used tcp dump to prove myself the data was sent through HTTPS</p>
<div class="highlight"><pre><span></span><code>pi-hole# tcpdump -i eth0 udp port 53
22:39:30.837594 IP 192.168.0.3.35765 &gt; piholeContainerID.domain: 36972+ [1au] A? visibilityspots.com. (60)
22:39:31.009345 IP piholeContainerID.domain &gt; 192.168.0.3.35765: 36972 8/0/1 A 54.230.228.38, A 54.230.228.42, A 54.230.228.54, A 54.230.228.68, A 54.230.228.69, A 54.230.228.84, A 54.230.228.92, A 54.230.228.104 (328)
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="nv">cloudflared</span># <span class="nv">tcpdump</span> <span class="o">-</span><span class="nv">i</span> <span class="nv">eth0</span> <span class="nv">udp</span> <span class="nv">port</span> <span class="mi">5054</span>
<span class="nv">tcpdump</span>: <span class="nv">verbose</span> <span class="nv">output</span> <span class="nv">suppressed</span>, <span class="nv">use</span> <span class="o">-</span><span class="nv">v</span> <span class="nv">or</span> <span class="o">-</span><span class="nv">vv</span> <span class="k">for</span> <span class="nv">full</span> <span class="nv">protocol</span> <span class="nv">decode</span>
<span class="nv">listening</span> <span class="nv">on</span> <span class="nv">eth0</span>, <span class="nv">link</span><span class="o">-</span><span class="nv">type</span> <span class="nv">EN10MB</span> <span class="ss">(</span><span class="nv">Ethernet</span><span class="ss">)</span>, <span class="nv">capture</span> <span class="nv">size</span> <span class="mi">262144</span> <span class="nv">bytes</span>
<span class="mi">20</span>:<span class="mi">39</span>:<span class="mi">29</span>.<span class="mi">029132</span> <span class="nv">IP</span> <span class="nv">piholeContainerID</span>.<span class="mi">59189</span> <span class="o">&gt;</span> <span class="nv">cloudflaredContainerID</span>.<span class="mi">5054</span>: <span class="nv">UDP</span>, <span class="nv">length</span> <span class="mi">40</span>
<span class="mi">20</span>:<span class="mi">39</span>:<span class="mi">29</span>.<span class="mi">069864</span> <span class="nv">IP</span> <span class="nv">cloudflaredContainerID</span>.<span class="mi">5054</span> <span class="o">&gt;</span> <span class="nv">piholeContainerID</span>.<span class="mi">59189</span>: <span class="nv">UDP</span>, <span class="nv">length</span> <span class="mi">116</span>
<span class="mi">20</span>:<span class="mi">39</span>:<span class="mi">30</span>.<span class="mi">838803</span> <span class="nv">IP</span> <span class="nv">piholeContainerID</span>.<span class="mi">28892</span> <span class="o">&gt;</span> <span class="nv">cloudflaredContainerID</span>.<span class="mi">5054</span>: <span class="nv">UDP</span>, <span class="nv">length</span> <span class="mi">60</span>
<span class="mi">20</span>:<span class="mi">39</span>:<span class="mi">31</span>.<span class="mi">003756</span> <span class="nv">IP</span> <span class="nv">cloudflaredContainerID</span>.<span class="mi">5054</span> <span class="o">&gt;</span> <span class="nv">piholeContainerID</span>.<span class="mi">28892</span>: <span class="nv">UDP</span>, <span class="nv">length</span> <span class="mi">328</span>
<span class="mi">20</span>:<span class="mi">39</span>:<span class="mi">31</span>.<span class="mi">352487</span> <span class="nv">IP</span> <span class="nv">piholeContainerID</span>.<span class="mi">50291</span> <span class="o">&gt;</span> <span class="nv">cloudflaredContainerID</span>.<span class="mi">5054</span>: <span class="nv">UDP</span>, <span class="nv">length</span> <span class="mi">31</span>
<span class="mi">20</span>:<span class="mi">39</span>:<span class="mi">31</span>.<span class="mi">364073</span> <span class="nv">IP</span> <span class="nv">piholeContainerID</span>.<span class="mi">16365</span> <span class="o">&gt;</span> <span class="nv">cloudflaredContainerID</span>.<span class="mi">5054</span>: <span class="nv">UDP</span>, <span class="nv">length</span> <span class="mi">31</span>
<span class="mi">20</span>:<span class="mi">39</span>:<span class="mi">31</span>.<span class="mi">411227</span> <span class="nv">IP</span> <span class="nv">cloudflaredContainerID</span>.<span class="mi">5054</span> <span class="o">&gt;</span> <span class="nv">piholeContainerID</span>.<span class="mi">50291</span>: <span class="nv">UDP</span>, <span class="nv">length</span> <span class="mi">156</span>
<span class="mi">20</span>:<span class="mi">39</span>:<span class="mi">31</span>.<span class="mi">432364</span> <span class="nv">IP</span> <span class="nv">cloudflaredContainerID</span>.<span class="mi">5054</span> <span class="o">&gt;</span> <span class="nv">piholeContainerID</span>.<span class="mi">16365</span>: <span class="nv">UDP</span>, <span class="nv">length</span> <span class="mi">218</span>
</code></pre></div>

<p>So by now you can configure this new DNS service on your router or dhcp daemon within your local network.</p>
<p>Since the pi isn't running for a very long time I have no clue if it can cope with the load on our network but I'll keep you posted ;)</p>
                    </section>
                    <hr/>
                    <aside class="post-meta">
                        <p>Category: <a href="https://visibilityspots.github.io/blog/category/containers.html">containers</a></p>
                        <p>Tags: <a href="https://visibilityspots.github.io/blog/tag/docker.html">docker</a>, <a href="https://visibilityspots.github.io/blog/tag/compose.html">compose</a>, <a href="https://visibilityspots.github.io/blog/tag/docker-compose.html">docker-compose</a>, <a href="https://visibilityspots.github.io/blog/tag/pi-hole.html">pi-hole</a>, <a href="https://visibilityspots.github.io/blog/tag/pihole.html">pihole</a>, <a href="https://visibilityspots.github.io/blog/tag/cloudflared.html">cloudflared</a>, <a href="https://visibilityspots.github.io/blog/tag/proxy-dns.html">proxy-dns</a>, <a href="https://visibilityspots.github.io/blog/tag/doh.html">DoH</a>, <a href="https://visibilityspots.github.io/blog/tag/dns.html">dns</a>, <a href="https://visibilityspots.github.io/blog/tag/https.html">https</a>, <a href="https://visibilityspots.github.io/blog/tag/over.html">over</a>, </p>
                    </aside>
                    <hr/>
<div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'visibilityspots';
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
                </article>
            </li>
        </ol>
    </div>
        </div>

        <script src="https://visibilityspots.github.io/blog/theme/js/main.js"></script>
    </body>
</html>