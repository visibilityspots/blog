<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>    Dockerized jenkins master/slave setup
</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
            <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/normalize.css">
        <link href='https://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/font-awesome.min.css">
        <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/main.css">
	<link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/tipuesearch/tipuesearch.css">

    <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/blog.css">
    <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/github.css">
        <link href="https://visibilityspots.github.io/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="visibilityspots Atom Feed" />
        <link href="https://visibilityspots.github.io/blog/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="visibilityspots RSS Feed" />
        <script src="https://visibilityspots.github.io/blog/theme/js/vendor/modernizr-2.6.2.min.js"></script>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

        <div id="wrapper">
<header id="sidebar" class="side-shadow">
    <hgroup id="site-header">
    <a id="site-title" href="https://visibilityspots.github.io/blog"><h1>visibilityspots <i class="icon-dashboard"></i></h1></a>
        <p id="site-desc"> Linux & Open-Source enthusiast | Scouting | Longboarding </p>
    </hgroup>
    <form id="searchform" action="https://visibilityspots.github.io/blog/search.html" onsubmit="return (this.elements['q'].value.length > 0)">
	        <input id="searchbox" type="text" name="q" size="12" placeholder="search">
    </form>
    <nav>
        <ul id="nav-links">
                <li><a href="https://visibilityspots.github.io/blog/">Blog</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/profile.html">Profile</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/links.html">Links</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/projects.html">Projects</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/tools.html">Tools</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/contact.html">Contact</a></li>
        </ul>
    </nav>
    Categories:
      <ul>
	<li><a href="https://visibilityspots.github.io/blog/category/android.html">android</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/apple.html">apple</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/automation.html">automation</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/cloud.html">cloud</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/conferences.html">conferences</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/containers.html">containers</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/home-automation.html">home-automation</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/linux.html">linux</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/networking.html">networking</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/other.html">other</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/php.html">php</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/puppet.html">puppet</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/security.html">security</a></li>
      </ul>
<footer id="site-info">
  <a href="http://creativecommons.org/licenses/by-nc/2.0/be/deed.nl">License</a> | 2009 - 2021 <a href="https://visibilityspots.github.io/blog">visibilityspots.github.io/blog</a> | Generated by <a href="http://getpelican.com/" target="pelican">Pelican</a> | Hosted at <a href="https://pages.github.com/" target="github pages">github pages</a> | <a href="https://visibilityspots.github.io/blog/feeds/all.atom.xml" rel="alternate">Atom</a> feed
</footer></header>
    <div id="post-container">
        <ol id="post-list">
            <li>
                <article class="post-entry">
                    <header class="entry-header">
                        <a href="https://visibilityspots.github.io/blog/dockerized-jenkins.html" rel="bookmark"><h1>Dockerized jenkins master/slave setup</h1></a>
<div><p>takes 2 minutes to read</p></div>                        <time class="post-time" datetime="2017-09-06T22:00:00+02:00" pubdate>
                            last modified at Wed 06 September 2017
                        </time>
                    </header>
                    <section class="post-content">
                        <p>started at a new customer we were looking for a more flexible way of having jenkins spinning up slaves on the fly. This in a way a slave is only started and consuming resources when a specific job is running. That way those resources could be used more efficient.</p>
<p>Also the fact that developers could take control over their build servers by managing the Dockerfiles themselves is a great advantage too. But that's for a later phase. Let's start at the beginning.</p>
<p>For the docker host a CentOS 7 server has been provisioned and prepared to run the docker daemon. Starting with updating the OS, removing unnecessary services and implementing NTP.</p>
<div class="highlight"><pre><span></span><code><span class="o">#</span> <span class="n">yum</span> <span class="n">upgrade</span> <span class="o">-</span><span class="n">y</span>

<span class="o">#</span> <span class="n">systemctl</span> <span class="n">stop</span> <span class="k">postfix</span>
<span class="o">#</span> <span class="n">systemctl</span> <span class="n">disable</span> <span class="k">postfix</span>
<span class="o">#</span> <span class="n">yum</span> <span class="n">remove</span> <span class="k">postfix</span>

<span class="o">#</span> <span class="n">systemctl</span> <span class="n">stop</span> <span class="n">chronyd</span>
<span class="o">#</span> <span class="n">yum</span> <span class="n">remove</span> <span class="n">chrony</span> <span class="o">-</span><span class="n">y</span>

<span class="o">#</span> <span class="n">reboot</span>

<span class="o">#</span> <span class="n">yum</span> <span class="n">install</span> <span class="n">ntp</span>
<span class="o">#</span> <span class="n">systemctl</span> <span class="k">start</span> <span class="n">ntpd</span>
<span class="o">#</span> <span class="n">systemctl</span> <span class="n">enable</span> <span class="n">ntpd</span>
<span class="o">#</span> <span class="n">ntpdate</span>
<span class="o">#</span> <span class="nb">date</span>
</code></pre></div>

<p>Once the system has been prepared we can start with the installation of the docker daemon using the upstream <a href="https://www.docker.com/community-edition">docker community edition</a> repository</p>
<div class="highlight"><pre><span></span><code><span class="o">#</span> <span class="n">yum</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">yum</span><span class="o">-</span><span class="n">utils</span> <span class="n">device</span><span class="o">-</span><span class="n">mapper</span><span class="o">-</span><span class="n">persistent</span><span class="o">-</span><span class="k">data</span> <span class="n">lvm2</span>
<span class="o">#</span> <span class="n">yum</span><span class="o">-</span><span class="n">config</span><span class="o">-</span><span class="n">manager</span> <span class="c1">--add-repo https://download.docker.com/linux/centos/docker-ce.repo</span>

<span class="o">#</span> <span class="n">yum</span> <span class="n">clean</span> <span class="k">all</span>
<span class="o">#</span> <span class="n">yum</span> <span class="n">makecache</span> <span class="n">fast</span>
<span class="o">#</span> <span class="n">yum</span> <span class="n">install</span> <span class="n">docker</span><span class="o">-</span><span class="n">ce</span>
<span class="o">#</span> <span class="n">systemctl</span> <span class="k">start</span> <span class="n">docker</span>
<span class="o">#</span> <span class="n">systemctl</span> <span class="n">enable</span> <span class="n">docker</span>

<span class="o">#</span> <span class="n">docker</span> <span class="n">run</span> <span class="n">hello</span><span class="o">-</span><span class="n">world</span>
<span class="n">Hello</span> <span class="k">from</span> <span class="n">Docker</span><span class="o">!</span>
<span class="n">This</span> <span class="n">message</span> <span class="n">shows</span> <span class="n">that</span> <span class="n">your</span> <span class="n">installation</span> <span class="n">appears</span> <span class="k">to</span> <span class="n">be</span> <span class="n">working</span> <span class="n">correctly</span><span class="p">.</span>
<span class="p">...</span>

<span class="o">#</span> <span class="n">docker</span> <span class="n">info</span>
</code></pre></div>

<p>we do now have a basic docker daemon running on a CentOS 7 machine. The next thing to do is to start a jenkins master docker container. Before doing so some decisions need to be made.</p>
<p>Docker containers are stateless, meaning when the container is gone, the data is gone too. With this taken into account and assuming it's a proof of concept I decided to mount a directory on the host to the jenkins master container.</p>
<p>Since the pipeline plugin will be used, all job configurations are residing in Jenkinsfiles. The needed plugins can be passed through the docker run command later on so that's covered as well.</p>
<p>When the setup is ready for production we could look which directories are needed to be persistent and decide to mount only those needed. But for starters we go for a full mount of the jenkins home directory.</p>
<p>Therefore we need to create a jenkins user on the docker host which is the owner of the local directory which will be used afterwards to mount onto the jenkins master docker container.</p>
<div class="highlight"><pre><span></span><code><span class="err"># mkdir /opt/jenkins</span>
<span class="err"># chown -R 1000: /opt/jenkins</span>
</code></pre></div>

<p>before we can start using this very same docker host through our jenkins instance we need to open up the API port of our docker daemon. This can be configured in the systemd entity of the docker daemon:</p>
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="n">mkdir</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="k">system</span><span class="o">/</span><span class="n">docker</span><span class="p">.</span><span class="n">service</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="w"></span>
<span class="err">#</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="k">system</span><span class="o">/</span><span class="n">docker</span><span class="p">.</span><span class="n">service</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">docker</span><span class="p">.</span><span class="n">conf</span><span class="w"></span>
<span class="o">[</span><span class="n">Service</span><span class="o">]</span><span class="w"></span>
<span class="n">ExecStart</span><span class="o">=</span><span class="w"></span>
<span class="n">ExecStart</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">dockerd</span><span class="w"> </span><span class="o">-</span><span class="n">H</span><span class="w"> </span><span class="nl">tcp</span><span class="p">:</span><span class="o">//</span><span class="mf">0.0.0.0</span><span class="err">:</span><span class="mi">2375</span><span class="w"> </span><span class="o">-</span><span class="n">H</span><span class="w"> </span><span class="nl">unix</span><span class="p">:</span><span class="o">//</span><span class="nf">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">docker</span><span class="p">.</span><span class="n">sock</span><span class="w"></span>
<span class="err">#</span><span class="w"> </span><span class="n">systemctl</span><span class="w"> </span><span class="n">daemon</span><span class="o">-</span><span class="n">reload</span><span class="w"></span>
<span class="err">#</span><span class="w"> </span><span class="n">systemctl</span><span class="w"> </span><span class="n">restart</span><span class="w"> </span><span class="n">docker</span><span class="p">.</span><span class="n">service</span><span class="w"></span>
<span class="err">#</span><span class="w"> </span><span class="n">systemctl</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="n">docker</span><span class="p">.</span><span class="n">service</span><span class="w"></span>
<span class="o">*</span><span class="w"> </span><span class="n">docker</span><span class="p">.</span><span class="n">service</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Docker</span><span class="w"> </span><span class="n">Application</span><span class="w"> </span><span class="n">Container</span><span class="w"> </span><span class="n">Engine</span><span class="w"></span>
<span class="nl">Loaded</span><span class="p">:</span><span class="w"> </span><span class="n">loaded</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="k">system</span><span class="o">/</span><span class="n">docker</span><span class="p">.</span><span class="n">service</span><span class="p">;</span><span class="w"> </span><span class="n">enabled</span><span class="p">;</span><span class="w"> </span><span class="n">vendor</span><span class="w"> </span><span class="nl">preset</span><span class="p">:</span><span class="w"> </span><span class="n">disabled</span><span class="p">)</span><span class="w"></span>
<span class="k">Drop</span><span class="o">-</span><span class="ow">In</span><span class="err">:</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="k">system</span><span class="o">/</span><span class="n">docker</span><span class="p">.</span><span class="n">service</span><span class="p">.</span><span class="n">d</span><span class="w"></span>
<span class="o">-</span><span class="w"> </span><span class="n">docker</span><span class="p">.</span><span class="n">conf</span><span class="w"></span>
<span class="nl">Active</span><span class="p">:</span><span class="w"> </span><span class="n">active</span><span class="w"> </span><span class="p">(</span><span class="n">running</span><span class="p">)</span><span class="w"> </span><span class="n">since</span><span class="w"> </span><span class="n">Thu</span><span class="w"> </span><span class="mi">2017</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">20</span><span class="w"> </span><span class="mi">13</span><span class="err">:</span><span class="mi">43</span><span class="err">:</span><span class="mi">22</span><span class="w"> </span><span class="n">CEST</span><span class="p">;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">weeks</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">days</span><span class="w"> </span><span class="n">ago</span><span class="w"></span>
<span class="nl">Docs</span><span class="p">:</span><span class="w"> </span><span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="n">docs</span><span class="p">.</span><span class="n">docker</span><span class="p">.</span><span class="n">com</span><span class="w"></span>
<span class="n">Main</span><span class="w"> </span><span class="nl">PID</span><span class="p">:</span><span class="w"> </span><span class="mi">5858</span><span class="w"> </span><span class="p">(</span><span class="n">dockerd</span><span class="p">)</span><span class="w"></span>
<span class="nl">Memory</span><span class="p">:</span><span class="w"> </span><span class="mf">4.2</span><span class="n">G</span><span class="w"></span>
<span class="nl">CGroup</span><span class="p">:</span><span class="w"> </span><span class="o">/</span><span class="k">system</span><span class="p">.</span><span class="n">slice</span><span class="o">/</span><span class="n">docker</span><span class="p">.</span><span class="n">service</span><span class="w"></span>
<span class="o">|-</span><span class="w"> </span><span class="mi">5858</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">dockerd</span><span class="w"> </span><span class="o">-</span><span class="n">H</span><span class="w"> </span><span class="nl">tcp</span><span class="p">:</span><span class="o">//</span><span class="mf">0.0.0.0</span><span class="err">:</span><span class="mi">2375</span><span class="w"> </span><span class="o">-</span><span class="n">H</span><span class="w"> </span><span class="nl">unix</span><span class="p">:</span><span class="o">//</span><span class="nf">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">docker</span><span class="p">.</span><span class="n">sock</span><span class="w"></span>
<span class="o">|-</span><span class="w"> </span><span class="mi">5866</span><span class="w"> </span><span class="n">docker</span><span class="o">-</span><span class="n">containerd</span><span class="w"> </span><span class="o">-</span><span class="n">l</span><span class="w"> </span><span class="nl">unix</span><span class="p">:</span><span class="o">///</span><span class="nf">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">docker</span><span class="o">/</span><span class="n">libcontainerd</span><span class="o">/</span><span class="n">docker</span><span class="o">-</span><span class="n">containerd</span><span class="p">.</span><span class="n">sock</span><span class="w"> </span><span class="c1">--metrics-interval=0 --start-timeout 2m --state-dir /var/run/docker/libcontainerd/containerd --shim docker-containerd-shim --runtime docker-runc</span>
<span class="p">...</span><span class="w"></span>
</code></pre></div>

<p>we now have the API listening to tcp port 2375 but the port is still filtered by our firewall. To configure the firewall add the port to the appropriate zone and interface. Also the range 32000-34000 which is used by jenkins to access the slaves through ssh is needed to be accessible:</p>
<div class="highlight"><pre><span></span><code><span class="o">#</span> <span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span> <span class="c1">--permanent --add-port=2375/tcp</span>
<span class="o">#</span> <span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span> <span class="c1">--permanent --zone=trusted --change-interface=docker0</span>
<span class="o">#</span> <span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span> <span class="c1">--permanent --zone=trusted --add-port=2375/tcp</span>
<span class="o">#</span> <span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span> <span class="c1">--permanent --zone=public --add-port=32000-34000/tcp</span>
<span class="o">#</span> <span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span> <span class="c1">--reload</span>

<span class="o">#</span> <span class="n">yum</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">nmap</span>
<span class="o">#</span> <span class="n">nmap</span> <span class="o">-</span><span class="n">p</span> <span class="mi">2375</span> <span class="n">ip</span><span class="p">.</span><span class="k">of</span><span class="p">.</span><span class="n">docker</span><span class="p">.</span><span class="k">host</span>

<span class="n">Starting</span> <span class="n">Nmap</span> <span class="mi">6</span><span class="p">.</span><span class="mi">40</span> <span class="p">(</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">nmap</span><span class="p">.</span><span class="n">org</span> <span class="p">)</span> <span class="k">at</span> <span class="mi">2017</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">09</span> <span class="mi">10</span><span class="p">:</span><span class="mi">29</span> <span class="n">CEST</span>
<span class="n">Nmap</span> <span class="n">scan</span> <span class="n">report</span> <span class="k">for</span> <span class="mi">10</span><span class="p">.</span><span class="mi">11</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">17</span>
<span class="k">Host</span> <span class="k">is</span> <span class="n">up</span> <span class="p">(</span><span class="mi">1500</span><span class="n">s</span> <span class="n">latency</span><span class="p">).</span>
<span class="n">PORT</span>     <span class="k">STATE</span> <span class="n">SERVICE</span>
<span class="mi">2375</span><span class="o">/</span><span class="n">tcp</span> <span class="k">open</span>  <span class="k">unknown</span>

<span class="n">Nmap</span> <span class="n">done</span><span class="p">:</span> <span class="mi">1</span> <span class="n">IP</span> <span class="n">address</span> <span class="p">(</span><span class="mi">1</span> <span class="k">host</span> <span class="n">up</span><span class="p">)</span> <span class="n">scanned</span> <span class="k">in</span> <span class="mi">0</span><span class="p">.</span><span class="mi">05</span> <span class="n">seconds</span>

<span class="o">#</span> <span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="k">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">2375</span><span class="o">/</span><span class="n">images</span><span class="o">/</span><span class="n">json</span>
</code></pre></div>

<p>and we are off to go, a docker container can be started using the <a href="https://hub.docker.com/r/jenkins/jenkins/">official upstream image</a> from jenkins. They also did a great job on <a href="https://github.com/jenkinsci/docker/blob/master/README.md">documentation</a> about those docker images. We went for the lts release because this setup will be the production one in the future.</p>
<div class="highlight"><pre><span></span><code><span class="err"># docker run -d -p 8080:8080 -v /opt/jenkins/:/var/jenkins_home -v /var/run/docker.sock:/var/run/docker.sock jenkinsci/jenkins:lts</span>
</code></pre></div>

<p>as you can see we passed through the <a href="https://jpetazzo.github.io/2015/09/03/do-not-use-docker-in-docker-for-ci/">docker unix socket</a> from the host to the jenkins container by doing so we are now able to instruct actions on the docker host from within our jenkins instance.</p>
<p>on your docker host a jenkins container is running and accessible through the docker host's ip address on port 8080 which is forwarded to the jenkins master docker container. To have access to the container himself or follow the logs:</p>
<div class="highlight"><pre><span></span><code><span class="err"># docker ps</span>
<span class="err">CONTAINER ID        IMAGE                   COMMAND                  CREATED             STATUS              PORTS                               NAMES</span>
<span class="err">d28838216442        jenkinsci/jenkins:lts   &quot;/bin/tini -- /usr...&quot;   19 hours ago        Up 19 hours         0.0.0.0:8080-&gt;8080/tcp, 50000/tcp   determined_bartik</span>
<span class="err"># docker exec -i -t --user root d28838216442 /bin/bash</span>
<span class="err"># docker logs -f d28838216442</span>
</code></pre></div>

<p>the plugin needed to communicate with our docker host is the <a href="https://wiki.jenkins.io/display/JENKINS/Docker+Plugin">docker plugin</a> following the configuration as described in their documentation we created a docker cloud which will be used to execute builds with a specified label only. This is very handy because we can now create different docker images for every piece of software with other dependencies.</p>
<p>For the initial testing setup we used the upstream docker image <a href="https://hub.docker.com/r/evarga/jenkins-slave/">evarga/jenkins-slave</a>.</p>
<h2>docker cloud configuration</h2>
<p>Manage Jenkins -&gt; Configure System: Cloud - Add new cloud: Docker Cloud</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Name</td>
<td>testdocker</td>
</tr>
<tr>
<td>Docker URL</td>
<td>tcp://ip.address:2375</td>
</tr>
<tr>
<td>Connection Timeout</td>
<td>15</td>
</tr>
<tr>
<td>Read Timeout</td>
<td>5</td>
</tr>
<tr>
<td>Container Cap</td>
<td>100</td>
</tr>
</tbody>
</table>
<p>-&gt; Add Docker Template</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Docker Image</td>
<td>evarga/jenkins-slave:latest   (the tag can be pinpointed for production)</td>
</tr>
<tr>
<td>Container Settings</td>
<td></td>
</tr>
<tr>
<td>Volumes</td>
<td>/var/run/docker.sock:/var/run/docker.sock</td>
</tr>
<tr>
<td>Remote Filing System Root</td>
<td>/home/jenkins</td>
</tr>
<tr>
<td>Labels</td>
<td>generic</td>
</tr>
<tr>
<td>Usage</td>
<td>Only build jobs with label expressions matching this node</td>
</tr>
<tr>
<td>Launch method</td>
<td>Docker SSH computer launcher</td>
</tr>
<tr>
<td>Credentials</td>
<td>jenkins (A dedicated SSH key pair for jenkins use cases)</td>
</tr>
<tr>
<td>Host Key Verification Strategy</td>
<td>Manually provided key Verification Strategy</td>
</tr>
<tr>
<td>SSH-KEY</td>
<td>the private SSH key for the jenkins slave user</td>
</tr>
<tr>
<td>Remote FS Root Mapping</td>
<td>/home/jenkins</td>
</tr>
<tr>
<td>Remove volumes</td>
<td>true</td>
</tr>
<tr>
<td>Pull strategy</td>
<td>Pull once and update latest</td>
</tr>
</tbody>
</table>
<p>Depending on the label specific docker images will be used to execute the job and store the result in a repository.</p>
<p>Along the way I struggled with setting up the docker cloud. In the first place because we are abusing the same docker host as our jenkins container is running on. By passing through the docker socket and opening up a range of ports used by jenkins to SSH into the slaves I finally achieved a running job which spawns a docker container and destroys him as soon as the job is done.</p>
<h2>custom jenkins master image</h2>
<p>to get the docker plugin working nicely the docker daemon needs to be installed on the jenkins instance too. Therefor I created a new <a href="https://hub.docker.com/r/visibilityspots/jenkins-docker/">jenkins-docker</a> docker image which is based on the upstream jenkins:lts image but adds the docker daemon and staticly configure the docker GID to prevent mismatches between the docker socket mounted on the container from the host.</p>
<p>to have the daemon mounted from the host in the jenkins containers, both master as slave should be able to execute docker commands over the socket the docker group need to have the same GID on all containers and 'physical' machines. Since we statically changed this GID already on the containers we also need to map this GID on the physical machine:</p>
<div class="highlight"><pre><span></span><code><span class="err"># groupmod -g 900 docker</span>
<span class="err"># systemctl restart docker.service</span>
</code></pre></div>

<p>The container is started with some extra parameters like the java_opts one for the allocation of RAM memory for the jenkins daemon.</p>
<div class="highlight"><pre><span></span><code><span class="err"># docker run -d -p 8080:8080 -v /opt/jenkins/:/var/jenkins_home -e JAVA_OPTS=&quot;-Xmx6144m&quot; -v /var/run/docker.sock:/var/run/docker.sock visibilityspots/jenkins-docker:latest</span>
</code></pre></div>
                    </section>
                    <hr/>
                    <aside class="post-meta">
                        <p>Category: <a href="https://visibilityspots.github.io/blog/category/containers.html">containers</a></p>
                        <p>Tags: <a href="https://visibilityspots.github.io/blog/tag/docker.html">docker</a>, <a href="https://visibilityspots.github.io/blog/tag/jenkins.html">jenkins</a>, <a href="https://visibilityspots.github.io/blog/tag/master.html">master</a>, <a href="https://visibilityspots.github.io/blog/tag/slave.html">slave</a>, <a href="https://visibilityspots.github.io/blog/tag/centos.html">centos</a>, <a href="https://visibilityspots.github.io/blog/tag/7.html">7</a>, </p>
                    </aside>
                    <hr/>
<div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'visibilityspots';
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
                </article>
            </li>
        </ol>
    </div>
        </div>

        <script src="https://visibilityspots.github.io/blog/theme/js/main.js"></script>
    </body>
</html>