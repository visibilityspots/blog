<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>    Jenkins docker-pipeline
</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
            <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/normalize.css">
        <link href='https://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/font-awesome.min.css">
        <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/main.css">
	<link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/tipuesearch/tipuesearch.css">

    <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/blog.css">
    <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/github.css">
        <link href="https://visibilityspots.github.io/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="visibilityspots Atom Feed" />
        <link href="https://visibilityspots.github.io/blog/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="visibilityspots RSS Feed" />
        <script src="https://visibilityspots.github.io/blog/theme/js/vendor/modernizr-2.6.2.min.js"></script>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

        <div id="wrapper">
<header id="sidebar" class="side-shadow">
    <hgroup id="site-header">
    <a id="site-title" href="https://visibilityspots.github.io/blog"><h1>visibilityspots <i class="icon-dashboard"></i></h1></a>
        <p id="site-desc"> Linux & Open-Source enthusiast | Scouting | Longboarding </p>
    </hgroup>
    <form id="searchform" action="https://visibilityspots.github.io/blog/search.html" onsubmit="return (this.elements['q'].value.length > 0)">
	        <input id="searchbox" type="text" name="q" size="12" placeholder="search">
    </form>
    <nav>
        <ul id="nav-links">
                <li><a href="https://visibilityspots.github.io/blog/">Blog</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/profile.html">Profile</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/links.html">Links</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/projects.html">Projects</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/tools.html">Tools</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/contact.html">Contact</a></li>
        </ul>
    </nav>
    Categories:
      <ul>
	<li><a href="https://visibilityspots.github.io/blog/category/android.html">android</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/apple.html">apple</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/automation.html">automation</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/cloud.html">cloud</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/conferences.html">conferences</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/containers.html">containers</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/home-automation.html">home-automation</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/linux.html">linux</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/networking.html">networking</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/other.html">other</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/php.html">php</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/puppet.html">puppet</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/security.html">security</a></li>
      </ul>
<footer id="site-info">
  <a href="http://creativecommons.org/licenses/by-nc/2.0/be/deed.nl">License</a> | 2009 - 2021 <a href="https://visibilityspots.github.io/blog">visibilityspots.github.io/blog</a> | Generated by <a href="http://getpelican.com/" target="pelican">Pelican</a> | Hosted at <a href="https://pages.github.com/" target="github pages">github pages</a> | <a href="https://visibilityspots.github.io/blog/feeds/all.atom.xml" rel="alternate">Atom</a> feed
</footer></header>
    <div id="post-container">
        <ol id="post-list">
            <li>
                <article class="post-entry">
                    <header class="entry-header">
                        <a href="https://visibilityspots.github.io/blog/jenkins-docker-pipeline.html" rel="bookmark"><h1>Jenkins docker-pipeline</h1></a>
<div><p>takes 1 minute to read</p></div>                        <time class="post-time" datetime="2017-10-30T19:00:00+01:00" pubdate>
                            last modified at Mon 30 October 2017
                        </time>
                    </header>
                    <section class="post-content">
                        <p>in a previous blog post I talked about setting up a <a href="https://visibilityspots.github.io/blog/dockerized-jenkins.html">dockerized jenkins master/slave setup</a> and setting up a <a href="https://visibilityspots.github.io/blog/nexus-oss-repository-manager.html">private docker registry using nexus</a>.</p>
<p>The next thing on the roadmap was to use this jenkins setup to actually build new docker images for specific software. Before going to the different teams and talking how they now build their software and how this could be done using this new containerized setup I setted up a new jenkins job.</p>
<p>This jenkins job will build a generic jenkins slave docker container which will be used by the jenkins master to build some generic jobs.</p>
<p>to be able to build docker images through jenkins there is the <a href="https://wiki.jenkins.io/display/JENKINS/Docker+Pipeline+Plugin">docker-pipeline</a> plugin which can be used by seeding a repository with the Dockerfile and a Jenkinsfile as described by this <a href="https://getintodevops.com/blog/building-your-first-docker-image-with-jenkins-2-guide-for-developers">tutorial</a>.</p>
<p>To get it configured I had to install the pipeline plugin, configure an SSH key into jenkins and github so jenkins was able to pull the repository together with the docker registry credentials from the private nexus which will be used in the jenkinsfile.</p>
<p>To use the docker-plugin docker needs to be installed on the jenkinsmaster. We already covered that part in the <a href="https://visibilityspots.github.io/blog/dockerized-jenkins.html">dockerized jenkins master/slave</a> post.</p>
<p>Also the jenkins user needs to be added to the docker group too so it could try to communicate with the docker socket. Which is a weird combination because it's using the docker daemon of the docker node since the socket has been mounted on the jenkins master container.</p>
<p>Because we mount the docker socket from the host to the docker daemon the GID's of the docker group on both host and container need to match to each other. This is explained on the <a href="https://github.com/visibilityspots/dockerfile-jenkins-docker#configuration">github</a> page which resides the config files for the <a href="https://hub.docker.com/r/visibilityspots/jenkins-docker/">jenkins-docker</a> image.</p>
<h2>configuration</h2>
<h3>GID</h3>
<p>The container docker GID is already configured statically to 900 so by changing the one on the host they match and no permission issues should arise concerning this topic.</p>
<h2>credentials</h2>
<h3>jenkins</h3>
<p>To enable jenkins to read from github a jenkins public SSH key need to be added to repository and the private SSH key needs to be configured in jenkins</p>
<p>Next to the repository credentials we also need to configure credentials of the docker repository hosted on our nexus instance and refer to the ID in the jenkinsfile so the pipeline plugin can act accordingly.</p>
<h2>Jenkinsfile</h2>
<p>The steps to be executed are defined in a Jenkinsfile this file can be added in a repository next to the Dockerfile and will perform some stages;</p>
<h3>clone repository</h3>
<ul>
<li>perform a git checkout to the latest update</li>
<li>trim the first 6 chars of the last commit to use as a tag version for the docker image to be builded</li>
</ul>
<h3>build image</h3>
<ul>
<li>build the image based on the Dockerfile</li>
</ul>
<h3>test image</h3>
<ul>
<li>use dgoss to perform a test based on the goss.yaml file</li>
</ul>
<h3>push image</h3>
<ul>
<li>push the created and tested image to the registry with the latest tag and with the short commit hash</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">node</span> <span class="p">(</span><span class="s1">&#39;generic&#39;</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">def</span> <span class="n">container</span>

  <span class="n">ansiColor</span><span class="p">(</span><span class="s1">&#39;xterm&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;Clone repository&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">checkout</span> <span class="n">scm</span>
      <span class="n">shortCommit</span> <span class="o">=</span> <span class="n">sh</span><span class="p">(</span><span class="n">returnStdout</span><span class="p">:</span> <span class="bp">true</span><span class="p">,</span> <span class="n">script</span><span class="p">:</span> <span class="s1">&#39;git rev-parse --short HEAD&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">trim</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;Build image&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">container</span> <span class="o">=</span> <span class="n">docker</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="s1">&#39;visibilityspots/jenkins-docker&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;Test image&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">sh</span> <span class="s1">&#39;export GOSS_FILES_STRATEGY=cp &amp;&amp; /usr/local/bin/dgoss  run --name jenkins-docker-dgoss-test --rm -ti visibilityspots/jenkins-docker&#39;</span>
    <span class="p">}</span>

    <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;Push image&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">docker</span><span class="o">.</span><span class="n">withRegistry</span><span class="p">(</span><span class="s1">&#39;https://nexus.repository&#39;</span><span class="p">,</span> <span class="s1">&#39;nexus-credentials-id&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">container</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="s2">&quot;${shortCommit}&quot;</span><span class="p">)</span>
        <span class="n">container</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="s1">&#39;latest&#39;</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2>testing the docker image</h2>
<p>there is this tool called <a href="https://github.com/aelsabbahy/goss">goss</a> which uses a simple yaml based approach to perform some tests against a server the same way serverspe wcorks. But there is a great wrapper script created called <a href="https://github.com/aelsabbahy/goss/tree/master/extras/dgoss">dgoss</a> which uses the same yaml file to perform the tests against a docker container it spins up especially for the testing case.</p>
<p>When one of the defined tests fails after the image has been build using the Dockerfile, the jenkins pipeline will abort and will not push the image to the registry. To be able to run the goss test suite the software is also preinstalled on our jenkins-slave docker images.</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">jenkins-docker</span><span class="o">]</span><span class="w"> </span><span class="n">Running</span><span class="w"> </span><span class="n">shell</span><span class="w"> </span><span class="n">script</span><span class="w"></span>
<span class="n">export</span><span class="w"> </span><span class="n">GOSS_FILES_STRATEGY</span><span class="o">=</span><span class="n">cp</span><span class="w"></span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">dgoss</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">name</span><span class="w"> </span><span class="n">jenkins</span><span class="o">-</span><span class="n">docker</span><span class="o">-</span><span class="n">dgoss</span><span class="o">-</span><span class="n">test</span><span class="w"> </span><span class="o">--</span><span class="n">rm</span><span class="w"> </span><span class="o">-</span><span class="n">ti</span><span class="w"> </span><span class="n">visibilityspots</span><span class="o">/</span><span class="n">jenkins</span><span class="o">-</span><span class="n">docker</span><span class="w"></span>
<span class="nl">INFO</span><span class="p">:</span><span class="w"> </span><span class="n">Starting</span><span class="w"> </span><span class="n">docker</span><span class="w"> </span><span class="n">container</span><span class="w"></span>
<span class="nl">INFO</span><span class="p">:</span><span class="w"> </span><span class="n">Container</span><span class="w"> </span><span class="nl">ID</span><span class="p">:</span><span class="w"> </span><span class="n">e0849245</span><span class="w"></span>
<span class="nl">INFO</span><span class="p">:</span><span class="w"> </span><span class="n">Sleeping</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="mf">0.2</span><span class="w"></span>
<span class="nl">INFO</span><span class="p">:</span><span class="w"> </span><span class="n">Running</span><span class="w"> </span><span class="n">Tests</span><span class="w"></span>
<span class="k">User</span><span class="err">:</span><span class="w"> </span><span class="nl">jenkins</span><span class="p">:</span><span class="w"> </span><span class="ow">exists</span><span class="err">:</span><span class="w"> </span><span class="n">matches</span><span class="w"> </span><span class="nl">expectation</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">true</span><span class="o">]</span><span class="w"></span>
<span class="k">User</span><span class="err">:</span><span class="w"> </span><span class="nl">jenkins</span><span class="p">:</span><span class="w"> </span><span class="nl">groups</span><span class="p">:</span><span class="w"> </span><span class="n">matches</span><span class="w"> </span><span class="nl">expectation</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">[&quot;jenkins&quot;,&quot;docker&quot;</span><span class="o">]</span><span class="err">]</span><span class="w"></span>
<span class="k">Group</span><span class="err">:</span><span class="w"> </span><span class="nl">docker</span><span class="p">:</span><span class="w"> </span><span class="ow">exists</span><span class="err">:</span><span class="w"> </span><span class="n">matches</span><span class="w"> </span><span class="nl">expectation</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">true</span><span class="o">]</span><span class="w"></span>
<span class="k">Group</span><span class="err">:</span><span class="w"> </span><span class="nl">docker</span><span class="p">:</span><span class="w"> </span><span class="nl">gid</span><span class="p">:</span><span class="w"> </span><span class="n">matches</span><span class="w"> </span><span class="nl">expectation</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">900</span><span class="o">]</span><span class="w"></span>
<span class="nl">Package</span><span class="p">:</span><span class="w"> </span><span class="n">docker</span><span class="o">-</span><span class="nl">ce</span><span class="p">:</span><span class="w"> </span><span class="nl">installed</span><span class="p">:</span><span class="w"> </span><span class="n">matches</span><span class="w"> </span><span class="nl">expectation</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">true</span><span class="o">]</span><span class="w"></span>
<span class="nl">Package</span><span class="p">:</span><span class="w"> </span><span class="k">file</span><span class="err">:</span><span class="w"> </span><span class="nl">installed</span><span class="p">:</span><span class="w"> </span><span class="n">matches</span><span class="w"> </span><span class="nl">expectation</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">true</span><span class="o">]</span><span class="w"></span>
<span class="nl">Command</span><span class="p">:</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="k">file</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="k">localtime</span><span class="err">:</span><span class="w"> </span><span class="k">exit</span><span class="o">-</span><span class="nl">status</span><span class="p">:</span><span class="w"> </span><span class="n">matches</span><span class="w"> </span><span class="nl">expectation</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="w"></span>
<span class="nl">Command</span><span class="p">:</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="k">file</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="k">localtime</span><span class="err">:</span><span class="w"> </span><span class="nl">stdout</span><span class="p">:</span><span class="w"> </span><span class="n">matches</span><span class="w"> </span><span class="nl">expectation</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">/etc/localtime: symbolic link to /usr/share/zoneinfo/Etc/UTC</span><span class="o">]</span><span class="w"></span>

<span class="n">Total</span><span class="w"> </span><span class="nl">Duration</span><span class="p">:</span><span class="w"> </span><span class="mf">0.076</span><span class="n">s</span><span class="w"></span>
<span class="nf">Count</span><span class="err">:</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="nl">Failed</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nl">Skipped</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="nl">INFO</span><span class="p">:</span><span class="w"> </span><span class="n">Deleting</span><span class="w"> </span><span class="n">container</span><span class="w"></span>
</code></pre></div>

<h2>jenkins job</h2>
<p>Next up is the configuration of a pipeline defined jenkins job where the only config is the git repository and a pointer to the Jenkinsfile. If everything went well jenkins will execute the steps defined in the Jenkinsfile and store the docker image as a result in the nexus docker repository.</p>
<h3>configuration</h3>
<table>
<thead>
<tr>
<th>Name</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Poll SCM</td>
<td><em>/1 * </em> * *</td>
</tr>
</tbody>
</table>
<h2>references</h2>
<p><a href="https://getintodevops.com/blog/building-your-first-docker-image-with-jenkins-2-guide-for-developers">https://getintodevops.com/blog/building-your-first-docker-image-with-jenkins-2-guide-for-developers</a></p>
                    </section>
                    <hr/>
                    <aside class="post-meta">
                        <p>Category: <a href="https://visibilityspots.github.io/blog/category/containers.html">containers</a></p>
                        <p>Tags: <a href="https://visibilityspots.github.io/blog/tag/jenkins.html">jenkins</a>, <a href="https://visibilityspots.github.io/blog/tag/docker.html">docker</a>, <a href="https://visibilityspots.github.io/blog/tag/pipeline.html">pipeline</a>, <a href="https://visibilityspots.github.io/blog/tag/plugin.html">plugin</a>, <a href="https://visibilityspots.github.io/blog/tag/jenkinsfile.html">jenkinsfile</a>, <a href="https://visibilityspots.github.io/blog/tag/centos.html">centos</a>, <a href="https://visibilityspots.github.io/blog/tag/master.html">master</a>, <a href="https://visibilityspots.github.io/blog/tag/slave.html">slave</a>, <a href="https://visibilityspots.github.io/blog/tag/7.html">7</a>, </p>
                    </aside>
                    <hr/>
<div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'visibilityspots';
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
                </article>
            </li>
        </ol>
    </div>
        </div>

        <script src="https://visibilityspots.github.io/blog/theme/js/main.js"></script>
    </body>
</html>