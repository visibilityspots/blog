<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>    Nexus OSS repository manager
</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
            <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/normalize.css">
        <link href='https://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/font-awesome.min.css">
        <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/main.css">
	<link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/tipuesearch/tipuesearch.css">

    <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/blog.css">
    <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/github.css">
        <link href="https://visibilityspots.github.io/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="visibilityspots Atom Feed" />
        <link href="https://visibilityspots.github.io/blog/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="visibilityspots RSS Feed" />
        <script src="https://visibilityspots.github.io/blog/theme/js/vendor/modernizr-2.6.2.min.js"></script>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

        <div id="wrapper">
<header id="sidebar" class="side-shadow">
    <hgroup id="site-header">
    <a id="site-title" href="https://visibilityspots.github.io/blog"><h1>visibilityspots <i class="icon-dashboard"></i></h1></a>
        <p id="site-desc"> Linux & Open-Source enthusiast | Scouting | Longboarding </p>
    </hgroup>
    <form id="searchform" action="https://visibilityspots.github.io/blog/search.html" onsubmit="return (this.elements['q'].value.length > 0)">
	        <input id="searchbox" type="text" name="q" size="12" placeholder="search">
    </form>
    <nav>
        <ul id="nav-links">
                <li><a href="https://visibilityspots.github.io/blog/">Blog</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/profile.html">Profile</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/projects.html">Projects</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/tools.html">Tools</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/contact.html">Contact</a></li>
        </ul>
    </nav>
    Categories:
      <ul>
	<li><a href="https://visibilityspots.github.io/blog/category/android.html">android</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/apple.html">apple</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/automation.html">automation</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/cloud.html">cloud</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/conferences.html">conferences</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/containers.html">containers</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/home-automation.html">home-automation</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/linux.html">linux</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/networking.html">networking</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/other.html">other</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/php.html">php</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/puppet.html">puppet</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/security.html">security</a></li>
      </ul>
<footer id="site-info">
  <a href="http://creativecommons.org/licenses/by-nc/2.0/be/deed.nl">License</a> | 2009 - 2021 <a href="https://visibilityspots.github.io/blog">visibilityspots.github.io/blog</a> | Generated by <a href="http://getpelican.com/" target="pelican">Pelican</a> | Hosted at <a href="https://pages.github.com/" target="github pages">github pages</a> | <a href="https://visibilityspots.github.io/blog/feeds/all.atom.xml" rel="alternate">Atom</a> feed
</footer></header>
    <div id="post-container">
        <ol id="post-list">
            <li>
                <article class="post-entry">
                    <header class="entry-header">
                        <a href="https://visibilityspots.github.io/blog/nexus-oss-repository-manager.html" rel="bookmark"><h1>Nexus OSS repository manager</h1></a>
<div><p>takes 2 minutes to read</p></div>                        <time class="post-time" datetime="2017-09-11T19:00:00+02:00" pubdate>
                            last modified at Mon 11 September 2017
                        </time>
                    </header>
                    <section class="post-content">
                        <p>looking for a global repository store which could store maven projects, yum repositories, docker repositories, we bumped into <a href="https://help.sonatype.com/display/NXRM3/Repository+Manager+3">Nexus repository manager</a>. We used the official docker image to see how it can be implemented in the dockerized CI environment.</p>
<h2>docker repository</h2>
<p>as a first the docker repository feature could be enabled so we can start building and storing docker images for the different jenkins build slaves and the jenkins master so our work is reproducible and stored in a safe central place.</p>
<p>We configured 3 repositories in nexus for our docker images seen as a recommended approach in the <a href="https://help.sonatype.com/display/NXRM3/Private+Registry+for+Docker#PrivateRegistryforDocker-HostedRepositoryforDocker(PrivateRegistryforDocker)">nexus documentation</a>. Each of them are configured to their own separate blob store.</p>
<table>
<thead>
<tr>
<th>Name</th>
<th></th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>private</td>
<td></td>
<td>self hosted docker repository where all the internal images will be stored</td>
</tr>
<tr>
<td>proxy</td>
<td></td>
<td>cached proxy which will download every request from docker hub and caches to reduce download but also for having an offline backup of upstream images</td>
</tr>
<tr>
<td>group</td>
<td></td>
<td>group which combines the first 2 repositories behind one URL</td>
</tr>
</tbody>
</table>
<h3>configuration</h3>
<p>by following a tutorial from <a href="https://www.ivankrizsan.se/2016/06/09/create-a-private-docker-registry/">Ivan Krizan</a> a working example has been configured, but this in a way without https enabled which is not the recommended manner to set it up. Therefore we looked into enabling https instead. This can be done in different ways. </p>
<h4>SSL directly configured</h4>
<p>setting it up with https doesn't seemed straightforward with nexus directly connected. Also it has a disadvantage in the docker world that the certificates needs to be present on the container and some configuration changes needs to be made. This makes upgrading the nexus container on it's own a bit of a more complex task as without the direct SSL encryption enabled.</p>
<h4>reverse proxy setup</h4>
<p>we could instead spin up an nginx reverse proxy which will handle the encrypted requests towards the client. In the back it communicates to the nexus container service through plain HTTP on a dedicated docker network only for this kind of traffic.</p>
<p>Based on the standard setup for one private repository by <a href="https://stefanprodan.com/2016/docker-private-registry-nexus-nginx/">Stefan Prodan</a>  I came to the described nginx configuration.</p>
<p>It will serve the web GUI when you access the proxy using a normal browser by a redirect to the nexus container on port 8081 where the management console is living. </p>
<p>For the docker client it will act differently, when a docker pull command is executed it will get redirected to the docker-group repository which combines both images from upstream (cached) as well as images from the private docker repository.</p>
<p>On the other hand when issuing a docker push command the image will get pushed towards the private repository only since group and proxy repositories aren't able to do so.</p>
<div class="highlight"><pre><span></span><code><span class="n">worker_processes</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>

<span class="n">events</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">worker_connections</span><span class="w"> </span><span class="mi">1024</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">http</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">error_log</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">error</span><span class="o">.</span><span class="n">log</span><span class="w"> </span><span class="n">warn</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">access_log</span><span class="w"> </span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="nb nb-Type">null</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">proxy_intercept_errors</span><span class="w"> </span><span class="n">off</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">proxy_send_timeout</span><span class="w"> </span><span class="mi">120</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">proxy_read_timeout</span><span class="w"> </span><span class="mi">300</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">upstream</span><span class="w"> </span><span class="n">nexus</span><span class="o">-</span><span class="n">gui</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">server</span><span class="w"> </span><span class="n">nexus</span><span class="p">:</span><span class="mi">8081</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">upstream</span><span class="w"> </span><span class="n">docker</span><span class="o">-</span><span class="n">private</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">server</span><span class="w"> </span><span class="n">nexus</span><span class="p">:</span><span class="mi">5000</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">upstream</span><span class="w"> </span><span class="n">docker</span><span class="o">-</span><span class="n">group</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">server</span><span class="w"> </span><span class="n">nexus</span><span class="p">:</span><span class="mi">5001</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">map</span><span class="w"> </span><span class="o">$</span><span class="n">request_method</span><span class="w"> </span><span class="o">$</span><span class="n">redirection</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">default</span><span class="w"> </span><span class="s2">&quot;nexus-gui&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="s2">&quot;~GET&quot;</span><span class="w"> </span><span class="s2">&quot;docker-group&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="s2">&quot;~(HEAD|PATCH|PUT|POST|DELETE)&quot;</span><span class="w"> </span><span class="s2">&quot;docker-private&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">server</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="n">listen</span><span class="w"> </span><span class="mi">443</span><span class="w"> </span><span class="n">ssl</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="n">server_name</span><span class="w"> </span><span class="n">nexus</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">org</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="n">ssl_certificate</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">nginx</span><span class="o">.</span><span class="n">crt</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="n">ssl_certificate_key</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">nginx</span><span class="o">.</span><span class="n">key</span><span class="p">;</span><span class="w"></span>

<span class="w">                </span><span class="n">keepalive_timeout</span><span class="w">  </span><span class="mi">5</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="n">proxy_buffering</span><span class="w">    </span><span class="n">off</span><span class="p">;</span><span class="w"></span>

<span class="w">                </span><span class="c1"># allow large uploads</span><span class="w"></span>
<span class="w">                </span><span class="n">client_max_body_size</span><span class="w"> </span><span class="mi">1</span><span class="n">G</span><span class="p">;</span><span class="w"></span>

<span class="w">                </span><span class="n">location</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">$</span><span class="n">http_user_agent</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">docker</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                                </span><span class="n">proxy_pass</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="o">//$</span><span class="n">redirection</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="w"></span>
<span class="w">                        </span><span class="n">proxy_pass</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">nexus</span><span class="o">-</span><span class="n">gui</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="n">proxy_set_header</span><span class="w"> </span><span class="n">Host</span><span class="w"> </span><span class="o">$</span><span class="n">host</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="n">proxy_set_header</span><span class="w"> </span><span class="n">X</span><span class="o">-</span><span class="n">Real</span><span class="o">-</span><span class="n">IP</span><span class="w"> </span><span class="o">$</span><span class="n">remote_addr</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="n">proxy_set_header</span><span class="w"> </span><span class="n">X</span><span class="o">-</span><span class="n">Forwarded</span><span class="o">-</span><span class="n">For</span><span class="w"> </span><span class="o">$</span><span class="n">proxy_add_x_forwarded_for</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<p>Unfortunately when using a self signed key pair the client will not connect properly to the repository. You'll need to use <a href="https://letsencrypt.org">letsencrypt</a> or another party to get a valid certificate from;</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">root@dockernode ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">docker</span><span class="w"> </span><span class="n">login</span><span class="w"> </span><span class="n">nexus</span><span class="p">.</span><span class="k">domain</span><span class="p">.</span><span class="n">org</span><span class="w"></span>
<span class="nl">Username</span><span class="p">:</span><span class="w"> </span><span class="n">test</span><span class="w"></span>
<span class="nl">Password</span><span class="p">:</span><span class="w"></span>
<span class="n">Error</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="nl">daemon</span><span class="p">:</span><span class="w"> </span><span class="k">Get</span><span class="w"> </span><span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="n">nexus</span><span class="p">.</span><span class="k">domain</span><span class="p">.</span><span class="n">org</span><span class="o">/</span><span class="n">v2</span><span class="o">/</span><span class="err">:</span><span class="w"> </span><span class="nl">x509</span><span class="p">:</span><span class="w"> </span><span class="n">certificate</span><span class="w"> </span><span class="n">signed</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="k">unknown</span><span class="w"> </span><span class="n">authority</span><span class="w"></span>
</code></pre></div>

<h4>letsencrypt setup</h4>
<p>when looking for solutions <a href="https://letsencrypt.org">letsencrypt</a> could be an option in combination with an <a href="https://github.com/jwilder/nginx-proxy">nginx-proxy</a> container. But for the moment we placed the auto nginx-proxy on a side track since only one service is needing the proxy and it can perfectly be combined with a docker-compose setup.</p>
<h4>self signed certificates</h4>
<p>in the meanwhile to gain some time we'll stick with the self generated scripts and use the insecure-registry workaround on the docker nodes, jenkins build servers and my local client. When heading for production we'll generate certificates with letsencrypt and I'll update this post.</p>
<h5>centos 7 docker node daemon configuration</h5>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">dockernode</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="c1"># vim /etc/systemd/system/docker.service.d/docker.conf</span><span class="w"></span>
<span class="p">[</span><span class="n">Service</span><span class="p">]</span><span class="w"></span>
<span class="n">ExecStart</span><span class="o">=</span><span class="w"></span>
<span class="n">ExecStart</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">dockerd</span><span class="w"> </span><span class="o">-</span><span class="n">H</span><span class="w"> </span><span class="n">tcp</span><span class="p">:</span><span class="o">//</span><span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">2375</span><span class="w"> </span><span class="o">-</span><span class="n">H</span><span class="w"> </span><span class="n">unix</span><span class="p">:</span><span class="o">//</span><span class="k">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">docker</span><span class="o">.</span><span class="n">sock</span><span class="w"> </span><span class="o">--</span><span class="n">insecure</span><span class="o">-</span><span class="n">registry</span><span class="o">=</span><span class="n">nexus</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">org</span><span class="w"></span>

<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">dockernode</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="c1"># systemctl daemon-reload</span><span class="w"></span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">dockernode</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="c1"># systemctl restart docker.service</span><span class="w"></span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">root@dockernode ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">docker</span><span class="w"> </span><span class="n">login</span><span class="w"> </span><span class="n">nexus</span><span class="p">.</span><span class="k">domain</span><span class="p">.</span><span class="n">org</span><span class="w"></span>
<span class="nl">Username</span><span class="p">:</span><span class="w"> </span><span class="n">test</span><span class="w"></span>
<span class="nl">Password</span><span class="p">:</span><span class="w"></span>
<span class="n">Login</span><span class="w"> </span><span class="n">Succeeded</span><span class="w"></span>
</code></pre></div>

<h5>archlinux client configuration</h5>
<div class="highlight"><pre><span></span><code>$ sudo cat /etc/docker/daemon.json
<span class="o">{</span>
  <span class="s2">&quot;insecure-registries&quot;</span> : <span class="o">[</span><span class="s2">&quot;nexus.domain.org&quot;</span><span class="o">]</span>
<span class="o">}</span>

$ sudo systemctl restart docker.service
$ docker login nexus.domain.org
Username: <span class="nb">test</span>
Password:
Login Succeeded
</code></pre></div>

<h2>tips and tricks</h2>
<h3>blobstore</h3>
<p>we created a separate blob store for every repository, that way on the filesystem they are easily recognized for maintenance tasks in the future.</p>
<h3>removal</h3>
<p>when removing a blob store and a repository through the GUI I noticed the actual content on the file system is still available, when recreating the repository and blob store with the same name the content is available again. When removing the content on the filesystem too you have again a clean repository to start with.</p>
<h2>future improvements and features</h2>
<p>there are some features and configuration options that will need to be implemented in the future, when I got there I will update this blog post accordingly.</p>
                    </section>
                    <hr/>
                    <aside class="post-meta">
                        <p>Category: <a href="https://visibilityspots.github.io/blog/category/containers.html">containers</a></p>
                        <p>Tags: <a href="https://visibilityspots.github.io/blog/tag/nexus.html">nexus</a>, <a href="https://visibilityspots.github.io/blog/tag/repository.html">repository</a>, <a href="https://visibilityspots.github.io/blog/tag/manager.html">manager</a>, <a href="https://visibilityspots.github.io/blog/tag/nginx.html">nginx</a>, <a href="https://visibilityspots.github.io/blog/tag/proxy.html">proxy</a>, <a href="https://visibilityspots.github.io/blog/tag/ssl.html">SSL</a>, <a href="https://visibilityspots.github.io/blog/tag/https.html">https</a>, <a href="https://visibilityspots.github.io/blog/tag/docker.html">docker</a>, <a href="https://visibilityspots.github.io/blog/tag/private.html">private</a>, <a href="https://visibilityspots.github.io/blog/tag/group.html">group</a>, </p>
                    </aside>
                    <hr/>
<div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'visibilityspots';
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
                </article>
            </li>
        </ol>
    </div>
        </div>

        <script src="https://visibilityspots.github.io/blog/theme/js/main.js"></script>
    </body>
</html>