<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>    Nomad spread scheduler
</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
            <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/normalize.css">
        <link href='https://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/font-awesome.min.css">
        <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/main.css">

    <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/blog.css">
    <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/github.css">
        <link href="https://visibilityspots.github.io/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="visibilityspots Atom Feed" />
        <link href="https://visibilityspots.github.io/blog/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="visibilityspots RSS Feed" />
        <script src="https://visibilityspots.github.io/blog/theme/js/vendor/modernizr-2.6.2.min.js"></script>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

        <div id="wrapper">
<header id="sidebar" class="side-shadow">
    <hgroup id="site-header">
    <a id="site-title" href="https://visibilityspots.github.io/blog"><h1>visibilityspots <i class="icon-dashboard"></i></h1></a>
        <p id="site-desc"> Linux & Open-Source enthusiast | Scouting | Longboarding </p>
    </hgroup>

    <nav>
        <ul id="nav-links">
                <li><a href="https://visibilityspots.github.io/blog/">Blog</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/profile.html">Profile</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/projects.html">Projects</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/tools.html">Tools</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/contact.html">Contact</a></li>
        </ul>
    </nav>
    Categories:
      <ul>
        <li><a href="https://visibilityspots.github.io/blog/category/android.html">android</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/apple.html">apple</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/automation.html">automation</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/cloud.html">cloud</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/conferences.html">conferences</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/containers.html">containers</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/home-automation.html">home-automation</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/linux.html">linux</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/networking.html">networking</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/other.html">other</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/php.html">php</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/puppet.html">puppet</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/security.html">security</a></li>
      </ul>
<footer id="site-info">
  <a href="http://creativecommons.org/licenses/by-nc/2.0/be/deed.nl">License</a> | 2009 - 2025 <a href="https://visibilityspots.github.io/blog">visibilityspots.github.io/blog</a> | Generated by <a href="http://getpelican.com/" target="pelican">Pelican</a> | Hosted at <a href="https://pages.github.com/" target="github pages">github pages</a> | <a href="https://visibilityspots.github.io/blog/feeds/all.atom.xml" rel="alternate">Atom</a> feed
</footer></header>
    <div id="post-container">
        <ol id="post-list">
            <li>
                <article class="post-entry">
                    <header class="entry-header">
                        <a href="https://visibilityspots.github.io/blog/nomad-spread-scheduler.html" rel="bookmark"><h1>Nomad spread scheduler</h1></a>
<div><p>takes 0 minutes to read</p></div>                        <time class="post-time" datetime="2023-07-05T22:00:00+02:00" pubdate>
                            last modified at Thu 27 July 2023
                        </time>
                    </header>
                    <section class="post-content">
                        <p>I'm maintaining a <a href="../nomad-arm-cluster.html">nomad cluster</a> already a few years now at home, based on some thin clients and a few raspberry pi's.</p>
<p>The workload is growing from uses cases of the <a href="../planespotting.html">plane-spotting</a> services towards a <a href="../dockerized-cloudflared-pi-hole.html">pi-hole</a> setup, <a href="https://github.com/dani-garcia/vaultwarden">vaultwarden</a>, <a href="https://www.home-assistant.io/">homeassistant</a> and many more use cases.</p>
<p>One of the issues I encountered was based on the default <a href="https://www.nomadproject.io/docs/concepts/scheduling/scheduling">scheduling algorithm</a>. Raspberry pi's are not known as the most efficient solution to run a huge workload. Default nomad will schedule new containers on one compute node until the resource limits of that node are consumed and only then will start consuming another node. This algorithm is named bin packing which is used to optimize resource utilization.</p>
<p>Although the idea seems leg-it I encountered a lot of issues due to this behavior where raspberry pi's got overloaded and therefor failing applications. From which one is the used DNS solution at home resulting in some mad family members not being able to surf anymore :D</p>
<p>Luckily there is an alternative algorithm available called the <a href="https://developer.hashicorp.com/nomad/docs/other-specifications/node-pool#scheduler_algorithm">spread algorithm</a> which will spread your workload amongst the available nomad nodes.</p>
<p>First of all you can double check your current configuration by querying the nomad <a href="https://developer.hashicorp.com/nomad/api-docs/operator/scheduler#sample-request">operator API</a></p>
<p>You can also use the <a href="https://developer.hashicorp.com/nomad/api-docs/operator/scheduler#update-scheduler-configuration">operator API</a> to update the scheduler configuration on the fly. But when you bootstrap a new node you need to configure it manually again for that particular node.</p>
<p>The service block also has an option to set a default scheduler;</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>cat<span class="w"> </span>/etc/nomad.d/nomad.hcl

server<span class="o">{</span>
<span class="w">  </span>default_scheduler_config<span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nv">scheduler_algorithm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;spread&quot;</span>
<span class="w">  </span><span class="o">}</span>
<span class="o">}</span>
</code></pre></div>

<p>And of course restarting the nomad daemon.</p>
<p>Never since I encountered issues again by overloading one of the pi's and therefor resulting in failing applications on top of it.</p>
<p>An other approach would be to use the spread stanza in your nomad jobs, but this seemed to be a too much of a hassle for my home lab setup;</p>
<ul>
<li><a href="https://www.hashicorp.com/blog/spreads-and-affinites-in-nomad">spreads-and-affinites-in-nomad</a></li>
<li><a href="https://developer.hashicorp.com/nomad/tutorials/advanced-scheduling/spread">advanced-scheduling tutorial</a></li>
</ul>
                    </section>
                    <hr/>
                    <aside class="post-meta">
                        <p>Category: <a href="https://visibilityspots.github.io/blog/category/containers.html">containers</a></p>
                        <p>Tags: <a href="https://visibilityspots.github.io/blog/tag/nomad.html">nomad</a>, <a href="https://visibilityspots.github.io/blog/tag/hashicorp.html">hashicorp</a>, <a href="https://visibilityspots.github.io/blog/tag/container.html">container</a>, <a href="https://visibilityspots.github.io/blog/tag/orchestration.html">orchestration</a>, <a href="https://visibilityspots.github.io/blog/tag/spread.html">spread</a>, <a href="https://visibilityspots.github.io/blog/tag/algorithm.html">algorithm</a>, <a href="https://visibilityspots.github.io/blog/tag/scheduling.html">scheduling</a>, </p>
                    </aside>
                    <hr/>
<div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'visibilityspots';
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
                </article>
            </li>
        </ol>
    </div>
        </div>

        <script src="https://visibilityspots.github.io/blog/theme/js/main.js"></script>
    </body>
</html>