<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>    Openstack layer2
</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
            <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/normalize.css">
        <link href='https://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/font-awesome.min.css">
        <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/main.css">
	<link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/tipuesearch/tipuesearch.css">

    <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/blog.css">
    <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/github.css">
        <link href="https://visibilityspots.github.io/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="visibilityspots Atom Feed" />
        <link href="https://visibilityspots.github.io/blog/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="visibilityspots RSS Feed" />
        <script src="https://visibilityspots.github.io/blog/theme/js/vendor/modernizr-2.6.2.min.js"></script>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

        <div id="wrapper">
<header id="sidebar" class="side-shadow">
    <hgroup id="site-header">
    <a id="site-title" href="https://visibilityspots.github.io/blog"><h1>visibilityspots <i class="icon-dashboard"></i></h1></a>
        <p id="site-desc"> Linux & Open-Source enthusiast | Scouting | Longboarding </p>
    </hgroup>
    <form id="searchform" action="https://visibilityspots.github.io/blog/search.html" onsubmit="return (this.elements['q'].value.length > 0)">
	        <input id="searchbox" type="text" name="q" size="12" placeholder="search">
    </form>
    <nav>
        <ul id="nav-links">
                <li><a href="https://visibilityspots.github.io/blog/">Blog</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/profile.html">Profile</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/links.html">Links</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/projects.html">Projects</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/tools.html">Tools</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/contact.html">Contact</a></li>
        </ul>
    </nav>
    Categories:
      <ul>
	<li><a href="https://visibilityspots.github.io/blog/category/android.html">android</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/apple.html">apple</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/automation.html">automation</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/cloud.html">cloud</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/conferences.html">conferences</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/containers.html">containers</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/home-automation.html">home-automation</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/linux.html">linux</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/networking.html">networking</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/other.html">other</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/php.html">php</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/puppet.html">puppet</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/security.html">security</a></li>
      </ul>
<footer id="site-info">
  <a href="http://creativecommons.org/licenses/by-nc/2.0/be/deed.nl">License</a> | 2009 - 2021 <a href="https://visibilityspots.github.io/blog">visibilityspots.github.io/blog</a> | Generated by <a href="http://getpelican.com/" target="pelican">Pelican</a> | Hosted at <a href="https://pages.github.com/" target="github pages">github pages</a> | <a href="https://visibilityspots.github.io/blog/feeds/all.atom.xml" rel="alternate">Atom</a> feed
</footer></header>
    <div id="post-container">
        <ol id="post-list">
            <li>
                <article class="post-entry">
                    <header class="entry-header">
                        <a href="https://visibilityspots.github.io/blog/openstack-layer2.html" rel="bookmark"><h1>Openstack layer2</h1></a>
<div><p>takes 1 minute to read</p></div>                        <time class="post-time" datetime="2016-02-26T20:30:00+01:00" pubdate>
                            last modified at Thu 21 April 2016
                        </time>
                    </header>
                    <section class="post-content">
                        <p>A few months ago I implemented an RDO based openstack kilo release private cloud at one of our customers for their development platform. Through time we tackled a couple of issues so the cloud could be fitted into their work flows.</p>
<p>We stumbled onto some minor issues and some major ones. Let's begin with the minor ones ;)</p>
<p>When upgrading the all-in-one controller before we started using the cloud in 'production' a mean <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1284978">bug</a> bit us in the ankle due to a new hiera package. After some digging around a <a href="https://review.openstack.org/#/c/249301/3/packstack/modules/ospluginutils.py">patch</a> came to the rescue together with the exclusion of the packages puppet<em> and hiera</em> from the epel repository</p>
<div class="highlight"><pre><span></span><code><span class="err">vim /etc/yum.repos.d/epel.repo +9</span>
<span class="err">exclude=hiera*,puppet</span>
</code></pre></div>

<p>Once launched some rather irritating behavior seemed to be the default timeout of horizon (openstack-dashboard) of 30 minutes. It's a development cloud after all and people didn't wanted to re login all the time. To change the default timeout we added a SESSION_TIMEOUT parameter to the local_settings file and restarted apache</p>
<div class="highlight"><pre><span></span><code><span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openstack</span><span class="o">-</span><span class="n">dashboard</span><span class="o">/</span><span class="n">local_settings</span>
<span class="n">SESSION_TIMEOUT</span> <span class="o">=</span> <span class="mi">28800</span>

<span class="n">systemctl</span> <span class="k">restart</span> <span class="n">httpd</span>
</code></pre></div>

<p>After which we reconfigured the expiration time of the keystone token and restarted the keystone service</p>
<div class="highlight"><pre><span></span><code><span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">keystone</span><span class="o">/</span><span class="n">keystone</span><span class="p">.</span><span class="n">conf</span>
<span class="n">expiration</span> <span class="o">=</span> <span class="mi">28800</span>

<span class="n">systemctl</span> <span class="k">restart</span> <span class="n">openstack</span><span class="o">-</span><span class="n">keystone</span><span class="p">.</span><span class="n">service</span>
</code></pre></div>

<p>Another rather tiny issue was the access to the console through the web interface. It couldn't connect through the instance when running on another compute node.</p>
<p>After some research it seemed to by DNS. In the development setup no DNS has been configured for the different compute nodes. We tackled it by the proxy client setting in nova.conf on every compute node</p>
<div class="highlight"><pre><span></span><code><span class="err">vim /etc/nova/nova/conf</span>
<span class="err">vncserver_proxyclient_address=actual.ip.of.the.server</span>
</code></pre></div>

<p>During maintenance we had to reboot a compute-node, after this reboot the instances living on the compute node where not started and came up in shutdown state.</p>
<p>It seemed to be the default behavior of openstack, but as always there is a configuration parameter for it to force the instances to start after a reboot.</p>
<div class="highlight"><pre><span></span><code><span class="err">vim /etc/nova/nova.conf</span>
<span class="err">resume_guests_state_on_host_boot=true</span>
</code></pre></div>

<p>The default behavior of the kilo RDO deployed cloud to pass data through cloud-init to the instance is by serving the file through a separate network at boot time.</p>
<p>We however found it more efficient to serve this file through the filesystem, the so called <a href="http://docs.openstack.org/user-guide/cli_config_drive.html">config_drive</a> option.</p>
<p>It can be forced through the nova config file</p>
<div class="highlight"><pre><span></span><code><span class="err">vim /etc/nova/nova.conf</span>
<span class="err">force_config_drive=True</span>
</code></pre></div>

<p>Also be aware with the lock_passwd feature with passing users through cloud init in openstack due to a <a href="https://bugs.launchpad.net/cloud-init/+bug/1521554">bug</a></p>
<p>So now the minor issues are tackled let's switch to the major and more impacting ones.</p>
<p>We digged into the behavior of the network during the proof of concept phase. And hell that's a big challenge! By default openstack neutron creates a linux bridge and an open vswitch bridge.</p>
<p>The linux bridge is used to translate the security groups into iptables configured to the linux bridge interfaces.</p>
<p>In our use case we wanted to keep the networking setup as simple as possible. Mainly cause a lot of the instance will be used for testing purposes including network traffic and performance.</p>
<p>Since it's only used for internal usage into the R&amp;D department on the we decided to disable the security groups and therefore to ditch the linux bridge out of the linux cluster.</p>
<p>Another reason to disable the security groups was the fact that by using the nova interface-attach command of a network without a subnet configured (layer2) only the default security group was applied to this extra interface.</p>
<p>I filled out a <a href="https://bugs.launchpad.net/neutron/+bug/1512645">bug</a> for this, but it seems we are abusing a bug (attaching networks without subnet configured to an instance) as a feature.</p>
<p>Openstack really doesn't like you to take over control of the layer3 networking part after all. But in our use case we really needed to take over this control to keep our instances as abstract and dynamic as possible.</p>
<p>We only need layer2 connectivity when adding an instance to a specific VLAN based network, an ip address is provided by another DHCP server on this VLAN network. So we don't want openstack to provide DHCP addresses.</p>
<p>By using the nova interface-attach command and the bug/feature of having networks without subnets configured attached we achieved to meet this goal of layer2 connectivity.</p>
<p>So to disable the linux bridge you'll need to <a href="https://gist.github.com/djoreilly/db9c2d32a473c6643551">disable</a> the security groups</p>
<div class="highlight"><pre><span></span><code><span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nova</span><span class="o">/</span><span class="n">nova</span><span class="p">.</span><span class="n">conf</span>
<span class="n">security_group_api</span> <span class="o">=</span> <span class="n">nova</span>
<span class="n">firewall_driver</span> <span class="o">=</span> <span class="n">nova</span><span class="p">.</span><span class="n">virt</span><span class="p">.</span><span class="n">firewall</span><span class="p">.</span><span class="n">NoopFirewallDriver</span>

<span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">neutron</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">ml2</span><span class="o">/</span><span class="n">ml2_conf</span><span class="p">.</span><span class="n">ini</span> <span class="o">#</span> <span class="p">(</span><span class="k">only</span> <span class="k">on</span> <span class="n">controller</span> <span class="n">node</span><span class="p">)</span>
<span class="n">enable_security_group</span> <span class="o">=</span> <span class="k">False</span>

<span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">neutron</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">openvswitch</span><span class="o">/</span>
<span class="n">firewall_driver</span> <span class="o">=</span> <span class="n">neutron</span><span class="p">.</span><span class="n">agent</span><span class="p">.</span><span class="n">firewall</span><span class="p">.</span><span class="n">NoopFirewallDriver</span>
</code></pre></div>

<p>Last but not least some configuration parameters got changed through without we noticed probably by some misconfigured settings in <a href="https://wiki.openstack.org/wiki/Packstack">packstack</a>. To keep this under control we made the configuration files immutable so they could only be modified by manual changes.</p>
<div class="highlight"><pre><span></span><code><span class="err">chattr +i /etc/neutron/plugins/ml2/ml2_conf.ini # (only on controller node)</span>
<span class="err">chattr +i /etc/neutron/plugins/openvswitch/ovs_neutron_plugin.ini</span>
<span class="err">chattr +i /etc/nova/nova.conf</span>
<span class="err">chattr +i /etc/neutron/policy.json</span>
</code></pre></div>

<p>Those are about the main issues worth mentioning we went through. By sharing those I hope to help others in their quest to tame the openstack cluster. If any question arise feel free to comment or contact me about them!</p>
                    </section>
                    <hr/>
                    <aside class="post-meta">
                        <p>Category: <a href="https://visibilityspots.github.io/blog/category/cloud.html">cloud</a></p>
                        <p>Tags: <a href="https://visibilityspots.github.io/blog/tag/openstack.html">openstack</a>, <a href="https://visibilityspots.github.io/blog/tag/layer2.html">layer2</a>, <a href="https://visibilityspots.github.io/blog/tag/security.html">security</a>, <a href="https://visibilityspots.github.io/blog/tag/groups.html">groups</a>, <a href="https://visibilityspots.github.io/blog/tag/linux.html">linux</a>, <a href="https://visibilityspots.github.io/blog/tag/bridge.html">bridge</a>, <a href="https://visibilityspots.github.io/blog/tag/ovs.html">ovs</a>, <a href="https://visibilityspots.github.io/blog/tag/open.html">open</a>, <a href="https://visibilityspots.github.io/blog/tag/vswitch.html">vswitch</a>, <a href="https://visibilityspots.github.io/blog/tag/dhcp.html">dhcp</a>, <a href="https://visibilityspots.github.io/blog/tag/kilo.html">kilo</a>, <a href="https://visibilityspots.github.io/blog/tag/rdo.html">rdo</a>, </p>
                    </aside>
                    <hr/>
<div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'visibilityspots';
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
                </article>
            </li>
        </ol>
    </div>
        </div>

        <script src="https://visibilityspots.github.io/blog/theme/js/main.js"></script>
    </body>
</html>