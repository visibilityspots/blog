<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>    Openstack Kilo change MTU till the VM it's tap interface
</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
            <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/normalize.css">
        <link href='https://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/font-awesome.min.css">
        <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/main.css">
        <link rel="stylesheet" media="screen and (prefers-color-scheme: dark)" href="https://files.stork-search.net/dark.css">

    <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/blog.css">
    <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/github.css">
        <link href="https://visibilityspots.github.io/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="visibilityspots Atom Feed" />
        <link href="https://visibilityspots.github.io/blog/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="visibilityspots RSS Feed" />
        <script src="https://visibilityspots.github.io/blog/theme/js/vendor/modernizr-2.6.2.min.js"></script>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

        <div id="wrapper">
<header id="sidebar" class="side-shadow">
    <hgroup id="site-header">
    <a id="site-title" href="https://visibilityspots.github.io/blog"><h1>visibilityspots <i class="icon-dashboard"></i></h1></a>
        <p id="site-desc"> Linux & Open-Source enthusiast | Scouting | Longboarding </p>
    </hgroup>
    <input data-stork="sitesearch" id="searchbox" type="text" size="12" placeholder="search">
    <div data-stork="sitesearch-output"></div>

    <nav>
        <ul id="nav-links">
                <li><a href="https://visibilityspots.github.io/blog/">Blog</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/profile.html">Profile</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/projects.html">Projects</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/tools.html">Tools</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/contact.html">Contact</a></li>
        </ul>
    </nav>
    Categories:
      <ul>
        <li><a href="https://visibilityspots.github.io/blog/category/android.html">android</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/apple.html">apple</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/automation.html">automation</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/cloud.html">cloud</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/conferences.html">conferences</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/containers.html">containers</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/home-automation.html">home-automation</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/linux.html">linux</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/networking.html">networking</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/other.html">other</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/php.html">php</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/puppet.html">puppet</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/security.html">security</a></li>
      </ul>
<footer id="site-info">
  <a href="http://creativecommons.org/licenses/by-nc/2.0/be/deed.nl">License</a> | 2009 - 2023 <a href="https://visibilityspots.github.io/blog">visibilityspots.github.io/blog</a> | Generated by <a href="http://getpelican.com/" target="pelican">Pelican</a> | Hosted at <a href="https://pages.github.com/" target="github pages">github pages</a> | <a href="https://visibilityspots.github.io/blog/feeds/all.atom.xml" rel="alternate">Atom</a> feed
</footer></header>
    <div id="post-container">
        <ol id="post-list">
            <li>
                <article class="post-entry">
                    <header class="entry-header">
                        <a href="https://visibilityspots.github.io/blog/openstack-mtu.html" rel="bookmark"><h1>Openstack Kilo change MTU till the VM it's tap interface</h1></a>
<div><p>takes 0 minutes to read</p></div>                        <time class="post-time" datetime="2017-03-23T19:00:00+01:00" pubdate>
                            last modified at Thu 23 March 2017
                        </time>
                    </header>
                    <section class="post-content">
                        <p>Recently I was been asked to increase the MTU on the deployed openstack cluster at one of our customers. Since the beginning of my touch on openstack networking has been the hardest part to get my head around. In the first place because openstack does some nifty things on the networking path. But also cause for the use case at the customer a lot of customization has been done to get it implemented in their infrastructure.</p>
<p>Hence the shiver when the MTU question was been made..</p>
<p>Nevertheless together with a colleague who likes a challenge and has a profound knowledge in this area we dived into it. Starting at the external device over all the hardware network switches we came to the openstack cluster, until now nothing got in our way of increasing the MTU size. On the most of the network gear (combination of HP and Cisco) the MTU was already high enough.</p>
<p>But now we came to the compute nodes of our openstack cluster. We have an RDO based kilo release running with one all-in-one controller and a dozen compute nodes. We isolated the compute node where the test instance was running on and went for our dearest friend Mr google for some advise and found a very informational <a href="https://www.openstack.org/assets/presentation-media/the-notorious-mtu.pdf">pdf</a> document about this topic.</p>
<p>After some try and error we got to the current situation where the ovs bridge has been configured with this increased MTU size together with the NIC interface of the compute node itself. This has been achieved by changing following parameters.</p>
<p>To change the MTU size on the ovs bridge we need veth interfaces as described in the configuration file of the plugin.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># /etc/neutron/plugins/openvswitch/ovs_neutron_plugin.ini</span>
<span class="nv">use_veth_interconnection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>True
<span class="nv">veth_mtu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">8000</span>
</code></pre></div>

<p>By restarting the neutron component on the compute node the ovs bridge got reconfigured with veth interfaces and an increased MTU size within seconds and no noticeable down time which was very convenient.</p>
<p>So there is only one step to achieve our goal of sending big packets over the whole chain, the tap interface of the VM on that OVS bridge.</p>
<p>We manually adjusted the tap interfaces by executing an ovs-vsctl command.</p>
<div class="highlight"><pre><span></span><code>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>mtu<span class="w"> </span><span class="m">8000</span><span class="w"> </span>dev<span class="w"> </span>PORTID
</code></pre></div>

<p>Unfortunately until today we didn't find a fix where a new VM gets a network connection on the OVS bridge with this increased MTU size automatically.</p>
<p>We tried several configurations but no luck.</p>
<p>As a temporary workaround we <a href="http://serverfault.com/questions/680635/mtu-on-open-vswitch-bridge-port">found</a> a loop which reconfigures the MTU sizes for all available ports on an OVS bridge.</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span><span class="w"> </span>i<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">$(</span>ovs-vsctl<span class="w"> </span>list<span class="w"> </span>ports<span class="w"> </span>&lt;BRIDGENAME&gt;<span class="k">)</span><span class="p">;</span><span class="k">do</span><span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>mtu<span class="w"> </span><span class="m">9000</span><span class="w"> </span>dev<span class="w"> </span><span class="nv">$i</span><span class="p">;</span><span class="k">done</span><span class="p">;</span>ip<span class="w"> </span>a<span class="w"> </span>show<span class="w"> </span>&lt;BRIDGENAME&gt;
</code></pre></div>

<p>The unsuccesfull changes;</p>
<div class="highlight"><pre><span></span><code><span class="c1"># /etc/neutron/neutron.conf</span>
<span class="nv">advertise_mtu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>True

<span class="c1"># /etc/nova/nova.conf</span>
<span class="nv">network_device_mtu</span><span class="o">=</span><span class="m">8000</span>
</code></pre></div>

<p>So if you did found a solution on this part, please en light us!! :)</p>
                    </section>
                    <hr/>
                    <aside class="post-meta">
                        <p>Category: <a href="https://visibilityspots.github.io/blog/category/cloud.html">cloud</a></p>
                        <p>Tags: <a href="https://visibilityspots.github.io/blog/tag/openstack.html">openstack</a>, <a href="https://visibilityspots.github.io/blog/tag/mtu.html">mtu</a>, <a href="https://visibilityspots.github.io/blog/tag/kilo.html">kilo</a>, <a href="https://visibilityspots.github.io/blog/tag/neutron.html">neutron</a>, <a href="https://visibilityspots.github.io/blog/tag/nova.html">nova</a>, <a href="https://visibilityspots.github.io/blog/tag/config.html">config</a>, <a href="https://visibilityspots.github.io/blog/tag/ovs.html">ovs</a>, </p>
                    </aside>
                    <hr/>
<div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'visibilityspots';
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
                </article>
            </li>
        </ol>
    </div>
        </div>

        <script src="https://visibilityspots.github.io/blog/theme/js/main.js"></script>
        <script src="https://files.stork-search.net/releases/v1.2.1/stork.js"></script>
        <script>
            stork.register("sitesearch", "https://visibilityspots.github.io/blog/search-index.st")
        </script>
    </body>
</html>