<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>    Openstack static ip
</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
            <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/normalize.css">
        <link href='https://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/font-awesome.min.css">
        <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/main.css">
        <link rel="stylesheet" media="screen and (prefers-color-scheme: dark)" href="https://files.stork-search.net/dark.css">

    <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/blog.css">
    <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/github.css">
        <link href="https://visibilityspots.github.io/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="visibilityspots Atom Feed" />
        <link href="https://visibilityspots.github.io/blog/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="visibilityspots RSS Feed" />
        <script src="https://visibilityspots.github.io/blog/theme/js/vendor/modernizr-2.6.2.min.js"></script>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

        <div id="wrapper">
<header id="sidebar" class="side-shadow">
    <hgroup id="site-header">
    <a id="site-title" href="https://visibilityspots.github.io/blog"><h1>visibilityspots <i class="icon-dashboard"></i></h1></a>
        <p id="site-desc"> Linux & Open-Source enthusiast | Scouting | Longboarding </p>
    </hgroup>
    <input data-stork="sitesearch" id="searchbox" type="text" size="12" placeholder="search">
    <div data-stork="sitesearch-output"></div>

    <nav>
        <ul id="nav-links">
                <li><a href="https://visibilityspots.github.io/blog/">Blog</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/profile.html">Profile</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/projects.html">Projects</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/tools.html">Tools</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/contact.html">Contact</a></li>
        </ul>
    </nav>
    Categories:
      <ul>
        <li><a href="https://visibilityspots.github.io/blog/category/android.html">android</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/apple.html">apple</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/automation.html">automation</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/cloud.html">cloud</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/conferences.html">conferences</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/containers.html">containers</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/home-automation.html">home-automation</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/linux.html">linux</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/networking.html">networking</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/other.html">other</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/php.html">php</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/puppet.html">puppet</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/security.html">security</a></li>
      </ul>
<footer id="site-info">
  <a href="http://creativecommons.org/licenses/by-nc/2.0/be/deed.nl">License</a> | 2009 - 2022 <a href="https://visibilityspots.github.io/blog">visibilityspots.github.io/blog</a> | Generated by <a href="http://getpelican.com/" target="pelican">Pelican</a> | Hosted at <a href="https://pages.github.com/" target="github pages">github pages</a> | <a href="https://visibilityspots.github.io/blog/feeds/all.atom.xml" rel="alternate">Atom</a> feed
</footer></header>
    <div id="post-container">
        <ol id="post-list">
            <li>
                <article class="post-entry">
                    <header class="entry-header">
                        <a href="https://visibilityspots.github.io/blog/openstack-static-ip.html" rel="bookmark"><h1>Openstack static ip</h1></a>
<div><p>takes 0 minutes to read</p></div>                        <time class="post-time" datetime="2016-09-05T19:00:00+02:00" pubdate>
                            last modified at Mon 05 September 2016
                        </time>
                    </header>
                    <section class="post-content">
                        <p>last couple of days I have been fighting with the way an static ip is configured on an openstack virtual centos 6 instance. In our specific use case we ditched as many network openstack services as possible as I <a href="https://visibilityspots.github.io/blog/openstack-layer2.html">previously</a> described.</p>
<p>We want to have the instances running in our current network spaces of the R&amp;D department. In this department until some days ago we didn't had any DHCP server running. But a few weeks back we added an extra remote network space into our platform where we configured a remote compute-node.</p>
<p>This is where the issues started popping up.</p>
<p>In openstack when you spin up an instance with a fixed ip, it will basicly create a neutron port for it, attach it to the vm's NIC interface who will get the ip through DHCP. This makes sense since you want to have your basic images as abstract as possible. But since we disabled a lot of the neutron/openstack network logic our vm got an ip address served by an external dhcp service. Which obviously wasn't what we where looking for.</p>
<p>So we digged in the documentation of cloud-init, openstack and network interfaces. Not much has been documented, or at least we couldn't find it easily about the metadata served by a so called configuration drive.</p>
<p>I figured the metadata is attached through either a /dev/vdb disk or a /dev/sr0 cd-rom drive. In the ec2 metadata the local-ip is indicating the static ip address assigned to the created port. After some looking around the possibilities we decided to write a little script which will fetch this information, rewrite the interface configuration and restart the network service to get the static up and running.</p>
<p>The script is located in /usr/local/bin/reconfigure-static-ip-eth0</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>


<span class="k">if</span> <span class="k">$(</span>lsblk -l <span class="p">|</span> grep -q sr0<span class="k">)</span><span class="p">;</span> <span class="k">then</span>
        mount /dev/sr0 /mnt
<span class="k">elif</span> <span class="k">$(</span>lsblk -l <span class="p">|</span> grep -q vdb<span class="k">)</span><span class="p">;</span> <span class="k">then</span>
        mount /dev/vdb /mnt
<span class="k">else</span>
        <span class="nb">echo</span> <span class="s2">&quot;Mountpoint of metadata not found&quot;</span>
        <span class="nb">exit</span> <span class="m">1</span><span class="p">;</span>
<span class="k">fi</span>


splitip <span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> IFS
    <span class="nv">IFS</span><span class="o">=</span>.
    <span class="nb">set</span> -- <span class="nv">$*</span>
    <span class="nv">GATEWAY</span><span class="o">=</span><span class="nv">$GATEWAY</span><span class="s2">&quot;.&quot;</span><span class="nv">$@</span>
<span class="o">}</span>


<span class="nv">STATIC_IP</span><span class="o">=</span><span class="k">$(</span>grep -ri local-ipv4 /mnt/ <span class="p">|</span> tr <span class="s1">&#39;,&#39;</span> <span class="s1">&#39;\n&#39;</span> <span class="p">|</span> head <span class="p">|</span> grep local-ip <span class="p">|</span> awk -F <span class="s1">&#39; &#39;</span> <span class="s1">&#39;{print $2}&#39;</span> <span class="p">|</span> tr -d <span class="s1">&#39;&quot;&#39;</span><span class="k">)</span>
<span class="nv">GATEWAY</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$STATIC_IP</span> <span class="p">|</span> cut -d<span class="s2">&quot;.&quot;</span> -f1-3<span class="sb">`</span><span class="s2">&quot;.1&quot;</span>

<span class="nb">echo</span> <span class="s2">&quot;VLAN=no&quot;</span> &gt; /etc/sysconfig/network-scripts/ifcfg-eth0
<span class="nb">echo</span> <span class="s2">&quot;NOZEROCONF=yes&quot;</span> &gt;&gt; /etc/sysconfig/network-scripts/ifcfg-eth0
<span class="nb">echo</span> <span class="s2">&quot;NETMASK=255.255.255.0&quot;</span> &gt;&gt; /etc/sysconfig/network-scripts/ifcfg-eth0
<span class="nb">echo</span> <span class="s2">&quot;BOOTPROTO=static&quot;</span> &gt;&gt; /etc/sysconfig/network-scripts/ifcfg-eth0
<span class="nb">echo</span> <span class="s2">&quot;USERCTL=no&quot;</span> &gt;&gt; /etc/sysconfig/network-scripts/ifcfg-eth0
<span class="nb">echo</span> <span class="s2">&quot;IPADDR=</span><span class="nv">$STATIC_IP</span><span class="s2">&quot;</span> &gt;&gt; /etc/sysconfig/network-scripts/ifcfg-eth0
<span class="nb">echo</span> <span class="s2">&quot;ONBOOT=yes&quot;</span> &gt;&gt; /etc/sysconfig/network-scripts/ifcfg-eth0
<span class="nb">echo</span> <span class="s2">&quot;GATEWAY=</span><span class="nv">$GATEWAY</span><span class="s2">&quot;</span> &gt;&gt; /etc/sysconfig/network-scripts/ifcfg-eth0
<span class="nb">echo</span> <span class="s2">&quot;DEVICE=eth0&quot;</span> &gt;&gt; /etc/sysconfig/network-scripts/ifcfg-eth0

cat /etc/sysconfig/network-scripts/ifcfg-eth0

/etc/init.d/network restart

umount /mnt
</code></pre></div>

<p>By calling this script through rc.local (/etc/rc.local) it will reconfigure the network interface right after all services are started. In our use case the instance is only used as a hop through different separated network environments so no services are relying on the network interface.</p>
<p>During our little search we couldn't believe we are the only ones hitting against this issue, I do hope others will read this post and comment with more clean ways to do so but this did solved it for us in a rather clean and fast way to go further with the development of the actual products behind those hop through nodes.</p>
                    </section>
                    <hr/>
                    <aside class="post-meta">
                        <p>Category: <a href="https://visibilityspots.github.io/blog/category/cloud.html">cloud</a></p>
                        <p>Tags: <a href="https://visibilityspots.github.io/blog/tag/openstack.html">openstack</a>, <a href="https://visibilityspots.github.io/blog/tag/rdo.html">rdo</a>, <a href="https://visibilityspots.github.io/blog/tag/kilo.html">kilo</a>, <a href="https://visibilityspots.github.io/blog/tag/static.html">static</a>, <a href="https://visibilityspots.github.io/blog/tag/ip.html">ip</a>, <a href="https://visibilityspots.github.io/blog/tag/dhcp.html">dhcp</a>, <a href="https://visibilityspots.github.io/blog/tag/cloud-init.html">cloud-init</a>, <a href="https://visibilityspots.github.io/blog/tag/config.html">config</a>, <a href="https://visibilityspots.github.io/blog/tag/drive.html">drive</a>, <a href="https://visibilityspots.github.io/blog/tag/centos.html">centos</a>, </p>
                    </aside>
                    <hr/>
<div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'visibilityspots';
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
                </article>
            </li>
        </ol>
    </div>
        </div>

        <script src="https://visibilityspots.github.io/blog/theme/js/main.js"></script>
        <script src="https://files.stork-search.net/releases/v1.2.1/stork.js"></script>
        <script>
            stork.register("sitesearch", "https://visibilityspots.github.io/blog/search-index.st")
        </script>
    </body>
</html>