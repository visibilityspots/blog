<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>    Auto deploy webpage using pelican and travis
</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
            <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/normalize.css">
        <link href='https://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/font-awesome.min.css">
        <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/main.css">
	<link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/tipuesearch/tipuesearch.css">

    <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/blog.css">
    <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/github.css">
        <link href="https://visibilityspots.github.io/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="visibilityspots Atom Feed" />
        <link href="https://visibilityspots.github.io/blog/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="visibilityspots RSS Feed" />
        <script src="https://visibilityspots.github.io/blog/theme/js/vendor/modernizr-2.6.2.min.js"></script>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

        <div id="wrapper">
<header id="sidebar" class="side-shadow">
    <hgroup id="site-header">
    <a id="site-title" href="https://visibilityspots.github.io/blog"><h1>visibilityspots <i class="icon-dashboard"></i></h1></a>
        <p id="site-desc"> Linux & Open-Source enthusiast | Scouting | Longboarding </p>
    </hgroup>
    <form id="searchform" action="https://visibilityspots.github.io/blog/search.html" onsubmit="return (this.elements['q'].value.length > 0)">
	        <input id="searchbox" type="text" name="q" size="12" placeholder="search">
    </form>
    <nav>
        <ul id="nav-links">
                <li><a href="https://visibilityspots.github.io/blog/">Blog</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/profile.html">Profile</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/links.html">Links</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/projects.html">Projects</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/tools.html">Tools</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/contact.html">Contact</a></li>
        </ul>
    </nav>
    Categories:
      <ul>
	<li><a href="https://visibilityspots.github.io/blog/category/android.html">android</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/apple.html">apple</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/automation.html">automation</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/cloud.html">cloud</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/conferences.html">conferences</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/containers.html">containers</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/home-automation.html">home-automation</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/linux.html">linux</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/networking.html">networking</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/other.html">other</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/php.html">php</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/puppet.html">puppet</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/security.html">security</a></li>
      </ul>
<footer id="site-info">
  <a href="http://creativecommons.org/licenses/by-nc/2.0/be/deed.nl">License</a> | 2009 - 2021 <a href="https://visibilityspots.github.io/blog">visibilityspots.github.io/blog</a> | Generated by <a href="http://getpelican.com/" target="pelican">Pelican</a> | Hosted at <a href="https://pages.github.com/" target="github pages">github pages</a> | <a href="https://visibilityspots.github.io/blog/feeds/all.atom.xml" rel="alternate">Atom</a> feed
</footer></header>
    <div id="post-container">
        <ol id="post-list">
            <li>
                <article class="post-entry">
                    <header class="entry-header">
                        <a href="https://visibilityspots.github.io/blog/pelican-travis.html" rel="bookmark"><h1>Auto deploy webpage using pelican and travis</h1></a>
<div><p>takes 2 minutes to read</p></div>                        <time class="post-time" datetime="2017-05-21T22:00:00+02:00" pubdate>
                            last modified at Thu 01 June 2017
                        </time>
                    </header>
                    <section class="post-content">
                        <p>many years ago I created my own webpage, it all started with pure, HTML evolved to a wordpress and finally became a <a href="https://blog.getpelican.com/">pelican</a> based setup. It got served on many different hosting providers but since a few years it's running on <a href="../aws-migration.html">S3</a> storage and hosted through cloudfront all over the world.</p>
<p>It's a very fast setup, and once the site has been deployed and every little service has been configured and implemented the only thing I need to do is writing content in <a href="https://daringfireball.net/projects/markdown/">markdown</a> without having to consider how to deploy or how it will look.</p>
<p>In this post I'll try to describe how I configured every service, connected them to each other and automated them through <a href="https://travis-ci.org">travis-ci</a>.</p>
<h1>pelican</h1>
<p>it all starts by initiliazing your pelican framework following the <a href="http://docs.getpelican.com/en/3.6.3/quickstart.html">quickstart</a> guide. Before you proceed you can configure and write some initial content for your webpage locally and see how it will look like without having it published to the world.</p>
<p>You can choose a <a href="http://docs.getpelican.com/en/3.6.3/pelican-themes.html">theme</a> of your choose, adding <a href="http://docs.getpelican.com/en/3.6.3/plugins.html">plugins</a> for various use cases or even <a href="http://docs.getpelican.com/en/3.6.3/importer.html">import</a> an existing  webpage.</p>
<p>Once you have something you want to publish we can proceed to publish it to the world.</p>
<h1>github</h1>
<p>versioning is something very important in my opinion, by doing so you can easily track changes and collaborate with a team on one web project. Also other people can easily propose changes on your website this way through pull requests. Another purpose of using a github repository is the way we could trigger automation which could deploy our project to different hosting providers.</p>
<p>A nice side effect is that you have a backup in the "cloud".</p>
<p>For the different pelican plugins and themes I use <a href="https://git-scm.com/docs/git-submodule">git submodules</a> so I can easily update them with upstream changes.</p>
<h1>AWS</h1>
<p>as I already mentioned I opted for <a href="https://aws.amazon.com/">AWS</a> to host my blog and some other websites I manage. It's easy to deploy, it's fast and rather cheap compared to other providers, I pay about 30 EUR a year for everything, including domain registration, traffic all over the world and storage.</p>
<h2>IAM</h2>
<p>I learned that using dedicated users for every single use case isn't a bad idea. So for this setup we need a dedicated user with pro-grammatic access, which have only full access to S3 and cloudfront only for the distributions we configure. The generated access and secret keys will be used by travis to upload new content to our S3 bucket and invalidate cache. They can be created by following the <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/id_users_create.html">documentation</a></p>
<p>Access for letsencrypt <a href="https://github.com/dlapiduz/certbot-s3front/blob/master/sample-aws-policy.json">policy</a> needs to be granted to the user which will be used to update the blog.</p>
<h2>route53</h2>
<p>Creating your own domain or <a href="http://docs.aws.amazon.com/Route53/latest/DeveloperGuide/MigratingDNS.html">migrating</a> to the DNS service <a href="https://aws.amazon.com/route53/">route53</a> is a very easy way to manage your domain also on amazon. It's easy in the end after all by having one bill for everything.</p>
<p>The only thing I struggled with was the way to update your nameservers after you migrated the domain and made an error in them when migrating. In the route53 configuration pane it can be found in the "Registered domains" tab and not in the hosted zones! Took me some time to figure out the difference between those 2.</p>
<p>Also don't forget to hide your personal data for the different contacts you configured for every registered domain.</p>
<h2>S3</h2>
<p>Amazon <a href="https://aws.amazon.com/s3/">S3</a> object storage service can be used to serve static files and therefore a static <a href="http://docs.aws.amazon.com/AmazonS3/latest/dev/WebsiteHosting.html">webpage</a> we will be using this feature to host our pelican based website on.</p>
<p>I found a great <a href="http://stackoverflow.com/questions/28675620/cloudfront-redirect-www-to-naked-domain-with-ssl">how to</a> on stackoverflow which explains perfectly how you have to create 2 buckets to redirect between www and the naked domain and how to enable https once you have that feature enabled.</p>
<h2>cloudfront</h2>
<p><a href="https://aws.amazon.com/cloudfront/">cloudfront</a> is amazon's own CDN serving your website around the world on different edge locations. It's easy to <a href="http://docs.aws.amazon.com/AmazonS3/latest/dev/website-hosting-custom-domain-walkthrough.html">implement</a> with your static S3 based setup too.</p>
<p>Cloudfront caches your site on the different edge locations, by using <a href="https://renzo.lucioni.xyz/s3-deployment-with-travis/">cache invalidation</a> we can trigger the different locations to update their cache according to the new files when being pushed through travis later on.</p>
<h1>Letsencrypt</h1>
<p><a href="https://letsencrypt.org/">letsencrypt</a> is a free, automated and open Certificate Authority which can be used in combination with S3 using the <a href="https://github.com/dlapiduz/certbot-s3front">certbot-s3front</a> tool to get your site served through https.</p>
<p>I automated this process with a script based in /usr/local/bin/:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1">#</span>
<span class="c1"># renew certificates for X</span>

<span class="nb">export</span> <span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="nb">export</span> <span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

certbot --agree-tos -a certbot-s3front:auth <span class="se">\</span>
--certbot-s3front:auth-s3-bucket BUCKET-NAME <span class="se">\</span>
--certbot-s3front:auth-s3-region REGION <span class="se">\</span>
-i certbot-s3front:installer <span class="se">\</span>
--certbot-s3front:installer-cf-distribution-id CLOUDFRONT-ID <span class="se">\</span>
-d DOMAIN --renew-by-default --text

<span class="k">if</span> <span class="o">[[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    /usr/bin/ntfy -b telegram send <span class="s2">&quot;ERROR | Certificate renewal for DOMAIN has failed on </span><span class="k">$(</span>date<span class="k">)</span><span class="s2">!&quot;</span>
    <span class="nb">exit</span> <span class="m">1</span><span class="p">;</span>
<span class="k">fi</span>

/usr/bin/ntfy -b telegram send <span class="s2">&quot;SUCCESS | Certificates for DOMAIN have been renewed till </span><span class="k">$(</span>date -d <span class="s2">&quot;3 months&quot;</span><span class="k">)</span><span class="s2"> &quot;</span>
</code></pre></div>
</td></tr></table>
<p>It will source the IAM credentials you created for this specific use case, use certbot to renew your certificate on the specified cloudfront distribution and use <a href="http://ntfy.readthedocs.io/en/latest/">ntfy</a> to inform you about it through telegram in this case.</p>
<p>When the renewal fails it will also sent a notification, I didn't had this feature in the past which lead to expiration of the certificate..</p>
<p>It's triggered by cron:</p>
<div class="highlight"><pre><span></span><code><span class="err">0 0 1 */2 * /usr/local/bin/letsencrypt-*</span>
</code></pre></div>

<p>it will be triggered the <a href="https://crontab.guru/#0_0_1_*/2_*">first day every 2 months</a>, I used this sequence so in case of issues I have time enough to solve it before it expires.</p>
<p>Since we now have everything in place and your website should already be available hosted on AWS we can now automate the whole setup. Meaning the only thing you'll have to perform afterwards is writing content and pushing to git.</p>
<h1>Travis</h1>
<p><a href="https://travis-ci.org/">travis</a> is a tool which enables you to easily write automation tasks every time a new commit has been pushed to your repository. Once you've created your account and linked it to github you'll have to enable travis through their GUI on the repositories you want to monitor for automation.</p>
<p>Once you've done that for your <a href="https://github.com/visibilityspots/blog">repository</a> you'll have to configure some credentials and deploy keys. First you'll need the git deploy key, the process is nicely explained by <a href="https://github.com/steveklabnik/automatically_update_github_pages_with_travis_example">Steve Klabnik</a>. That way you'll have a Github token we'll configure in a bit in our .travis.yaml file.</p>
<p>Besides the github token you'll also need to configure the previously created AWS user access and secret keys in travis so travis will be able to update your S3 bucket and invalidates your caches on cloudfront. You'll need to configure those through the GUI of travis on the particular repository as explained by (renzo)[https://renzo.lucioni.xyz/s3-deployment-with-travis/].</p>
<p>Now the most of the administrative part is done a <a href="https://github.com/visibilityspots/blog/blob/master/.travis.yml">.travis.yaml</a> file is needed in your repository which contains a list of steps to be performed by travis every time a new commit will be pushed.</p>
<h2>dependencies</h2>
<p>The travis file I'm referring to is divided in four parts, the first one being the installation of the different python <a href="https://github.com/visibilityspots/blog/blob/master/requirements.txt">dependencies</a> needed to build and deploy our website.</p>
<div class="highlight"><pre><span></span><code><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">r</span> <span class="n">requirements</span><span class="o">.</span><span class="n">txt</span>
</code></pre></div>

<h2>make</h2>
<p>Secondly we rely on the <a href="https://github.com/visibilityspots/blog/blob/master/Makefile">Makefile</a> to first build and deploy the website to github pages and secondly build it for AWS;</p>
<div class="highlight"><pre><span></span><code>$ make clean
$ make github-travis
$ make clean
$ make aws-create
</code></pre></div>

<h2>deployment to AWS</h2>
<p>When the website is prepared for AWS it can be deployed using the built in <a href="https://docs.travis-ci.com/user/deployment/s3/">deploy</a> of travis.</p>
<h2>cache invalidation</h2>
<p>Last but not least is the invalidation of the cache on the different cloudfront edge locations so the updated website is also renewed on those servers.</p>
<div class="highlight"><pre><span></span><code>$ aws configure <span class="nb">set</span> preview.cloudfront <span class="nb">true</span>
$ aws cloudfront create-invalidation --distribution-id <span class="nv">$CLOUDFRONT_DISTRIBUTION_ID</span> --paths <span class="s2">&quot;/*&quot;</span>
</code></pre></div>

<p>The result of your build can be followed on the travis webpage as for example the <a href="https://travis-ci.org/visibilityspots/blog/builds/234608263">build</a> of this page</p>
                    </section>
                    <hr/>
                    <aside class="post-meta">
                        <p>Category: <a href="https://visibilityspots.github.io/blog/category/linux.html">linux</a></p>
                        <p>Tags: <a href="https://visibilityspots.github.io/blog/tag/pelican.html">pelican</a>, <a href="https://visibilityspots.github.io/blog/tag/travis.html">travis</a>, <a href="https://visibilityspots.github.io/blog/tag/ci.html">ci</a>, <a href="https://visibilityspots.github.io/blog/tag/travis-ci.html">travis-ci</a>, <a href="https://visibilityspots.github.io/blog/tag/s3.html">s3</a>, <a href="https://visibilityspots.github.io/blog/tag/github.html">github</a>, <a href="https://visibilityspots.github.io/blog/tag/pages.html">pages</a>, <a href="https://visibilityspots.github.io/blog/tag/static.html">static</a>, </p>
                    </aside>
                    <hr/>
<div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'visibilityspots';
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
                </article>
            </li>
        </ol>
    </div>
        </div>

        <script src="https://visibilityspots.github.io/blog/theme/js/main.js"></script>
    </body>
</html>