<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>    Prometheus export/import
</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
            <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/normalize.css">
        <link href='https://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/font-awesome.min.css">
        <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/main.css">

    <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/blog.css">
    <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/github.css">
        <link href="https://visibilityspots.github.io/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="visibilityspots Atom Feed" />
        <link href="https://visibilityspots.github.io/blog/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="visibilityspots RSS Feed" />
        <script src="https://visibilityspots.github.io/blog/theme/js/vendor/modernizr-2.6.2.min.js"></script>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

        <div id="wrapper">
<header id="sidebar" class="side-shadow">
    <hgroup id="site-header">
    <a id="site-title" href="https://visibilityspots.github.io/blog"><h1>visibilityspots <i class="icon-dashboard"></i></h1></a>
        <p id="site-desc"> Linux & Open-Source enthusiast | Scouting | Longboarding </p>
    </hgroup>

    <nav>
        <ul id="nav-links">
                <li><a href="https://visibilityspots.github.io/blog/">Blog</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/profile.html">Profile</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/projects.html">Projects</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/tools.html">Tools</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/contact.html">Contact</a></li>
        </ul>
    </nav>
    Categories:
      <ul>
        <li><a href="https://visibilityspots.github.io/blog/category/android.html">android</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/apple.html">apple</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/automation.html">automation</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/cloud.html">cloud</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/conferences.html">conferences</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/containers.html">containers</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/home-automation.html">home-automation</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/linux.html">linux</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/networking.html">networking</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/other.html">other</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/php.html">php</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/puppet.html">puppet</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/security.html">security</a></li>
      </ul>
<footer id="site-info">
  <a href="http://creativecommons.org/licenses/by-nc/2.0/be/deed.nl">License</a> | 2009 - 2025 <a href="https://visibilityspots.github.io/blog">visibilityspots.github.io/blog</a> | Generated by <a href="http://getpelican.com/" target="pelican">Pelican</a> | Hosted at <a href="https://pages.github.com/" target="github pages">github pages</a> | <a href="https://visibilityspots.github.io/blog/feeds/all.atom.xml" rel="alternate">Atom</a> feed
</footer></header>
    <div id="post-container">
        <ol id="post-list">
            <li>
                <article class="post-entry">
                    <header class="entry-header">
                        <a href="https://visibilityspots.github.io/blog/prometheus-export-import.html" rel="bookmark"><h1>Prometheus export/import</h1></a>
<div><p>takes 0 minutes to read</p></div>                        <time class="post-time" datetime="2018-06-06T22:00:00+02:00" pubdate>
                            last modified at Mon 11 June 2018
                        </time>
                    </header>
                    <section class="post-content">
                        <p>bumping into the case where once deployed a full stack application we don't have any direct connection due to no uplink for security reasons.</p>
<p>So we (you too <a href="https://twitter.com/TomVanHumbeeck">@Tom</a>) looked into a way to export the prometheus data into a tar.gz which could be transferred and imported into an instance on our local machine.</p>
<p>After the initial blog post where we created a tar.gz file from the prometheus storage.tsdb.path on the filesystem <a href="https://twitter.com/roidelapluie">@roidelapluie</a> pointed me out about the <a href="https://prometheus.io/docs/prometheus/latest/querying/api/#snapshot">snapshot</a> feature.</p>
<p>So we did a bit of research and came up with this new procedure.</p>
<p>First of all make sure the prometheus service is running with the parameter <strong>--web.enable-admin-api</strong> which is disabled by default. For nomad I created a <a href="https://github.com/visibilityspots/nomad-consul-prometheus/blob/master/nomad/prometheus.hcl">job file</a> which enables this parameter through the args for you.</p>
<p>Once you have the prometheus instance running with the admin api enabled you can use this api to create a snapshot:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>curl<span class="w"> </span>-XPOST<span class="w"> </span>http://localhost:9090/api/v1/admin/tsdb/snapshot
<span class="o">{</span><span class="s2">&quot;status&quot;</span>:<span class="s2">&quot;success&quot;</span>,<span class="s2">&quot;data&quot;</span>:<span class="o">{</span><span class="s2">&quot;name&quot;</span>:<span class="s2">&quot;20180611T130634Z-69ffcdcc60b89e54&quot;</span><span class="o">}}</span>
</code></pre></div>

<p>Next up is to collect the snapshot directory on your local machine and mount it into a fresh prometheus docker container for example.</p>
<div class="highlight"><pre><span></span><code><span class="o">(</span>$<span class="w"> </span>docker<span class="w"> </span>container<span class="w"> </span>list<span class="o">)</span>
<span class="o">(</span>CONTAINER<span class="w"> </span>ID<span class="w">  </span>IMAGE<span class="w">          </span>COMMAND<span class="w">                  </span>CREATED<span class="w">          </span>STATUS<span class="w">          </span>PORTS<span class="w">   </span>NAMES<span class="o">)</span>
<span class="o">(</span>e19269f0c82c<span class="w">  </span>cc866859f8df<span class="w">   </span><span class="s2">&quot;/bin/prometheus --câ€¦&quot;</span><span class="w">   </span><span class="m">45</span><span class="w"> </span>minutes<span class="w"> </span>ago<span class="w">   </span>Up<span class="w"> </span><span class="m">45</span><span class="w"> </span>minutes<span class="w">           </span>prometheus-eccbde40-c402-60cf-bee7-04a2e7e77883<span class="o">)</span>
<span class="o">(</span>$<span class="w"> </span>docker<span class="w"> </span>cp<span class="w"> </span>e19269f0c82c:/prometheus/snapshots<span class="w"> </span>/tmp/<span class="o">)</span>

$<span class="w"> </span>docker<span class="w"> </span>run<span class="w"> </span>--rm<span class="w"> </span>-p<span class="w"> </span><span class="m">9090</span>:9090<span class="w"> </span>-uroot<span class="w"> </span>-v<span class="w"> </span>/tmp/snapshots/20180611T130634Z-69ffcdcc60b89e54/:/prometheus<span class="w"> </span>prom/prometheus<span class="w"> </span>--config.file<span class="o">=</span>/etc/prometheus/prometheus.yml<span class="w"> </span>--storage.tsdb.path<span class="o">=</span>/prometheus
</code></pre></div>

<p>When you now go to <a href="http://localhost:9090">http://localhost:9090</a> you have the data available from the snapshot and you could start troubleshooting.</p>
<p>For example by starting a grafana container next to this prometheus container and configuring the prometheus one as data source.</p>
<p>That way you could create some dashboards for readability.</p>
<p>references:
- https://www.nomadproject.io/guides/nomad-metrics.html
- https://www.robustperception.io/taking-snapshots-of-prometheus-data/</p>
                    </section>
                    <hr/>
                    <aside class="post-meta">
                        <p>Category: <a href="https://visibilityspots.github.io/blog/category/containers.html">containers</a></p>
                        <p>Tags: <a href="https://visibilityspots.github.io/blog/tag/prometheus.html">prometheus</a>, <a href="https://visibilityspots.github.io/blog/tag/export.html">export</a>, <a href="https://visibilityspots.github.io/blog/tag/data.html">data</a>, <a href="https://visibilityspots.github.io/blog/tag/import.html">import</a>, <a href="https://visibilityspots.github.io/blog/tag/metrics.html">metrics</a>, <a href="https://visibilityspots.github.io/blog/tag/lock.html">lock</a>, <a href="https://visibilityspots.github.io/blog/tag/waf.html">waf</a>, <a href="https://visibilityspots.github.io/blog/tag/remote.html">remote</a>, </p>
                    </aside>
                    <hr/>
<div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'visibilityspots';
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
                </article>
            </li>
        </ol>
    </div>
        </div>

        <script src="https://visibilityspots.github.io/blog/theme/js/main.js"></script>
    </body>
</html>