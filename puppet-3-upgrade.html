<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>    Upgrade to puppet 3.3.0
</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
            <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/normalize.css">
        <link href='https://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/font-awesome.min.css">
        <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/main.css">
	<link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/tipuesearch/tipuesearch.css">

    <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/blog.css">
    <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/github.css">
        <link href="https://visibilityspots.github.io/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="visibilityspots Atom Feed" />
        <link href="https://visibilityspots.github.io/blog/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="visibilityspots RSS Feed" />
        <script src="https://visibilityspots.github.io/blog/theme/js/vendor/modernizr-2.6.2.min.js"></script>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

        <div id="wrapper">
<header id="sidebar" class="side-shadow">
    <hgroup id="site-header">
    <a id="site-title" href="https://visibilityspots.github.io/blog"><h1>visibilityspots <i class="icon-dashboard"></i></h1></a>
        <p id="site-desc"> Linux & Open-Source enthusiast | Scouting | Longboarding </p>
    </hgroup>
    <form id="searchform" action="https://visibilityspots.github.io/blog/search.html" onsubmit="return (this.elements['q'].value.length > 0)">
	        <input id="searchbox" type="text" name="q" size="12" placeholder="search">
    </form>
    <nav>
        <ul id="nav-links">
                <li><a href="https://visibilityspots.github.io/blog/">Blog</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/profile.html">Profile</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/projects.html">Projects</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/tools.html">Tools</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/contact.html">Contact</a></li>
        </ul>
    </nav>
    Categories:
      <ul>
	<li><a href="https://visibilityspots.github.io/blog/category/android.html">android</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/apple.html">apple</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/automation.html">automation</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/cloud.html">cloud</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/conferences.html">conferences</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/containers.html">containers</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/home-automation.html">home-automation</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/linux.html">linux</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/networking.html">networking</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/other.html">other</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/php.html">php</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/puppet.html">puppet</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/security.html">security</a></li>
      </ul>
<footer id="site-info">
  <a href="http://creativecommons.org/licenses/by-nc/2.0/be/deed.nl">License</a> | 2009 - 2022 <a href="https://visibilityspots.github.io/blog">visibilityspots.github.io/blog</a> | Generated by <a href="http://getpelican.com/" target="pelican">Pelican</a> | Hosted at <a href="https://pages.github.com/" target="github pages">github pages</a> | <a href="https://visibilityspots.github.io/blog/feeds/all.atom.xml" rel="alternate">Atom</a> feed
</footer></header>
    <div id="post-container">
        <ol id="post-list">
            <li>
                <article class="post-entry">
                    <header class="entry-header">
                        <a href="https://visibilityspots.github.io/blog/puppet-3-upgrade.html" rel="bookmark"><h1>Upgrade to puppet 3.3.0</h1></a>
<div><p>takes 1 minute to read</p></div>                        <time class="post-time" datetime="2013-09-20T19:00:00+02:00" pubdate>
                            last modified at Fri 20 September 2013
                        </time>
                    </header>
                    <section class="post-content">
                        <p>I finally got to the point where I upgraded a whole puppet infrastructure from puppet 2.6.x to the last stable version of puppet, <a class="reference external" href="http://docs.puppetlabs.com/puppet/3/reference/release_notes.html">3.3.0</a>. And after finding out the way to go it was surprisingly easy and no big issues came across.</p>
<p>One of the main reasons to upgrade was to start using the latest version of foreman, were we used 0.4, so we can start provisioning our own development vm's with some fancy cloud solution like for example <a class="reference external" href="http://cloudstack.apache.org/">cloudstack</a> using our production puppet tree.</p>
<p>Before the upgrade we had the puppet-client &amp; server (2.6.18), puppetdb (1.4), (ruby 1.8.7) and foreman (0.4.2) running on a CentOS 6.3 machine.</p>
<p>After upgrading we are running puppet-client &amp; server (3.3.0) puppetdb (1.4), ruby (1.8.7) and foreman (1.2) all managed by puppet itself. (feels quite satisfying ;) )</p>
<p>The very fist time I started upgrading the puppet master, but instead of upgrading the puppet-server package from the yum puppetlabs repository I upgraded only the agent.</p>
<p>After I figured that out I could kill myself but ran out of time so needed to stop the process.</p>
<p>The second time I started totally in the wrong direction. I started with foreman, read about needing ruby 1.9.3. So I started looking for a CentOS 6.3 ruby 1.9.3 package.</p>
<p>Didn't find any started compiling it from source, but that came out on a total mess so I reverted my upgrade and postponed it for some days.</p>
<p>The final 3Th time I started in the right order. This order I will describe here:</p>
<p>(Before all those steps, make sure to disable puppet on your clients to have more control during the process)</p>
<div class="section" id="configuring-the-puppetlabs-repository">
<h2>Configuring the puppetlabs repository</h2>
<p>I like to install software from packages, so I started by configuring the <a class="reference external" href="http://docs.puppetlabs.com/guides/puppetlabs_package_repositories.html">puppetlabs</a> repository. I use a puppet-repo module for configuring repo's on our machines but you can quite easy install it from the command line.</p>
<p>This command is executed on a Cent0S 6.3 x86_64 machine:</p>
<pre class="literal-block">
# rpm -ivh http://yum.puppetlabs.com/el/6.0/products/x86_64/puppetlabs-release-6-7.noarch.rpm
</pre>
</div>
<div class="section" id="upgrading-the-puppetmaster">
<h2>Upgrading the puppetmaster</h2>
<p>So after shamelessly updated only the puppet package the first time, this time I did upgrade the puppet-server package without any issue. Be sure to read the <a class="reference external" href="http://docs.puppetlabs.com/guides/upgrading.html">docs</a> first about upgrading!</p>
<pre class="literal-block">
# yum update puppet-server
</pre>
<p>Once the puppetmaster is updated we can try our first puppet runs against the upgraded version.</p>
</div>
<div class="section" id="start-a-native-puppet-master-process-for-testing">
<h2>Start a native puppet master process for testing</h2>
<p>Before I get further in our upgrade process on passenger and stuff I wanted to know if the client is still able to do a puppet run without the passenger setup.</p>
<p>So I had to start the puppetmaster as a daemon, did a local puppet noop run on the master itself and stopped the puppetmaster daemon after I checked the run.</p>
<pre class="literal-block">
# puppet resource service puppetmaster ensure=running enable=true
# puppet agent --test --noop
# puppet resource service puppetmaster ensure=stopped enable=true
</pre>
</div>
<div class="section" id="upgrade-the-passenger-setup">
<h2>Upgrade the passenger setup</h2>
<p>We are using a passenger setup to have our puppet master in a scalable setup. Therefore we also needed to upgrade passenger on our puppetmaster and adopt the puppetmaster vhost to the upgraded environment.</p>
<p>To accomplish this I simply followed the <a class="reference external" href="http://docs.puppetlabs.com/guides/passenger.html">passenger</a> documentation of puppetlabs which was quite easy to follow.</p>
</div>
<div class="section" id="client">
<h2>Client</h2>
<p>Once the puppetmaster was upgraded I tested a puppet run with a still not updated client against the upgraded puppetmaster. It did the job except from sending reports. Since I planned to upgrade the clients too I did not invest time into this issue.</p>
<p>There fore I just upgraded the client itself where the puppetlabs repository already was enabled:</p>
<pre class="literal-block">
# yum update puppet
</pre>
</div>
<div class="section" id="issues">
<h2>Issues</h2>
<ul class="simple">
<li>403: authentication error</li>
</ul>
<p>By running my first 3.3.0 client vs the 3.3.0 master I got an authentication error 403 forbidden request. Did some research on the net, and found about an issue in the puppetmaster's <a class="reference external" href="http://projects.puppetlabs.com/issues/16765">auth.conf</a> file. Once I added this to the file:</p>
<pre class="literal-block">
# allow nodes to retrieve their own node definition
path ~ ^/node/([^/]+)$
method find
allow $1
</pre>
<p>The run did what I had to do configuring the server by using puppet!</p>
<ul class="simple">
<li>undefined method 'symbolize'</li>
</ul>
<p>On some clients I got this error message when trying to run puppet. On <a class="reference external" href="http://somethingsinistral.net/blog/the-angry-guide-to-puppet-3/">somethingsinistral.net</a> I found out it had to see with multiple puppet versions on your machine. By looking into the installed gems (make sure to check also possible rvm environments) and cleaned the ancient ones out I got the puppet run up and running again.</p>
<ul class="simple">
<li>icinga <a class="reference external" href="https://github.com/ripienaar/monitoring-scripts/issues/3">check_puppet</a></li>
</ul>
<p>We are using ripienaar's icinga check_puppet to monitor the puppet functionality. The became all red indicating puppet had too long not ran on the server. In the troubleshooting process I figured out the nagios user which is running the check over the NRPE protocol wasn't able to read the /var/lib/puppet/state/last_run_summary.yaml file. By checking permissions I found out the default settings of the /var/lib/puppet directory are 0750 when installing puppet.</p>
<p>Once I've changed them to 755 all check's became green again!</p>
</div>
<div class="section" id="foreman">
<h2>Foreman</h2>
<p>Once the puppet master was running fine again I also upgraded <a class="reference external" href="http://theforeman.org/manuals/1.2/index.html#3.3InstallFromPackages">theforeman</a> service running on the same machine as the puppetmaster. This went smoothly once I figured out the ruby and rake commands in the documentation must be replaced with ruby193-rake/ruby193-ruby when installed foreman from their repository.</p>
<p>Also do not forget to install foreman-mysql / foreman-sqlite etc when using those extra features.</p>
</div>

                    </section>
                    <hr/>
                    <aside class="post-meta">
                        <p>Category: <a href="https://visibilityspots.github.io/blog/category/puppet.html">puppet</a></p>
                        <p>Tags: <a href="https://visibilityspots.github.io/blog/tag/puppet.html">puppet</a>, <a href="https://visibilityspots.github.io/blog/tag/upgrade.html">upgrade</a>, <a href="https://visibilityspots.github.io/blog/tag/330.html">3.3.0</a>, <a href="https://visibilityspots.github.io/blog/tag/26x.html">2.6.x</a>, <a href="https://visibilityspots.github.io/blog/tag/issues.html">issues</a>, <a href="https://visibilityspots.github.io/blog/tag/foreman.html">foreman</a>, <a href="https://visibilityspots.github.io/blog/tag/passenger.html">passenger</a>, <a href="https://visibilityspots.github.io/blog/tag/puppetdb.html">puppetdb</a>, </p>
                    </aside>
                    <hr/>
<div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'visibilityspots';
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
                </article>
            </li>
        </ol>
    </div>
        </div>

        <script src="https://visibilityspots.github.io/blog/theme/js/main.js"></script>
    </body>
</html>