<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>    Simple monitoring
</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
            <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/normalize.css">
        <link href='https://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/font-awesome.min.css">
        <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/main.css">
	<link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/tipuesearch/tipuesearch.css">

    <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/blog.css">
    <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/github.css">
        <link href="https://visibilityspots.github.io/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="visibilityspots Atom Feed" />
        <link href="https://visibilityspots.github.io/blog/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="visibilityspots RSS Feed" />
        <script src="https://visibilityspots.github.io/blog/theme/js/vendor/modernizr-2.6.2.min.js"></script>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

        <div id="wrapper">
<header id="sidebar" class="side-shadow">
    <hgroup id="site-header">
    <a id="site-title" href="https://visibilityspots.github.io/blog"><h1>visibilityspots <i class="icon-dashboard"></i></h1></a>
        <p id="site-desc"> Linux & Open-Source enthusiast | Scouting | Longboarding </p>
    </hgroup>
    <form id="searchform" action="https://visibilityspots.github.io/blog/search.html" onsubmit="return (this.elements['q'].value.length > 0)">
	        <input id="searchbox" type="text" name="q" size="12" placeholder="search">
    </form>
    <nav>
        <ul id="nav-links">
                <li><a href="https://visibilityspots.github.io/blog/">Blog</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/profile.html">Profile</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/links.html">Links</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/projects.html">Projects</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/tools.html">Tools</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/contact.html">Contact</a></li>
        </ul>
    </nav>
    Categories:
      <ul>
	<li><a href="https://visibilityspots.github.io/blog/category/android.html">android</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/apple.html">apple</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/automation.html">automation</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/cloud.html">cloud</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/conferences.html">conferences</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/containers.html">containers</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/home-automation.html">home-automation</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/linux.html">linux</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/networking.html">networking</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/other.html">other</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/php.html">php</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/puppet.html">puppet</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/security.html">security</a></li>
      </ul>
<footer id="site-info">
  <a href="http://creativecommons.org/licenses/by-nc/2.0/be/deed.nl">License</a> | 2009 - 2021 <a href="https://visibilityspots.github.io/blog">visibilityspots.github.io/blog</a> | Generated by <a href="http://getpelican.com/" target="pelican">Pelican</a> | Hosted at <a href="https://pages.github.com/" target="github pages">github pages</a> | <a href="https://visibilityspots.github.io/blog/feeds/all.atom.xml" rel="alternate">Atom</a> feed
</footer></header>
    <div id="post-container">
        <ol id="post-list">
            <li>
                <article class="post-entry">
                    <header class="entry-header">
                        <a href="https://visibilityspots.github.io/blog/simple-monitoring.html" rel="bookmark"><h1>Simple monitoring</h1></a>
<div><p>takes 1 minute to read</p></div>                        <time class="post-time" datetime="2015-05-26T19:00:00+02:00" pubdate>
                            last modified at Tue 26 May 2015
                        </time>
                    </header>
                    <section class="post-content">
                        <p>As I already wrote about in the past I have a <a href="https://visibilityspots.com/raspberry-pi.html">raspberry pi</a> running at home. I do also have a VPS running somewhere on the interweb for an owncloud instance.</p>
<p>Being a sysadmin I wanted to know when my home devices become unreachable and when the owncloud instance is down. By mail in the first place if possible by sms message for free in the ideal world.</p>
<p>And guess what, I managed to reach the ideal world to monitor my instances. Over here I'll describe how I managed to do so.</p>
<h1>msmtp</h1>
<p>First of all you need to install and configure msmtp</p>
<div class="highlight"><pre><span></span><code>$ sudo pacman -Syu msmtp
</code></pre></div>

<p>The configuration is done in the /etc/msmtprc file, we use <a href="http://telenet.be">telenet</a> as ISP at home so therefore I used their smtp server details:</p>
<div class="highlight"><pre><span></span><code>$ sudo vim /etc/msmtprc
  defaults

  <span class="c1"># A providers service</span>
  account   telenet
  from      yourmailaddress
  host      out.telenet.be

  <span class="c1"># Set a default account</span>
  account default : telenet
</code></pre></div>

<h1>mail-alert</h1>
<p>Next I wrote a bash script which I could pass some parameters so I could use it in many different situations to sent out mails.</p>
<div class="highlight"><pre><span></span><code>$ sudo vim /usr/local/bin/mail-alert
  <span class="c1">#!/bin/bash</span>
  <span class="c1">#</span>
  <span class="c1"># Script which sends out mail using the given params</span>

  <span class="nv">RECIPIENT</span><span class="o">=</span><span class="nv">$1</span>
  <span class="nv">SUBJECT</span><span class="o">=</span><span class="nv">$2</span>
  <span class="nv">MESSAGE</span><span class="o">=</span><span class="nv">$3</span>

  <span class="nb">echo</span> <span class="s2">&quot;To: </span><span class="nv">$RECIPIENT</span><span class="s2">&quot;</span> &gt; .mail
  <span class="nb">echo</span> <span class="s2">&quot;From: youremailaddress&quot;</span> &gt;&gt; .mail
  <span class="nb">echo</span> <span class="s2">&quot;Subject: </span><span class="nv">$SUBJECT</span><span class="s2">&quot;</span> &gt;&gt; .mail
  <span class="nb">echo</span> <span class="s2">&quot;&quot;</span> &gt;&gt; .mail
  <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$MESSAGE</span><span class="s2">&quot;</span> &gt;&gt; .mail
  <span class="nb">echo</span> <span class="s2">&quot;&quot;</span> &gt;&gt; .mail

  cat .mail <span class="p">|</span> msmtp <span class="nv">$RECIPIENT</span>

  rm .mail -rf
</code></pre></div>

<p>This way you can easily sent out mails through the command line and therefore use this command in any of your scripts:</p>
<div class="highlight"><pre><span></span><code>$ mail-alert recipient@domain.eu <span class="s2">&quot;Subject&quot;</span> <span class="s2">&quot;Your actual message&quot;</span>
</code></pre></div>

<h1>monitor-lan</h1>
<p>So now I could actually send out mails through the command line I wrote a little bash script which performs some tests and based on the output triggers the mail-alert command:</p>
<div class="highlight"><pre><span></span><code>$ sudo vim /usr/local/bin/monitor-lan
  <span class="c1">#!/bin/bash</span>
  <span class="nv">HOSTS</span><span class="o">=</span><span class="s2">&quot;8.8.4.4 gateway.ip.address&quot;</span>
  <span class="nv">COUNT</span><span class="o">=</span><span class="m">4</span>
  <span class="nb">echo</span> <span class="s2">&quot;===========================================================&quot;</span> &gt;&gt; /tmp/monitor-lan.log
  <span class="k">for</span> myHost in <span class="nv">$HOSTS</span>
  <span class="k">do</span>
    <span class="nv">count</span><span class="o">=</span><span class="k">$(</span>ping -c <span class="nv">$COUNT</span> <span class="nv">$myHost</span> <span class="p">|</span> grep <span class="s1">&#39;received&#39;</span> <span class="p">|</span> awk -F<span class="s1">&#39;,&#39;</span> <span class="s1">&#39;{ print $2 }&#39;</span> <span class="p">|</span> awk <span class="s1">&#39;{ print $1 }&#39;</span><span class="k">)</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nv">$count</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
      <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$myHost</span><span class="s2"> was down at </span><span class="k">$(</span>date<span class="k">)</span><span class="s2">&quot;</span> &gt;&gt; /tmp/monitor-lan.log
      mail-alert recipient@domain.eu <span class="s2">&quot;</span><span class="nv">$myHost</span><span class="s2"> is down&quot;</span> <span class="s2">&quot;This mail is to inform that host </span><span class="nv">$myHost</span><span class="s2"> is down (ping failed) at </span><span class="k">$(</span>date<span class="k">)</span><span class="s2">&quot;</span>
    <span class="k">else</span>
      <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$myHost</span><span class="s2"> was alright ok at </span><span class="k">$(</span>date<span class="k">)</span><span class="s2">&quot;</span> &gt;&gt; /tmp/monitor-lan.log
    <span class="k">fi</span>
  <span class="k">done</span>
</code></pre></div>

<p>You can easily test this command by adding a non-reachable ip to the $HOSTS array and manually execute the monitor-lan command.</p>
<div class="highlight"><pre><span></span><code>$ monitor-lan
</code></pre></div>

<p>You should know have received a mail confirming the ip is down.</p>
<h1>sms</h1>
<p>As I already proclaimed I wanted this a step further and receive text messages on my cellphone instead of mails. I achieved this functionality using the service <a href="https://ifttt.com/wtf">ifttt</a>. In general it works as follows.</p>
<p>You create yourself an ifttt account and configure the <a href="https://ifttt.com/recipes/294447-sms-alerting-triggerd-by-mail">sms-alerting</a> recipe. Once that's done every mail you sent from the specified mail address using the #hashtag in the subject you configured in the mail channel to trigger@recipe.ifttt.com will trigger an sms to the mobile number you specified in the sms channel.</p>
<p>I used the #alert hashtag and therefore needed to reconfigure the monitor-lan script:</p>
<div class="highlight"><pre><span></span><code>$ vim /usr/local/bin/monitor-lan
  <span class="c1">#!/bin/bash</span>
  <span class="nv">PING_HOSTS</span><span class="o">=</span><span class="s2">&quot;8.8.4.4 gateway.ip.address&quot;</span>
  <span class="nv">COUNT</span><span class="o">=</span><span class="m">4</span>
  <span class="nb">echo</span> <span class="s2">&quot;===========================================================&quot;</span> &gt;&gt; /tmp/monitor-lan.log

  <span class="c1"># Reachable</span>
  <span class="k">for</span> myHost in <span class="nv">$PING_HOSTS</span>
  <span class="k">do</span>
    <span class="nv">count</span><span class="o">=</span><span class="k">$(</span>ping -c <span class="nv">$COUNT</span> <span class="nv">$myHost</span> <span class="p">|</span> grep <span class="s1">&#39;received&#39;</span> <span class="p">|</span> awk -F<span class="s1">&#39;,&#39;</span> <span class="s1">&#39;{ print $2 }&#39;</span> <span class="p">|</span> awk <span class="s1">&#39;{ print $1 }&#39;</span><span class="k">)</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nv">$count</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
      <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$myHost</span><span class="s2"> went down at </span><span class="k">$(</span>date<span class="k">)</span><span class="s2">&quot;</span> &gt;&gt; /tmp/monitor-lan.log
      mail-alert trigger@recipe.ifttt.com <span class="s2">&quot;</span><span class="nv">$myHost</span><span class="s2"> is down #alert&quot;</span> <span class="s2">&quot;</span><span class="nv">$myHost</span><span class="s2"> went down (ping failed) at </span><span class="k">$(</span>date<span class="k">)</span><span class="s2">&quot;</span>
    <span class="k">else</span>
      <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$myHost</span><span class="s2"> was alright at </span><span class="k">$(</span>date<span class="k">)</span><span class="s2">&quot;</span> &gt;&gt; /tmp/monitor-lan.log
    <span class="k">fi</span>
  <span class="k">done</span>
</code></pre></div>

<p>When you now add an unreachable ip and perform a manual test your should see after a while in the recipe log a trigger is been executed and the message should arrive on your mobile.</p>
<h1>remote checks</h1>
<p>Until now we only monitored the reachability of nodes through the icmp protocol. You could also perform more functional tests. Like for example login through ssh to a remote host and see if httpd is running.</p>
<p>Before adding the if statement to your existing monitor-lan script you should configure key based authentication between the pi and your remote host. This can easily been done by using the <a href="http://www.thegeekstuff.com/2008/11/3-steps-to-perform-ssh-login-without-password-using-ssh-keygen-ssh-copy-id/">ssh-copy-id</a> command.</p>
<div class="highlight"><pre><span></span><code>  <span class="k">if</span> <span class="o">[[</span> <span class="k">$(</span>su - username -c <span class="s2">&quot;ssh remote-node &#39;ps aux | grep httpd | grep -v grep | wc -l&#39;&quot;</span><span class="k">)</span> !<span class="o">=</span> <span class="s2">&quot;0&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
      <span class="nb">echo</span> <span class="s2">&quot;httpd was up at </span><span class="k">$(</span>date<span class="k">)</span><span class="s2">&quot;</span> &gt;&gt; /tmp/monitor-lan.log
  <span class="k">else</span>
      <span class="nb">echo</span> <span class="s2">&quot;httpd went down at </span><span class="k">$(</span>date<span class="k">)</span><span class="s2">&quot;</span> &gt;&gt; /tmp/monitor-lan.log
      mail-alert trigger@recipe.ifttt.com <span class="s2">&quot;Owncloud is down #alert&quot;</span> <span class="s2">&quot;Owncloud down (no httpd process running) at </span><span class="k">$(</span>date<span class="k">)</span><span class="s2">&quot;</span>
  <span class="k">fi</span>
</code></pre></div>

<h1>cron</h1>
<p>Now everything is functional and in place you can configure a scheduled cronjob for it as root.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># crontab -e</span>
  <span class="c1"># Monitor LAN</span>
  */15 * * * * /usr/local/bin/monitor-lan
</code></pre></div>

<p>You have now a rather easy peasy monitoring setup up and running which provides your the most basic monitoring for your different systems totally for free!</p>
                    </section>
                    <hr/>
                    <aside class="post-meta">
                        <p>Category: <a href="https://visibilityspots.github.io/blog/category/linux.html">linux</a></p>
                        <p>Tags: <a href="https://visibilityspots.github.io/blog/tag/monitoring.html">monitoring</a>, <a href="https://visibilityspots.github.io/blog/tag/sms.html">sms</a>, <a href="https://visibilityspots.github.io/blog/tag/mail.html">mail</a>, <a href="https://visibilityspots.github.io/blog/tag/ifttt.html">ifttt</a>, <a href="https://visibilityspots.github.io/blog/tag/raspberry.html">raspberry</a>, <a href="https://visibilityspots.github.io/blog/tag/monitor.html">monitor</a>, <a href="https://visibilityspots.github.io/blog/tag/ping.html">ping</a>, </p>
                    </aside>
                    <hr/>
<div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'visibilityspots';
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
                </article>
            </li>
        </ol>
    </div>
        </div>

        <script src="https://visibilityspots.github.io/blog/theme/js/main.js"></script>
    </body>
</html>