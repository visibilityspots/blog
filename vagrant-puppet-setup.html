<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>    Vagrant puppet setup
</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
            <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/normalize.css">
        <link href='https://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/font-awesome.min.css">
        <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/main.css">
        <link rel="stylesheet" media="screen and (prefers-color-scheme: dark)" href="https://files.stork-search.net/dark.css">

    <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/blog.css">
    <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/github.css">
        <link href="https://visibilityspots.github.io/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="visibilityspots Atom Feed" />
        <link href="https://visibilityspots.github.io/blog/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="visibilityspots RSS Feed" />
        <script src="https://visibilityspots.github.io/blog/theme/js/vendor/modernizr-2.6.2.min.js"></script>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

        <div id="wrapper">
<header id="sidebar" class="side-shadow">
    <hgroup id="site-header">
    <a id="site-title" href="https://visibilityspots.github.io/blog"><h1>visibilityspots <i class="icon-dashboard"></i></h1></a>
        <p id="site-desc"> Linux & Open-Source enthusiast | Scouting | Longboarding </p>
    </hgroup>
    <input data-stork="sitesearch" id="searchbox" type="text" size="12" placeholder="search">
    <div data-stork="sitesearch-output"></div>

    <nav>
        <ul id="nav-links">
                <li><a href="https://visibilityspots.github.io/blog/">Blog</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/profile.html">Profile</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/projects.html">Projects</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/tools.html">Tools</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/contact.html">Contact</a></li>
        </ul>
    </nav>
    Categories:
      <ul>
        <li><a href="https://visibilityspots.github.io/blog/category/android.html">android</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/apple.html">apple</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/automation.html">automation</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/cloud.html">cloud</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/conferences.html">conferences</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/containers.html">containers</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/home-automation.html">home-automation</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/linux.html">linux</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/networking.html">networking</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/other.html">other</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/php.html">php</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/puppet.html">puppet</a></li>
        <li><a href="https://visibilityspots.github.io/blog/category/security.html">security</a></li>
      </ul>
<footer id="site-info">
  <a href="http://creativecommons.org/licenses/by-nc/2.0/be/deed.nl">License</a> | 2009 - 2022 <a href="https://visibilityspots.github.io/blog">visibilityspots.github.io/blog</a> | Generated by <a href="http://getpelican.com/" target="pelican">Pelican</a> | Hosted at <a href="https://pages.github.com/" target="github pages">github pages</a> | <a href="https://visibilityspots.github.io/blog/feeds/all.atom.xml" rel="alternate">Atom</a> feed
</footer></header>
    <div id="post-container">
        <ol id="post-list">
            <li>
                <article class="post-entry">
                    <header class="entry-header">
                        <a href="https://visibilityspots.github.io/blog/vagrant-puppet-setup.html" rel="bookmark"><h1>Vagrant puppet setup</h1></a>
<div><p>takes 1 minute to read</p></div>                        <time class="post-time" datetime="2015-10-10T23:00:00+02:00" pubdate>
                            last modified at Sat 10 October 2015
                        </time>
                    </header>
                    <section class="post-content">
                        <p>We at <a href="https://inuits.eu">Inuits</a> are using vagrant for a lot of use cases, neither you are a developer or a sysadmin you for sure will walk into it. Me, myself I do use it merely to automate the many different use cases asked by various projects. It took some time to get myself organized with this pretty nifty piece of software.</p>
<p>In the beginning I used it with the default virtualization provider <a href="https://virtualbox.org">virtualbox</a> later on I switched to <a href="https://visibilityspots.github.io/blog/vagrant-setup.html">lxc</a> containers instead. By using those containers I already gained on performance. Spinning up and down new containers to test if an application is deployed fully automatically got 2 times as fast as when using vm's.</p>
<p>But what I struggled with the most where the many different projects. Each time a new piece of software needed to be automated I copied over the puppet base I used the previous time. Which lead to outdated setups for older projects, many duplicate code over and over again. When updating base modules for both the puppet agent as the puppetmaster previous projects got forgotten..</p>
<p>So I tried to figure out a way I could keep them all up to date with the same code base. We are using <a href="https://git.org">git</a> for almost all our projects as our versioning platform. So I figured out I could use the features of git to achieve the goals I've setted for my setup. One code base I could update without interrupting the functionality of the different proof of concepts but with the availability of upgrading those in a easy way.</p>
<p>So I started my <a href="https://github.com/visibilityspots/vagrant-puppet.git">vagrant-puppet</a> project on github. In the master branch a base setup has been configured with a puppetmaster container and a client container. Both are running the latest stable release of puppet 3.x. The puppetmaster is setted up using puppetdb puppetserver or apache/passenger it can be used both with the <a href="https://atlas.hashicorp.com/visibilityspots/boxes/centos-6.x-puppet-3.x">centos6</a> or <a href="https://atlas.hashicorp.com/visibilityspots/boxes/centos-7.x-puppet-3.x">centos7</a> containers I crafted using the <a href="https://github.com/visibilityspots/vagrant-lxc-base-boxes">lxc-base-boxes</a> repository.</p>
<h1>puppet</h1>
<p>to automate the different pieces of software we do use puppet, if upstream puppet-modules are available I pull those in through git submodules if not I write my own.</p>
<p>By using the vagrant rsync functionality I could write my module and hiera data in my own preferred environment since they are synced to the running puppetmaster through rsync.</p>
<p>This syncronisation can be achieved in two ways. Manually:</p>
<div class="highlight"><pre><span></span><code>$ vagrant rsync
</code></pre></div>

<p>Or setting up a daemon:</p>
<div class="highlight"><pre><span></span><code>$ vagrant rsync-auto
</code></pre></div>

<p>That way changes you made through your local environment are synced into the puppetmaster container.</p>
<h1>upgrade</h1>
<h2>submodules - upstream puppet modules</h2>
<p>Every once in a while when a new version of puppet has been released I try to keep my container vagrant boxes up to date. Once those are upgraded I get myself into to master branch and update all the used git submodules with this one liner:</p>
<div class="highlight"><pre><span></span><code>$ git submodule foreach git pull origin master
</code></pre></div>

<p>This way the latest released version of the different used upstream puppet module repositories are fetched into the master branch.</p>
<p>And try to provision my puppetmaster from scratch, depending on the changes been done in the different puppet modules I need to adopt my <a href="https://github.com/visibilityspots/vagrant-puppet/tree/master/hieradata">hieradata</a>. By looking into the hieradata you could see I'm using the puppet roles and profiles principle. With one simple trick in the <a href="https://github.com/visibilityspots/vagrant-puppet/blob/master/puppet/environments/production/manifests/site.pp">site.pp</a> pointed out by <a href="https://twitter.com/PeetersSimon">one</a> of my colleagues I created a role based hierarchy in my hieradata. Based on the role fact given in the node hiera data the parameters needed to get the functionality of the role configured are fetched from the role's hieradata.</p>
<p>By doing so the hiera data of a particular role can be easily reused without having to keep them in sync on every node who needs the same role.</p>
<p>I still need to figure out a way I can achieve the same behavior based on profiles data.</p>
<p>This way my master branch keeps staying in sync with the latest releases on the different puppet tools.</p>
<h2>different projects, different branches</h2>
<p>But I wanted to go a step further, by getting all my different projects in one place to ease the maintainability of them. So I started tinkering about it. The first idea consisted of having them all in one environment like it would be the case in the real world.</p>
<p>But this has a big disadvantage. It would be a mess in the future when a lot of such proof of concepts are combined in one puppet environment. Also an unneeded level of complexity would been added if you want to show of one particular project to a customer or an interested fellow through the interweb.</p>
<p>It looked for me this was the perfect use case for branches. Every branch created from the master branch already got a working puppetmaster client setup and can easily be upgraded by merging the master branch into it when upgrades are released.</p>
<p>By checking out a branch a subset of different submodules can be loaded after the previous ones are cleaned up:</p>
<div class="highlight"><pre><span></span><code>$ git checkout feature_branch
$ git clean -d -f -f
$ git submodule update --init --recursive
</code></pre></div>

<p>This way the specific puppet modules for a specific projects are loaded with a known working version. When merging from the upgraded master branch the submodules are updated to.</p>
<h2>merging master branch</h2>
<p>when the master branch has been upgraded I now can easily merge those updates into the different feature branches:</p>
<div class="highlight"><pre><span></span><code>$ git checkout feature_branch
$ git clean -d -f -f
$ git merge origin/master
$ git submodule update --init --recursive
$ vagrant up puppetmaster --provider<span class="o">=</span>lxc
$ vagrant up node --provider<span class="o">=</span>lxc
</code></pre></div>

<p>By configuring this setup I know have a flexible environment to test deploy and write new puppet code when some piece of software needs to be automated on my local machine with a puppetmaster almost simultaneous to a production one.</p>
                    </section>
                    <hr/>
                    <aside class="post-meta">
                        <p>Category: <a href="https://visibilityspots.github.io/blog/category/puppet.html">puppet</a></p>
                        <p>Tags: <a href="https://visibilityspots.github.io/blog/tag/vagrant.html">vagrant</a>, <a href="https://visibilityspots.github.io/blog/tag/rsync.html">rsync</a>, <a href="https://visibilityspots.github.io/blog/tag/puppetmaster.html">puppetmaster</a>, <a href="https://visibilityspots.github.io/blog/tag/puppetserver.html">puppetserver</a>, <a href="https://visibilityspots.github.io/blog/tag/development.html">development</a>, <a href="https://visibilityspots.github.io/blog/tag/setup.html">setup</a>, </p>
                    </aside>
                    <hr/>
<div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'visibilityspots';
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
                </article>
            </li>
        </ol>
    </div>
        </div>

        <script src="https://visibilityspots.github.io/blog/theme/js/main.js"></script>
        <script src="https://files.stork-search.net/releases/v1.2.1/stork.js"></script>
        <script>
            stork.register("sitesearch", "https://visibilityspots.github.io/blog/search-index.st")
        </script>
    </body>
</html>