<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>    Openstack vlan based flat neutron network provider
</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
            <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/normalize.css">
        <link href='https://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/font-awesome.min.css">
        <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/main.css">
	<link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/tipuesearch/tipuesearch.css">

    <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/blog.css">
    <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/github.css">
        <link href="https://visibilityspots.github.io/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="visibilityspots Atom Feed" />
        <link href="https://visibilityspots.github.io/blog/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="visibilityspots RSS Feed" />
        <script src="https://visibilityspots.github.io/blog/theme/js/vendor/modernizr-2.6.2.min.js"></script>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

        <div id="wrapper">
<header id="sidebar" class="side-shadow">
    <hgroup id="site-header">
    <a id="site-title" href="https://visibilityspots.github.io/blog"><h1>visibilityspots <i class="icon-dashboard"></i></h1></a>
        <p id="site-desc"> Linux & Open-Source enthusiast | Scouting | Longboarding </p>
    </hgroup>
    <form id="searchform" action="https://visibilityspots.github.io/blog/search.html" onsubmit="return (this.elements['q'].value.length > 0)">
	        <input id="searchbox" type="text" name="q" size="12" placeholder="search">
    </form>
    <nav>
        <ul id="nav-links">
                <li><a href="https://visibilityspots.github.io/blog/">Blog</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/profile.html">Profile</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/projects.html">Projects</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/tools.html">Tools</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/contact.html">Contact</a></li>
        </ul>
    </nav>
    Categories:
      <ul>
	<li><a href="https://visibilityspots.github.io/blog/category/android.html">android</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/apple.html">apple</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/automation.html">automation</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/cloud.html">cloud</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/conferences.html">conferences</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/containers.html">containers</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/home-automation.html">home-automation</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/linux.html">linux</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/networking.html">networking</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/other.html">other</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/php.html">php</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/puppet.html">puppet</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/security.html">security</a></li>
      </ul>
<footer id="site-info">
  <a href="http://creativecommons.org/licenses/by-nc/2.0/be/deed.nl">License</a> | 2009 - 2021 <a href="https://visibilityspots.github.io/blog">visibilityspots.github.io/blog</a> | Generated by <a href="http://getpelican.com/" target="pelican">Pelican</a> | Hosted at <a href="https://pages.github.com/" target="github pages">github pages</a> | <a href="https://visibilityspots.github.io/blog/feeds/all.atom.xml" rel="alternate">Atom</a> feed
</footer></header>
    <div id="post-container">
        <ol id="post-list">
            <li>
                <article class="post-entry">
                    <header class="entry-header">
                        <a href="https://visibilityspots.github.io/blog/vlan-flat-neutron-provider.html" rel="bookmark"><h1>Openstack vlan based flat neutron network provider</h1></a>
<div><p>takes 1 minute to read</p></div>                        <time class="post-time" datetime="2015-09-29T19:00:00+02:00" pubdate>
                            last modified at Fri 02 October 2015
                        </time>
                    </header>
                    <section class="post-content">
                        <p>at one of my projects I was been asked to set up a private cloud for a validation platform. The whole idea behind this proof of concept is based on the flexibility to spin up and down certain instances providing some specific functionality so tests banks can be ran against them.</p>
<p>As soon as the tests are finished the machines could be terminated. Those instances should be configured using some configuration management software, like <a href="https://puppetlabs.com/puppet/puppet-open-source">puppet</a>. That way the instances are rebuildable and could be treated as cattle.</p>
<p>On the other hand, it takes about 20 minutes to build up an instance from scratch, centos minimal with a puppet run to install and configure the whole needed stack. So we looked for a workable way to spin up instances really quick without the waiting time of 20 minutes every time.</p>
<p>We found a workable solution with <a href="https://packer.io">packer</a>. By configuring a template which describes a series of steps needed to be executed to get a fully working instance based on a centos minimal cloud instance, we could provide an easy and reusable way to build our artifacts.</p>
<p>When running the packer command an openstack instance is launched based on a <a href="http://cloud.centos.org/centos/">centos cloud</a> image. Packer will use rsync to upload some needed data directories, in our case a puppet environment. Once this step has been done a local puppet apply will be performed based on the previously uploaded puppet environment. As soon as this puppet run has been successfully executed an image will be created an immediately be uploaded to your openstack instance.</p>
<p>By using <a href="https://vagrantup.com">vagrant</a> you could easily write your puppet code first and test it against a local vm based on <a href="https://virtualbox.org">virtualbox</a> or <a href="https://github.com/fgrehm/vagrant-lxc">lxc</a> containers. Once you know your puppet manifests are working on a local vm you could test it on an openstack instance using the <a href="https://github.com/ggiamarchi/vagrant-openstack-provider">vagrant-openstack</a> provider. That way you could filter out some unforeseen issues without the need of running packer over and over again.</p>
<p>When your vagrant-openstack based instance is deployed fine packer is used to build an image of your specific device.</p>
<p>By spinning up an instance based on this crafted image you could gain like about 18 minutes every time you launch one since it takes about less than 2 minutes to get it up and running fully functional!</p>
<h1>Openstack</h1>
<p>We used the RDO <a href="https://www.rdoproject.org/Quickstart">all-in-one</a> installer to get an openstack up and running on one physical machine rather quickly (15-30 minutes for the initial services).</p>
<p>To set openstack up without the demo data:</p>
<div class="highlight"><pre><span></span><code># packstack --allinone --provision-demo=n
</code></pre></div>

<p>This openstack instance is based on <a href="https://www.centos.org/download/">CentOS 7 minimal</a> since it's a requirement of the used openstack release <a href="https://wiki.openstack.org/wiki/ReleaseNotes/Kilo">kilo</a>.</p>
<h2>networking</h2>
<p>in our case we wanted some different networking setup as from the default one with natting. Instead we wanted a <a href="https://trickycloud.wordpress.com/2013/11/12/setting-up-a-flat-network-with-neutron/">flat</a> network provider so our instances have an ip within the same range as our development network. That way the natting could be kicked out of the setup to exclude some possible networking performance.</p>
<p>Beside this flat network we do use vlan's too, so the openstack instance should be able to route over those vlan's too. We found a similar setup on the <a href="http://www.s3it.uzh.ch/blog/openstack-neutron-vlan/">blog</a> of the University of Zurich. But it lacked an underlying physical network configuration example on the all-in-one node itself.</p>
<p>On opencloudblog a clear <a href="http://www.opencloudblog.com/?p=460">article</a> helped in trying to understand the network philosophy used to get it working.</p>
<h3>manual network configuration</h3>
<p>creating the vlan bridge which is used by openstack to communicate with the physical vlan based networking switch:</p>
<div class="highlight"><pre><span></span><code>ovs-vsctl add-br br-vlan
ovs-vsctl add-port br-vlan eth0
vconfig add br-vlan <span class="m">100</span>
</code></pre></div>

<p>configuring an ip from the development range to an interface on the node so we have access to it:</p>
<div class="highlight"><pre><span></span><code>ip link <span class="nb">set</span> br-vlan up
ip link <span class="nb">set</span> br-vlan.100 up
ip address add dev br-vlan.100 <span class="m">192</span>.168.0.100 netmask <span class="m">255</span>.255.255.0
ip route add default via <span class="m">192</span>.168.0.1
</code></pre></div>

<p>configuring openstack ml2 plugin with our vlan setup:</p>
<p>/etc/neutron/neutron.conf</p>
<div class="highlight"><pre><span></span><code><span class="nv">core_plugin</span> <span class="o">=</span>neutron.plugins.ml2.plugin.Ml2Plugin
</code></pre></div>

<p>Configuring the actual vlan's:</p>
<p>/etc/neutron/plugins/ml2/ml2_conf.ini</p>
<div class="highlight"><pre><span></span><code><span class="nv">type_drivers</span> <span class="o">=</span> vxlan,gre,vlan
<span class="nv">network_vlan_ranges</span> <span class="o">=</span> vlan100:100:100
</code></pre></div>

<p>Creating the mapping between the vlan and the actual physical interface:</p>
<p>/etc/neutron/plugins/openvswitch/ovs_neutron_plugin.ini</p>
<div class="highlight"><pre><span></span><code><span class="nv">bridge_mappings</span> <span class="o">=</span> vlan100:br-vlan
</code></pre></div>

<p>to get the metadata service usable on this flat network:</p>
<p>/etc/neutron/dhcp-agent.ini</p>
<div class="highlight"><pre><span></span><code><span class="nv">enable_isolated_metadata</span> <span class="o">=</span> True
</code></pre></div>

<p>restarting neutron-dhcp-agent</p>
<div class="highlight"><pre><span></span><code># openstack-service status neutron-dhcp-agent
</code></pre></div>

<p>Configuring the openstack networks on the all-in-one machine:</p>
<div class="highlight"><pre><span></span><code># <span class="nv">source</span> <span class="nv">keystonerc_admin</span>
# <span class="nv">neutron</span> <span class="nv">subnet</span><span class="o">-</span><span class="nv">list</span>
# <span class="nv">neutron</span> <span class="nv">subnet</span><span class="o">-</span><span class="nv">delete</span> <span class="nv">ID</span>
# <span class="nv">neutron</span> <span class="nv">net</span><span class="o">-</span><span class="nv">list</span>
# <span class="nv">neutron</span> <span class="nv">net</span><span class="o">-</span><span class="nv">delete</span> <span class="nv">ID</span>
# <span class="nv">neutron</span> <span class="nv">net</span><span class="o">-</span><span class="nv">create</span> <span class="nv">vlan100</span> <span class="o">--</span><span class="nv">shared</span> <span class="o">--</span><span class="nv">provider</span>:<span class="nv">network_type</span> <span class="nv">vlan</span> <span class="o">--</span><span class="nv">provider</span>:<span class="nv">segmentation_id</span> <span class="mi">100</span> <span class="o">--</span><span class="nv">provider</span>:<span class="nv">physical_network</span> <span class="nv">vlan100</span> <span class="o">--</span><span class="nv">router</span>:<span class="nv">external</span>
# <span class="nv">neutron</span> <span class="nv">subnet</span><span class="o">-</span><span class="nv">create</span> <span class="o">--</span><span class="nv">name</span> <span class="nv">vlan100</span> <span class="o">--</span><span class="nv">gateway</span> <span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">0</span>.<span class="mi">1</span> <span class="o">--</span><span class="nv">allocation</span><span class="o">-</span><span class="nv">pool</span> <span class="nv">start</span><span class="o">=</span><span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">0</span>.<span class="mi">150</span>,<span class="k">end</span><span class="o">=</span><span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">0</span>.<span class="mi">200</span> <span class="o">--</span><span class="nv">enable</span><span class="o">-</span><span class="nv">dhcp</span> <span class="o">--</span><span class="nv">dns</span><span class="o">-</span><span class="nv">nameserver</span> <span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">0</span>.<span class="mi">1</span> <span class="nv">vlan100</span> <span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">0</span>.<span class="mi">0</span><span class="o">/</span><span class="mi">24</span>
# <span class="nv">neutron</span> <span class="nv">subnet</span><span class="o">-</span><span class="nv">update</span> <span class="o">--</span><span class="nv">host</span><span class="o">-</span><span class="nv">route</span> <span class="nv">destination</span><span class="o">=</span><span class="mi">169</span>.<span class="mi">254</span>.<span class="mi">169</span>.<span class="mi">254</span><span class="o">/</span><span class="mi">32</span>,<span class="nv">nexthop</span><span class="o">=</span><span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">0</span>.<span class="mi">151</span> <span class="nv">vlan100</span>
</code></pre></div>

<p>We do have a working setup right now if everything went well and you should be able to <a href="https://www.rdoproject.org/Running_an_instance">launch</a> an instance. To test ICMP traffic do not forget to enable a security group which allows this kind of traffic. Otherwise you couldn't use ping to test traffic.</p>
<p>Some useful commands:</p>
<div class="highlight"><pre><span></span><code>ovs-vsctl show <span class="c1">#shows the openvswitch configuration</span>
ovs-ofctl dump-flows br-int <span class="c1">#shows the flows to map an internal project tag to an actual vlan id</span>
brctl show <span class="c1">#shows the linux bridge</span>
</code></pre></div>

<h3>persistent network configuration</h3>
<p>To keep your networking up and running after a reboot you should configure you bridges natively on the all-in-one instance:</p>
<p>/etc/sysconfig/network-scripts/ifcfg-eth0</p>
<div class="highlight"><pre><span></span><code><span class="nv">DEVICE</span><span class="o">=</span><span class="s2">&quot;eth0&quot;</span>
<span class="nv">ONBOOT</span><span class="o">=</span>yes
<span class="nv">OVS_BRIDGE</span><span class="o">=</span>br-vlan
<span class="nv">TYPE</span><span class="o">=</span>OVSPort
<span class="nv">DEVICETYPE</span><span class="o">=</span><span class="s2">&quot;ovs&quot;</span>
</code></pre></div>

<p>/etc/sysconfig/network-scripts/ifcfg-br-vlan</p>
<div class="highlight"><pre><span></span><code><span class="nv">DEVICE</span><span class="o">=</span>br-vlan
<span class="nv">BOOTPROTO</span><span class="o">=</span>none
<span class="nv">ONBOOT</span><span class="o">=</span>yes
<span class="nv">TYPE</span><span class="o">=</span>OVSBridge
<span class="nv">DEVICETYPE</span><span class="o">=</span><span class="s2">&quot;ovs&quot;</span>
</code></pre></div>

<p>/etc/sysconfig/network-scripts/ifcfg-br-vlan.100</p>
<div class="highlight"><pre><span></span><code><span class="nv">BOOTPROTO</span><span class="o">=</span><span class="s2">&quot;none&quot;</span>
<span class="nv">DEVICE</span><span class="o">=</span><span class="s2">&quot;br-vlan.100&quot;</span>
<span class="nv">ONBOOT</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>
<span class="nv">IPADDR</span><span class="o">=</span><span class="s2">&quot;192.168.0.100&quot;</span>
<span class="nv">PREFIX</span><span class="o">=</span><span class="s2">&quot;24&quot;</span>
<span class="nv">GATEWAY</span><span class="o">=</span><span class="s2">&quot;192.168.0.1&quot;</span>
<span class="nv">DNS1</span><span class="o">=</span><span class="s2">&quot;192.168.0.1&quot;</span>
<span class="nv">VLAN</span><span class="o">=</span>yes
<span class="nv">NOZEROCONF</span><span class="o">=</span>yes
<span class="nv">USERCTL</span><span class="o">=</span>no
</code></pre></div>

<p>Be sure to use the OVSBridge type and ovs DEVICETYPES otherwise it will not work..</p>
<p>Something we have on our todo is the <a href="http://docs.openstack.org/user-guide/cli_config_drive.html">configuration drive</a> setup. When using a configuration drive the metadata dhcp service could also be skipped and therefore possibly the whole openvswitch configuration could be passed by only using a provider network with a <a href="http://docs.openstack.org/networking-guide/deploy_scenario4b.html">linux bridge</a></p>
<p><a href="http://serverspec.org/">serverspec</a> were also written so the functionality of the puppet managed services are tested easily over and over to be sure the code is actually doing as it supposed to do.</p>
                    </section>
                    <hr/>
                    <aside class="post-meta">
                        <p>Category: <a href="https://visibilityspots.github.io/blog/category/cloud.html">cloud</a></p>
                        <p>Tags: <a href="https://visibilityspots.github.io/blog/tag/vlan.html">vlan</a>, <a href="https://visibilityspots.github.io/blog/tag/flat.html">flat</a>, <a href="https://visibilityspots.github.io/blog/tag/neutron.html">neutron</a>, <a href="https://visibilityspots.github.io/blog/tag/provider.html">provider</a>, <a href="https://visibilityspots.github.io/blog/tag/network.html">network</a>, <a href="https://visibilityspots.github.io/blog/tag/openstack.html">openstack</a>, <a href="https://visibilityspots.github.io/blog/tag/openvswitch.html">openvswitch</a>, <a href="https://visibilityspots.github.io/blog/tag/ovs.html">ovs</a>, </p>
                    </aside>
                    <hr/>
<div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'visibilityspots';
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
                </article>
            </li>
        </ol>
    </div>
        </div>

        <script src="https://visibilityspots.github.io/blog/theme/js/main.js"></script>
    </body>
</html>