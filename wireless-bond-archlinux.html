<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>    wireless bond archlinux arm
</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
            <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/normalize.css">
        <link href='https://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/font-awesome.min.css">
        <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/main.css">
	<link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/tipuesearch/tipuesearch.css">

    <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/blog.css">
    <link rel="stylesheet" href="https://visibilityspots.github.io/blog/theme/css/github.css">
        <link href="https://visibilityspots.github.io/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="visibilityspots Atom Feed" />
        <link href="https://visibilityspots.github.io/blog/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="visibilityspots RSS Feed" />
        <script src="https://visibilityspots.github.io/blog/theme/js/vendor/modernizr-2.6.2.min.js"></script>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

        <div id="wrapper">
<header id="sidebar" class="side-shadow">
    <hgroup id="site-header">
    <a id="site-title" href="https://visibilityspots.github.io/blog"><h1>visibilityspots <i class="icon-dashboard"></i></h1></a>
        <p id="site-desc"> Linux & Open-Source enthusiast | Scouting | Longboarding </p>
    </hgroup>
    <form id="searchform" action="https://visibilityspots.github.io/blog/search.html" onsubmit="return (this.elements['q'].value.length > 0)">
	        <input id="searchbox" type="text" name="q" size="12" placeholder="search">
    </form>
    <nav>
        <ul id="nav-links">
                <li><a href="https://visibilityspots.github.io/blog/">Blog</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/profile.html">Profile</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/links.html">Links</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/projects.html">Projects</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/tools.html">Tools</a></li>
                <li><a href="https://visibilityspots.github.io/blog/pages/contact.html">Contact</a></li>
        </ul>
    </nav>
    Categories:
      <ul>
	<li><a href="https://visibilityspots.github.io/blog/category/android.html">android</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/apple.html">apple</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/automation.html">automation</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/cloud.html">cloud</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/conferences.html">conferences</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/containers.html">containers</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/home-automation.html">home-automation</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/linux.html">linux</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/networking.html">networking</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/other.html">other</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/php.html">php</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/puppet.html">puppet</a></li>
	<li><a href="https://visibilityspots.github.io/blog/category/security.html">security</a></li>
      </ul>
<footer id="site-info">
  <a href="http://creativecommons.org/licenses/by-nc/2.0/be/deed.nl">License</a> | 2009 - 2021 <a href="https://visibilityspots.github.io/blog">visibilityspots.github.io/blog</a> | Generated by <a href="http://getpelican.com/" target="pelican">Pelican</a> | Hosted at <a href="https://pages.github.com/" target="github pages">github pages</a> | <a href="https://visibilityspots.github.io/blog/feeds/all.atom.xml" rel="alternate">Atom</a> feed
</footer></header>
    <div id="post-container">
        <ol id="post-list">
            <li>
                <article class="post-entry">
                    <header class="entry-header">
                        <a href="https://visibilityspots.github.io/blog/wireless-bond-archlinux.html" rel="bookmark"><h1>wireless bond archlinux arm</h1></a>
<div><p>takes 1 minute to read</p></div>                        <time class="post-time" datetime="2016-10-17T21:00:00+02:00" pubdate>
                            last modified at Mon 17 October 2016
                        </time>
                    </header>
                    <section class="post-content">
                        <p>for one of my projects, the <a href="../social-media-wall.html">sms-twitter wall</a> setup, I configured a raspberry pi with 2 wireless network interfaces to connect through a hotspot enabled on an android device. I discovered on previous events that the wireless adapter failed on me from time to time. So I went to the internet to look if I could add a second interface and bond them together.</p>
<p>I found a lot of documentation on how to bond an active-backup strategy with a wired and a wireless interfaces but didn't found a setup with 2 wireless interfaces. After a while I figured out how it can be accomplished, even with a static ip. This static ip was necessary because the phone is receiving text messages converting them and sending them to the pi's ip address so the smswall could handle them.</p>
<p>Another side note was the wired connection, when at home I wanted to plug the ethernet cable so I could connect to my NAS for backups and to by pass the slow mobile connection for debugging purposes.</p>
<p>A lot of usable documentation I found on the archwiki obviously, like the <a href="https://wiki.archlinux.org/index.php/netctl#Bonding">netctl article</a></p>
<p>A range of tools needs to be installed on the system, which I did using <a href="https://archlinux.fr/yaourt-en">yaourt</a></p>
<div class="highlight"><pre><span></span><code>$ yaourt -S netctl wpa_supplicant ifenslave
</code></pre></div>

<p>The bonding kernel module needs to be installed and configured</p>
<p>vim /etc/modules-load.d/bonding.conf</p>
<div class="highlight"><pre><span></span><code>bonding

/etc/modprobe.d/bonding.conf
</code></pre></div>

<p>options bonding mode=active-backup miimon=100 primary=wlan0 max_bonds=0</p>
<p>the netctl wired connection profile
/etc/netcltl/wired</p>
<div class="highlight"><pre><span></span><code>Description=&#39;A basic static ethernet connection&#39;
Interface=eth0
Connection=ethernet
IP=static
Address=(&#39;192.168.0.106/24&#39;)
Routes=(&#39;default metric 1 via 192.168.0.1&#39;)
DNS=(&#39;192.168.0.1&#39;)
ExcludeAuto=no
Priority=2
</code></pre></div>

<p>the netctl profile failover needs to be configured also with a static ip</p>
<p>/etc/netctl/failover</p>
<div class="highlight"><pre><span></span><code>Description=&quot;bond interface&quot;
Interface=bond0
Connection=bond
BindsToInterfaces=(wlan0 wlan1)
IP=static
Address=(&#39;192.168.43.150/24&#39;)
Routes=(&#39;default metric 100 via 192.168.43.1&#39;)
DNS=(&#39;192.168.43.1&#39;)
</code></pre></div>

<p>notice the Router parameter instead of the Gateway, by assigning different metrics both profiles can be used together. Else the will be fighting with each other to configure the default route. And in my experience obviously the one you need (wired) will loose over and over again..</p>
<p>Enable the profiles</p>
<div class="highlight"><pre><span></span><code>$ sudo systemctl start netctl-ifplugd@eth0.service
$ sudo systemctl status netctl-ifplugd@eth0.service
$ sudo systemctl <span class="nb">enable</span> netctl-ifplugd@eth0.service
</code></pre></div>

<div class="highlight"><pre><span></span><code>$ sudo netctl <span class="nb">enable</span> failover
</code></pre></div>

<p>If you like me already had the wireless interface configured in the netctl-auto modus be sure to disable and stop that service!</p>
<div class="highlight"><pre><span></span><code>$ sudo systemctl status netctl-ifplugd@eth0.service
$ sudo systemctl stop netctl-ifplugd@eth0.service
$ sudo systemctl disable netctl-ifplugd@eth0.service
</code></pre></div>

<p>We should now configure the wireless authentication for both wireless adapters. First calculate the <a href="https://wiki.archlinux.org/index.php/WPA_supplicant#Connecting_with_wpa_passphrase">wpa_passphrase</a></p>
<div class="highlight"><pre><span></span><code>$ wpa_passphrase SSID passphrase
</code></pre></div>

<p>and copy over the output into the following configuration files</p>
<p>/etc/wpa_supplicant/wpa_supplicant-wlan0.conf</p>
<div class="highlight"><pre><span></span><code>ctrl_interface=/run/wpa_supplicant-wlan0
update_config=1

network={
    ssid=&quot;SSID&quot;
    #psk=&quot;passphrase&quot;
    psk=XX
}
</code></pre></div>

<p>/etc/wpa_supplicant/wpa_supplicant-wlan1.conf</p>
<div class="highlight"><pre><span></span><code>ctrl_interface=/run/wpa_supplicant-wlan1
update_config=1

network={
    ssid=&quot;SSID&quot;
    #psk=&quot;passphrase&quot;
    psk=XX
}
</code></pre></div>

<p>and their dependency configuration files</p>
<p>/etc/systemd/system/wpa_supplicant@wlan0.service.d/customdependency.conf</p>
<div class="highlight"><pre><span></span><code><span class="k">[Unit]</span><span class="w"></span>
<span class="na">After</span><span class="o">=</span><span class="s">netctl@failover.service</span><span class="w"></span>
</code></pre></div>

<p>/etc/systemd/system/wpa_supplicant@wlan1.service.d/customdependency.conf</p>
<div class="highlight"><pre><span></span><code><span class="k">[Unit]</span><span class="w"></span>
<span class="na">After</span><span class="o">=</span><span class="s">wpa_supplicant@wlan0.service</span><span class="w"></span>
</code></pre></div>

<p>I had to configure them in this order since they didn't came up properly if I didn't only one could achieve to authenticate instead of both. By having the wlan1 unit depend on the wlan0 I had tackled it.</p>
<p>When rebooting the device you should see them both connected using 'iwconfig' and only the bond0 and eth0 interfaces having an ip address using 'ifconfig' or 'ip -4 a'</p>
<p>to see the bond status</p>
<div class="highlight"><pre><span></span><code># cat /proc/net/bonding/bond0

Ethernet Channel Bonding Driver: v3.7.1 (April 27, 2011)

Bonding Mode: fault-tolerance (active-backup)
Primary Slave: wlan0 (primary_reselect always)
Currently Active Slave: wlan0
MII Status: up
MII Polling Interval (ms): 100
Up Delay (ms): 0
Down Delay (ms): 0

Slave Interface: wlan0
MII Status: up
Speed: Unknown
Duplex: Unknown
Link Failure Count: 0
Permanent HW addr: ##:## 
Slave queue ID: 0

Slave Interface: wlan1
MII Status: up
Speed: Unknown
Duplex: Unknown
Link Failure Count: 1
Permanent HW addr: ##:##
Slave queue ID: 0
</code></pre></div>

<p>I did some testing by unplugging interfaces, bringing them down through the cli and my system kept online. Even without the ethernet cable plugged ;)</p>
<p>So after some debugging I once again won a fight over the network!! </p>
                    </section>
                    <hr/>
                    <aside class="post-meta">
                        <p>Category: <a href="https://visibilityspots.github.io/blog/category/linux.html">linux</a></p>
                        <p>Tags: <a href="https://visibilityspots.github.io/blog/tag/wireless.html">wireless</a>, <a href="https://visibilityspots.github.io/blog/tag/bond.html">bond</a>, <a href="https://visibilityspots.github.io/blog/tag/vip.html">vip</a>, <a href="https://visibilityspots.github.io/blog/tag/wlan0.html">wlan0</a>, <a href="https://visibilityspots.github.io/blog/tag/wlan1.html">wlan1</a>, <a href="https://visibilityspots.github.io/blog/tag/static.html">static</a>, <a href="https://visibilityspots.github.io/blog/tag/ip.html">ip</a>, <a href="https://visibilityspots.github.io/blog/tag/wpa_supplicant.html">wpa_supplicant</a>, <a href="https://visibilityspots.github.io/blog/tag/netctl.html">netctl</a>, <a href="https://visibilityspots.github.io/blog/tag/failover.html">failover</a>, <a href="https://visibilityspots.github.io/blog/tag/bonding.html">bonding</a>, <a href="https://visibilityspots.github.io/blog/tag/bond0.html">bond0</a>, <a href="https://visibilityspots.github.io/blog/tag/archlinux.html">archlinux</a>, <a href="https://visibilityspots.github.io/blog/tag/raspberry.html">raspberry</a>, <a href="https://visibilityspots.github.io/blog/tag/pi.html">pi</a>, <a href="https://visibilityspots.github.io/blog/tag/arm.html">arm</a>, <a href="https://visibilityspots.github.io/blog/tag/alarm.html">alarm</a>, </p>
                    </aside>
                    <hr/>
<div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'visibilityspots';
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
                </article>
            </li>
        </ol>
    </div>
        </div>

        <script src="https://visibilityspots.github.io/blog/theme/js/main.js"></script>
    </body>
</html>